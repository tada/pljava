<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/install/selinux.md at 2025-03-23

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>PostgreSQL PL/Java &#x2013; Using PL/Java with SELinux</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2025-03-23</span>
           | <span id="projectVersion">Version: 1.6.9</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a></li>
     <li class="none"><a href="../install/upgrade.html" title="Upgrading">Upgrading</a></li>
     <li class="none"><a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>Using PL/Java with SELinux</h1>
<p>These notes were made running PostgreSQL and PL/Java on a Red Hat system,
but should be applicable&#x2014;with possible changes to details&#x2014;on other systems
running SELinux.</p>
<p>Anything that gets run by <code>postgres</code> itself runs under a special SELinux context
with type <code>postgresql_t</code> that severely limits things it can do.  This is
generally good.</p><section>
<h2><a name="File_contexts"></a>File contexts</h2>
<p>SELinux may prevent it from opening important files, such as
<code>libpljava-[version].so</code> or <code>pljava-[version].jar</code>, depending
on the SELinux contexts set on those files. The contexts can be
listed using <code>ls -Z</code>.</p>
<p>The exact SELinux rules being applied, and the file contexts they
would allow, can be different. For example, a <code>.so</code> file is considered
executable and triggers one kind of rule, while to SELinux a <code>.jar</code> file
is just an ordinary file that Java is trying to open.</p>
<p>Whether a failure is being caused by SELinux can be determined by
searching the system log for <code>avc: denied</code> messages. If that is the
problem, it can be solved in more than one way. For example:</p>
<ul>

<li>Search the system's existing SELinux policy (using <a class="externalLink" href="https://raw.githubusercontent.com/wiki/TresysTechnology/setools3/files/images/setools-3.3/apol-rule-search.png">apol</a> or
<a class="externalLink" href="https://raw.githubusercontent.com/wiki/TresysTechnology/setools3/files/images/setools-3.3/sesearch-help.png">sesearch</a>, perhaps) to find the rules that apply to what
the program is trying to do, and what target contexts <i>would be</i>
allowed, then use <a class="externalLink" href="http://www.gnu.org/software/coreutils/manual/html_node/chcon-invocation.html">chcon</a> to set one of those contexts on the
file in question. For example, on a Red Hat box, changing the
context type on <code>libpljava-[version].so</code> to <code>lib_t</code> and on
<code>pljava-[version].jar</code> to <code>usr_t</code> did the trick.</li>
<li>Write and load a new <a class="externalLink" href="http://docs.fedoraproject.org/en-US/Fedora/13/html/SELinux_FAQ/index.html#faq-entry-whatare-policy-modules">SELinux policy module</a> with rules
that allow the needed operations.</li>
</ul></section><section>
<h2><a name="Issues_requiring_policy_modules"></a>Issues requiring policy modules</h2>
<p>Something in the JVM uses the <code>sched_get{param,priority,scheduler}</code> system
calls, so a process of type <code>postgresql_t</code> has to be given the <code>getsched</code>
SELinux permission. Also, for SSL connections to work, access to the
<code>random_device</code> needs to be allowed. Both of these rules can be added in
a policy module:</p>

<div class="source">
<pre><code>policy_module(mod-pljava, 1.0)

require {
    type postgresql_t;
    type random_device_t;
}

allow postgresql_t postgresql_t : process { getsched };
allow postgresql_t random_device_t : chr_file { getattr };
</code></pre></div>
<p>If that is placed in a file <code>pljava.te</code> then</p>

<div class="source">
<pre><code>make -f /usr/share/selinux/devel/Makefile
semodule -i pljava.pp
</code></pre></div>
<p>will build and install it.</p>
<p>As another example, suppose a PL/Java function needs to make an <code>ssh</code>
connection to a remote host. In the default policy, nothing running as
<code>postgresql_t</code> is allowed to connect network sockets to remote <code>ssh</code> ports.
Again, a policy module can do the trick:</p>

<div class="source">
<pre><code>policy_module(mod-pgsql-ssh, 1.0)

require {
    type postgresql_t;
    type ssh_port_t;
}

allow postgresql_t ssh_port_t : tcp_socket { name_connect };
</code></pre></div>
<p>As it stands, this is quite broad, and would allow connections to the <code>ssh</code>
port at <i>any</i> remote address, exactly what the SELinux policy was trying
to prevent. It is reportedly possible (if fiddly) to allow only connecting
to the <code>ssh</code> port on the <i>intended</i> remote machine, using the right
<a class="externalLink" href="http://serverfault.com/questions/366922/selinux-limit-httpd-outbound-connections-by-address-and-port">melange of SELinux and iptables</a>.</p><section>
<h3><a name="avc:_denied_.7B_execstack_.7D"></a>avc: denied { execstack }</h3>
<p>At one time, log messages saying <code>avc: denied { execstack }</code> might be seen,
because Sun had released a Java distribution with a <code>libjvm.so</code> with the
<code>execstack</code> attribute missing entirely, which SELinux interprets to mean that
the library <i>might</i> need to execute code on the stack, even if it doesn't
really.</p>
<p>If seen, the problem can be confirmed by running
<code>execstack -q</code> (<a class="externalLink" href="http://man7.org/linux/man-pages/man8/execstack.8.html">manual page</a>) on the
<code>libjvm.so</code> file and seeing that it has no <code>execstack</code> attribute.</p>
<p>Recent Java distributions have properly included the attribute, set to false,
so SELinux knows the JVM will not need to execute code on the stack. Therefore,
the best resolution to the issue is to upgrade to a JDK distribution that is
not missing the attribute.</p></section></section><section>
<h2><a name="How_to_break_things"></a>How to break things</h2>
<p>One of the best ways to cause a PL/Java installation to stop working, after
being trouble-free for ages, is to replace or update one of the files it
depends on, and forget to reapply the needed SELinux context to the file.</p></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2025<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
