<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/install/upgrade.md at 2024-10-19

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>PostgreSQL PL/Java &#x2013; Upgrading</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2024-10-19</span>
           | <span id="projectVersion">Version: 1.6.8</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a></li>
     <li class="none"><strong>Upgrading</strong></li>
     <li class="none"><a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>Upgrading</h1><section>
<h2><a name="Upgrading_the_PL.2FJava_version_in_a_database"></a>Upgrading the PL/Java version in a database</h2>
<p>PL/Java performs an upgrade installation if there is already an <code>sqlj</code> schema
with tables that match a known PL/Java schema from version 1.3.0 or later. It
will convert, preserving data, to the current schema if necessary.</p>
<p><i>Remember that PL/Java runs independently
in each database session where it is in use. Older PL/Java versions active in
other sessions can be disrupted by the schema change.</i></p>
<p>A trial installation of a PL/Java update can be done in a transaction, and
rolled back if desired, leaving the schema as it was. Any concurrent sessions
with active older PL/Java versions will not be disrupted by the altered schema
as long as the transaction remains open, <i>but they may block for the duration,
so whatever testing will be done within the transaction should be done quickly
if that could be an issue</i>.</p><section>
<h3><a name="Upgrading.2C_outside_the_extension_framework"></a>Upgrading, outside the extension framework</h3>
<p>On PostgreSQL pre-9.1, or whenever PL/Java has not been installed
with <code>CREATE EXTENSION</code>, it can be updated with a <code>LOAD</code> command just
as in a fresh installation. This must be done in a fresh session (in
which nothing has caused PL/Java to load since establishing the connection).</p></section><section>
<h3><a name="Upgrading.2C_within_the_extension_framework"></a>Upgrading, within the extension framework</h3>
<p>On PostgreSQL 9.1 or later where PL/Java has been installed with
<code>CREATE EXTENSION</code>, it can be updated with
<a class="externalLink" href="http://www.postgresql.org/docs/current/static/sql-alterextension.html"><code>ALTER EXTENSION pljava UPDATE</code></a>, as long as
<code>SELECT * FROM pg_extension_update_paths('pljava')</code> shows a one-step path
from the version currently installed to the version desired.</p>
<p>As with the <code>LOAD</code> method, an <code>ALTER EXTENSION ... UPDATE</code> must be done
in a fresh session, before anything has loaded PL/Java; this also precludes
an update with a multi-step path in a single command, but the intent is to
always provide a one-step path between <i>released</i> versions.</p>
<p>If you will be following development (<code>SNAPSHOT</code>) versions, the installation
method using <code>LOAD</code> may be simpler, as updates between snapshots with the
same version string make no sense to the extension framework.</p></section></section><section>
<h2><a name="Upgrading_the_PostgreSQL_major_version_with_PL.2FJava_in_use"></a>Upgrading the PostgreSQL major version with PL/Java in use</h2><section>
<h3><a name="Binary_upgrading_with_pg_upgrade"></a>Binary upgrading with <code>pg_upgrade</code></h3>
<p>Using the <a class="externalLink" href="https://www.postgresql.org/docs/current/static/pgupgrade.html"><code>pg_upgrade</code></a> tool <a class="externalLink" href="https://www.postgresql.org/docs/9.0/static/release-9-0.html#AEN103668">contributed to PostgreSQL in 9.0</a>,
an entire PostgreSQL cluster can be upgraded to a later major version in a
more direct process than the dump to SQL and reload formerly required.
The binary upgrade is possible as long as the cluster and databases meet
certain requirements, which should be studied in the
<a class="externalLink" href="https://www.postgresql.org/docs/current/static/pgupgrade.html"><code>pg_upgrade</code> manual page</a> version for the PostgreSQL release being
upgraded <i>to</i>.</p>
<p>PL/Java adds a few additional considerations:</p>
<ul>

<li>

<p><code>pg_upgrade</code> will check in advance that every loadable module used in
the old cluster can be loaded in the new cluster, but the schema and
data will be copied over by <code>pg_upgrade</code> itself. That means that a
PL/Java build for the new PostgreSQL version must be <i>installed in
the directory structure</i> for the new cluster before running <code>pg_upgrade</code>,
but <i>not</i> installed into any databases (the new cluster should not have
had any non-system objects created yet).</p>
</li>
<li>

<p>In the steps of <a href="install.html">Installing PL/Java</a>, that means that the
self-extracting <code>java -jar ...</code> command must have been run (or the
equivalent package-installation command, if you are getting PL/Java
through a packaging system for your OS), but no <code>CREATE EXTENSION</code> or
<code>LOAD</code> command should have been run to configure it in any database.  If
using the extracting jar, to be sure of installing it to the right cluster,
add <code>-Dpgconfig=</code><i>pgconfigpath</i> at the end, where <i>pgconfigpath</i> is the
full path to the <i>new</i> cluster's <code>pg_config</code> executable.</p>
</li>
<li>

<p>PL/Java releases before 1.5.1 were not aware of <code>pg_upgrade</code> operation.
To avoid possible errors during the upgrade involving OID or object
clashes, the PL/Java release installed for the new cluster should be
1.5.1 or later.</p>
</li>
<li>

<p>When <code>pg_upgrade</code> tests that all needed modules are present, it expects
the names to match. The PL/Java module name includes the PL/Java version,
so the versions installed in the old and new clusters should be the same.
Given that 1.5.1 or later should be installed in the new cluster,
if any databases in the old cluster are using an older PL/Java version,
PL/Java should be upgraded in each (as described at the top of this page)
before running <code>pg_upgrade</code>. To be sure of installing a newer PL/Java
build into the old cluster, if using the extracting jar, add
<code>-Dpgconfig=</code><i>oldpgconfigpath</i> at the end of the <code>java -jar ...</code> command
line, with <i>oldpgconfigpath</i> the full path to the old cluster's <code>pg_config</code>
executable.</p>
</li>
</ul></section></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2024<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
