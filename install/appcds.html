<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/markdown/install/appcds.md at 2020-11-27

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>PostgreSQL PL/Java &#x2013; How to set up application class data sharing in Hotspot</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2020-11-27</span>
          &#xA0;| <span id="projectVersion">Version: 1.6.2</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a></li>
     <li class="none"><a href="../install/upgrade.html" title="Upgrading">Upgrading</a></li>
     <li class="none"><a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>How to set up application class data sharing in Hotspot</h1>
<p>For the Hotspot JVM, <a class="externalLink" href="http://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html#app_class_data_sharing">Application class data sharing</a> is a feature, first released in the Oracle JVM (8u40 and later) that extends the ordinary Java class data sharing feature to also include selected classes from the application class path. In PL/Java terms, that means that not only Java&#x2019;s own internal classes, but PL/Java&#x2019;s also, can be saved in a preprocessed shared archive and quickly mapped when any backend starts PL/Java. For an overview, see the <a href="vmoptions.html">PL/Java VM options page</a>.</p>
<p>Starting with Java 10, the feature is also available in <a class="externalLink" href="https://adoptopenjdk.net/">OpenJDK with Hotspot</a>. From Java 8 onward, a different feature with the same effect is available in <a class="externalLink" href="https://adoptopenjdk.net/">OpenJDK with OpenJ9</a>; that feature is covered <a href="oj9vmopt.html#How_to_set_up_class_sharing_in_OpenJ9">on its own page</a>.</p><section>
<h2><a name="License_considerations"></a>License considerations</h2>
<p>In Oracle Java, application class data sharing was a &#x201c;commercial feature&#x201d; first released in Java 8, not usable unless <code>pljava.vmoptions</code> also include <code>-XX:+UnlockCommercialFeatures</code> , with implications described in the &#x201c;supplemental license terms&#x201d; of the Oracle <a class="externalLink" href="http://www.oracle.com/technetwork/java/javase/terms/license/index.html">binary code license for Java SE</a>. The license seems to impose no burden on use for internal development and testing, but requires negotiating an additional agreement with Oracle if the feature will be used &#x201c;in your internal business operations or for any commercial or production purpose.&#x201d; It is available to consider for any application where the additional performance margin can be given a price.</p>
<p>The same feature in OpenJDK with Hotspot is available from Java 10 onward, and does not require any additional license or <code>-XX:+UnlockCommercialFeatures</code> option.</p>
<p>Starting in Java 11, Oracle offers <a class="externalLink" href="https://blogs.oracle.com/java-platform-group/oracle-jdk-releases-for-java-11-and-later">Oracle-branded downloads of both &#x201c;Oracle JDK&#x201d; and &#x201c;Oracle&#x2019;s OpenJDK builds&#x201d;</a> that are &#x201c;functionally identical aside from some cosmetic and packaging differences&#x201d;. &#x201c;Oracle&#x2019;s OpenJDK builds&#x201d; may be used for production or commercial purposes with no additional licensing, while any such use of &#x201c;Oracle JDK&#x201d; requires a commercial license. The application class data sharing feature is available in both, and no longer requires the <code>-XX:+UnlockCommercialFeatures</code> option in either case (not in &#x201c;Oracle&#x2019;s OpenJDK builds&#x201d; because their use is unrestricted, and not in &#x201c;Oracle JDK&#x201d; because the &#x201c;commercial feature&#x201d; is now, effectively, the entire JDK).</p>
<p>The equivalent feature in OpenJDK with OpenJ9, <a href="oj9vmopt.html#How_to_set_up_class_sharing_in_OpenJ9">described separately</a>, is available from Java 8 onward, also with no additional license or setup needed.</p></section><section>
<h2><a name="Setup_for_Hotspot.2C_earlier_than_Java_13"></a>Setup for Hotspot, earlier than Java 13</h2>
<p>The setup instructions on this page are for Hotspot, whether in Oracle Java or OpenJDK with Hotspot. The two differ only in that, wherever an <code>-XX:+UnlockCommercialFeatures</code> option is shown in the steps below, <b>it is needed in Oracle Java 8, 9, or 10, but not in OpenJDK/Hotspot, or Oracle JDK 11 or later</b>.</p>
<p>The Java version also affects the <code>-XX:+UseAppCDS</code> option shown below. For Java 8 through 10, the option must be used for application class data sharing to be enabled. In Java 11, the feature is enabled by default (though the shared archive must still be created as described here), and the <code>-XX:+UseAppCDS</code> option is no longer necessary; it will be accepted but ignored with a warning. <b>In Java 12 and later, <code>-XX:+UseAppCDS</code> is not needed and will be rejected as unrecognized, making PL/Java fail to load.</b></p>
<p>Setting up PL/Java to use application class data sharing is a three-step process. Each step is done by setting a different combination of options in <code>pljava.vmoptions</code>. A slightly different procedure, described further below, appears in Java 13. Up through Java 12, these are the three steps in overview:</p>
<ol style="list-style-type: decimal">

<li>

<p>Make a list of classes to be preloaded, by saving the names of classes that are loaded while executing some desired code in PL/Java.</p>
</li>
<li>

<p>In a new session, trigger the loading of PL/Java in a dump mode, where the JVM loads the classes from the list in step 1, and writes a shared archive.</p>
</li>
<li>

<p>Move the shared archive to a final, readable-to-postgres location, and save (with <code>ALTER DATABASE ... SET</code> or <code>ALTER SYSTEM</code>) a version of <code>pljava.vmoptions</code> with the final options to use the generated archive.</p>
</li>
</ol>
<p>Before beginning, any <a href="../use/variables.html"><code>pljava.*</code> variable settings</a> necessary should already have been made and saved, and basic PL/Java operation confirmed.</p>
<p>The steps that follow involve setting the <code>pljava.vmoptions</code> variable to contain various options. If other options have been set in <code>pljava.vmoptions</code> already, be sure to include those also when saving the final <code>pljava.vmoptions</code> setting at the end.</p><section>
<h3><a name="Generate_the_list_of_needed_classes"></a>Generate the list of needed classes</h3>
<p>Classes eligible to go in the shared archive are the Java system classes (including anything in the deprecated <code>java.ext.dirs</code> or <code>java.endorsed.dirs</code> directories), classes in the PL/Java jar itself, and any others in jars named in <code>pljava.module_path</code>. Classes from PL/Java application jars loaded into the database normally with <code>sqlj.install_jar</code> are not candidates for the shared archive. The feature will speed the startup of PL/Java itself, but application classes are still loaded from the database in PL/Java&#x2019;s usual way.</p>
<p>The generated list will contain any such classes that Java needed to load while starting up and running some sample PL/Java code. That can be anything that exercises most features of PL/Java; the supplied <a href="../examples/examples.html">examples jar</a> will do nicely. There is no great benefit to running your specific application code, as those classes won&#x2019;t end up in the archive anyway. (But see <i>Java libraries</i> below.)</p>
<p>Here, <code>/tmp/pljava.classlist</code> may be any file name you choose, in a location the PostgreSQL backend will be able to write and read. The URL for the <code>pljava-examples</code> jar is abbreviated here, standing in for its <a href="../examples/examples.html">real installed location on your system</a>. At the end of this step, use <code>\c</code> in psql to start a fresh new connection.</p>

<div class="source">
<div class="source">
<pre>% psql
=# SET pljava.vmoptions TO
-#  '-XX:+UnlockCommercialFeatures -XX:+UseAppCDS -Xshare:off '
-#  '-XX:DumpLoadedClassList=/tmp/pljava.classlist';
SET
=# SELECT sqlj.install_jar('file:/.../pljava-examples...jar', 'ex', true);
... lots of output from the examples tests ...
 install_jar 
-------------
 
(1 row)

=# SELECT sqlj.remove_jar('ex', true);
...
 remove_jar 
------------
 
(1 row)

=# \c
You are now connected to database &quot;...&quot; as ...
</pre></div></div>
</section><section>
<h3><a name="Process_the_list_of_classes_into_a_shared_archive"></a>Process the list of classes into a shared archive</h3>
<p>The last step ended with <code>\c</code> to start a new session. In this step, <code>/tmp/pljava.classlist</code> still represents the chosen file name that was just written, and <code>/tmp/pljava.jsa</code> is another chosen name where the backend will be able to write the Java shared archive.</p>

<div class="source">
<div class="source">
<pre>=# SET pljava.vmoptions TO
-#  '-XX:+UnlockCommercialFeatures -XX:+UseAppCDS -Xshare:dump '
-#  '-XX:SharedArchiveFile=/tmp/pljava.jsa '
-#  '-XX:SharedClassListFile=/tmp/pljava.classlist';
SET
=# SELECT sqlj.get_classpath('public'); -- any PL/Java function will do
INFO:  Allocated shared space: ... bytes at 0x...
INFO:  Loading classes to share ...
INFO:  Loading classes to share: done.
INFO:  Rewriting and linking classes ...
INFO:  Rewriting and linking classes: done
...
The connection to the server was lost. Attempting reset: Succeeded.
=# 
</pre></div></div>

<p>Java (and the postgres backend with it) exit when finished writing the shared archive; psql notices and starts a new connection, ready for the final step.</p></section><section>
<h3><a name="Final_pljava.vmoptions_settings_to_use_the_new_archive"></a>Final <code>pljava.vmoptions</code> settings to use the new archive</h3>
<p>The archive just written (<code>/tmp/pljava.jsa</code> as illustrated) may be moved to a more permanent place, such as a system location where postgres will be able to read it, but it is protected from modification; in this example, <code>/usr/pgsql/lib/pljava.jsa</code>.</p>
<p>Be sure the final <code>pljava.vmoptions</code> setting also includes any <i>other</i> VM options you may have chosen to set.</p>

<div class="source">
<div class="source">
<pre>=# SET pljava.vmoptions TO
-#  '-XX:+UnlockCommercialFeatures -XX:+UseAppCDS -Xshare:auto '
-#  '-XX:SharedArchiveFile=/usr/pgsql/lib/pljava.jsa';
SET
=# SELECT sqlj.get_classpath('public'); -- just checking it works
 get_classpath 
---------------
 
(1 row)

=# ALTER DATABASE ... SET pljava.vmoptions FROM CURRENT; -- save it!
</pre></div></div>

<p>Alternatively, use <code>ALTER SYSTEM</code> (or edit the <code>postgresql.conf</code> file) to save the setting for all databases in the cluster.</p>
<p>The use of <code>-Xshare:auto</code> rather than <code>-Xshare:on</code> in the final production settings may be surprising, but is recommended. On operating systems with address-space layout randomization, it is possible for some backends to (randomly) fail to map the shared archive. With <code>-Xshare:auto</code>, they will simply proceed without sharing and with higher resource usage, which may not be ideal, but the same event with <code>-Xshare:on</code> would be a hard failure.</p></section></section><section>
<h2><a name="Setup_for_Hotspot.2C_as_of_Java_13"></a>Setup for Hotspot, as of Java 13</h2>
<p>Java 13 introduces a <a class="externalLink" href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/java.html#dynamic-cds-archive">dynamic CDS archive</a> feature, with fewer steps to generate a usable archive. In essence, it combines the first two earlier steps (generate a list of loaded classes from a sample run, then generate an archive from the list) into a single step: do a sample run with the option <code>-XX:ArchiveClassesAtExit=/tmp/pljava.jsa</code> and the archive will be written to the named file when the backend exits.</p>
<p>Then, as in the earlier procedure, move the archive file to a more permanent and less writable location, and name it with <code>-XX:SharedArchiveFile=</code> in the production <code>pljava.vmoptions</code> settings. That is the only option needed to enable application class data sharing as of Java 13, as <code>-Xshare:auto</code> is the default, and the earlier <code>-XX:+UnlockCommercialFeatures</code> and <code>-XX:+UseAppCDS</code> options are obsolete.</p>
<p>The <a class="externalLink" href="https://docs.oracle.com/en/java/javase/13/docs/specs/man/java.html#dynamic-cds-archive">dynamic CDS archive documentation</a> covers the setup in useful detail.</p></section><section>
<h2><a name="Java_libraries"></a>Java libraries</h2>
<p>If your own PL/Java code depends on other Java libraries distributed as jars, the usual recommendation would be to install those as well into the database with <code>sqlj.install_jar</code>, and use <code>sqlj.set_classpath</code> to make them available. That keeps everything handled uniformly within the database.</p>
<p>On the other hand, if you are building a shared archive, and some of the dependency libraries are substantial, you could consider instead storing those jars on the file system and naming them in <code>pljava.classpath</code>. Those library classes can then also be included in the shared archive.</p>
<p>In that case, when generating the needed class list, you should run some representative sample of your own application code, not just the PL/Java examples, so that the necessary library classes will have been exercised.</p>
<p>Not everything from the original jar file can go into the shared archive. After the archive has been built, the original jars still must be on the file system and named in <code>pljava.classpath</code>.</p>
<p>When generating the needed classes list, consider adding <code>-Xverify:all</code> to the other VM options. Java sometimes applies more relaxed verification to classes it loads from the system classpath. As you will only need to do this once and they will later be loaded quickly from the shared archive, they might as well be checked thoroughly at the start.</p></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2020<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
