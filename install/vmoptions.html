<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2016-03-20 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>PostgreSQL PL/Java &#x2013; PL/Java VM option recommendations</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20160320" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean">
                                                <img src="../images/pljava_logo.jpg" alt="PL/Java logo combining the PostgreSQL elephant and a Java bean" />
                </a>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2016-03-20</span>
                  &nbsp;| <span id="projectVersion">Version: 1.5.0-BETA3</span>
                      </div>
            <div class="xright">                    <a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a>
            |
                        <a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a>
            |
                        <a href="http://lists.pgfoundry.org/pipermail/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a>
            |
                        <a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Usage</h5>
                  <ul>
                  <li class="none">
                          <a href="../build/build.html" title="Building PL/Java">Building PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a>
            </li>
                  <li class="none">
                          <a href="../use/use.html" title="User guide">User guide</a>
            </li>
                  <li class="none">
                          <a href="../develop/develop.html" title="Developer notes">Developer notes</a>
            </li>
          </ul>
                       <h5>Release Information</h5>
                  <ul>
                  <li class="none">
                          <a href="../releasenotes.html" title="Release notes">Release notes</a>
            </li>
          </ul>
                       <h5>Modules</h5>
                  <ul>
                  <li class="none">
                          <a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a>
            </li>
                  <li class="none">
                          <a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-deploy/index.html" title="PL/Java Deploy">PL/Java Deploy</a>
            </li>
                  <li class="none">
                          <a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a>
            </li>
                  <li class="none">
                          <a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a>
            </li>
                  <li class="none">
                          <a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>PL/Java VM option recommendations</h1>
<p>The PostgreSQL configuration variable <tt>pljava.vmoptions</tt> can be used to supply custom options to the Java VM when it is started. Several of these options are likely to be worth setting.</p>
<div class="section">
<h2><a name="Byte_order_for_PLJava-implemented_user-defined_types"></a>Byte order for PL/Java-implemented user-defined types</h2>
<p>PL/Java is free of byte-order issues except when using its features for building user-defined types in Java. At sites with no current or planned use of those features, this section does not require attention.</p>
<p>The 1.5.0 release of PL/Java begins a transition affecting the byte-order defaults, which will be completed in a future release. No immediate action is recommended; there is a <a href="../use/byteorder.html">byte-order page</a> for more on the topic and an advance notice of an expected future migration step.</p></div>
<div class="section">
<h2><a name="Class_data_sharing"></a>Class data sharing</h2>
<p>Class data sharing is a commonly-supported Java virtual machine feature that reduces both VM startup time and memory footprint by having many of Java&#x2019;s runtime classes preprocessed into a <tt>classes.jsa</tt> file that can be quickly memory-mapped into the process at Java startup, and shared if there are multiple processes running Java VMs. It is enabled by including</p>

<div class="source">
<div class="source">
<pre>-Xshare:on
</pre></div></div>
<p>in the <tt>pljava.vmoptions</tt> string. In rough terms in 64-bit Java 8 it can reduce the &#x2018;Metaspace&#x2019; size per PL/Java backend by slightly over 4 MB, and cut about 15 percent from the PL/Java startup time per process.</p>
<p>Sharing may be enabled automatically if the Java VM runs in <tt>client</tt> mode (described below), but usually <i>must</i> be turned on with <tt>-Xshare:on</tt> if the VM runs in <tt>server</tt> mode.</p>
<p><i>Note: the earliest documentation on class data sharing, dating to Java 1.5, suggested that the feature was not available at all in server mode. In recent VMs that is no longer the case, but it does have to be turned on.</i></p>
<p>To confirm that sharing is on, look at PL/Java&#x2019;s startup message for a line similar to:</p>

<div class="source">
<div class="source">
<pre>Java HotSpot(TM) 64-Bit Server VM (25.74-b02, mixed mode, sharing)
</pre></div></div>
<p>To see the startup message after PL/Java is already installed, use</p>

<div class="source">
<div class="source">
<pre>SET client_min_messages TO debug1;
</pre></div></div>
<p>in a new session, before executing any PL/Java function;</p>

<div class="source">
<div class="source">
<pre>SELECT sqlj.get_classpath('public');
</pre></div></div>
<p>for example.</p>
<div class="section">
<h3><a name="classes.jsa_not_present"></a><tt>classes.jsa</tt> not present</h3>
<p>If the option <tt>-Xshare:on</tt> makes PL/Java fail to start, with a message like</p>

<div class="source">
<div class="source">
<pre>An error has occurred while processing the shared archive file.
Specified shared archive not found.
</pre></div></div>
<p>then the <tt>classes.jsa</tt> file was not automatically created when Java was installed. It can be created with the simple command <tt>java -Xshare:dump</tt> (run with adequate privilege to write in Java&#x2019;s installed location).</p></div>
<div class="section">
<h3><a name="Preloading_PLJavas_classes_as_well_as_the_Java_runtimes"></a>Preloading PL/Java&#x2019;s classes as well as the Java runtime&#x2019;s</h3>
<p>The basic class data sharing feature includes only Java&#x2019;s own runtime classes in the shared archive. When using Java 8 from Oracle, 8u40 or later, an expanded feature called <a class="externalLink" href="http://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html#app_class_data_sharing">application class data sharing</a> is available, with which you can build a shared archive that preloads PL/Java&#x2019;s classes as well as Java&#x2019;s own. In rough terms this doubles the improvement in startup time seen with basic class data sharing alone, for a total improvement (compared to no sharing) of 30 to 35 percent. It also allows the memory per backend to be even further scaled back, as discussed under &#x201c;plausible settings&#x201d; below.</p>
<div class="section">
<h4><a name="Licensing_considerations"></a>Licensing considerations</h4>
<p>Basic class data sharing is widely available with no restriction, but <i>application class data sharing</i> is a &#x201c;commercial feature&#x201d; exclusive to Oracle Java 8. It will not work unless <tt>pljava.vmoptions</tt> also contain <tt>-XX:+UnlockCommercialFeatures</tt> , with implications described in the &#x201c;supplemental license terms&#x201d; of the Oracle <a class="externalLink" href="http://www.oracle.com/technetwork/java/javase/terms/license/index.html">binary code license for Java SE</a>. The license seems to impose no burden on use for internal development and testing, but requires negotiating an additional agreement with Oracle if the feature will be used &#x201c;in your internal business operations or for any commercial or production purpose.&#x201d; It is available to consider for any application where the additional performance margin can be given a price.</p>
<p>Looking ahead to Java 9, there are some promising signs that OpenJDK may have an equivalent feature.</p>
<p>Here are the <a href="appcds.html">instructions for setting up application class data sharing</a>.</p></div></div></div>
<div class="section">
<h2><a name="a-XX:DisableAttachMechanism"></a><tt>-XX:+DisableAttachMechanism</tt></h2>
<p>Management and monitoring tools like <tt>jvisualvm</tt> (included with the Oracle JDK) can show basic information about any running Java process, but can show much more detailed information by &#x2018;attaching&#x2019; to the process.</p>
<p>By default, attachment requires the tool to be run on the same host as the database server, and under the same identity. Those existing restrictions should satisfy most security requirements (after all, a local process under the postgres identity has many other ways to bypass PostgreSQL&#x2019;s assurances), but there can also be non-security-related reasons to add the <tt>-XX:+DisableAttachMechanism</tt> option:</p>

<dl>
<dt>Interaction with class data sharing</dt>
<dd>Depending on the versions of Java and <tt>jvisualvm</tt>, it is possible for <tt>jvisualvm</tt> to hang after selecting a Java process to display, if that VM has class data sharing enabled. In such cases, adding <tt>-XX:+DisableAttachMechanism</tt> to the VM options will ensure that <tt>jvisualvm</tt> can at least display the usual overview information that is available when it cannot attach.</dd>
<dt>Memory footprint</dt>
<dd>In Java 8, running the VM with <tt>-XX:+DisableAttachMechanism</tt> seems to reduce the necessary <tt>MetaspaceSize</tt> by about 3 megabytes.</dd>
</dl></div>
<div class="section">
<h2><a name="client_and_server_VM"></a><tt>client</tt> and <tt>server</tt> VM</h2>
<p>A Java VM may be able to operate in a <tt>client</tt> mode (optimized for starting small apps with minimal latency), or a <tt>server</tt> mode, tailored to large, long-running apps emphasizing throughput. Typically the <tt>server</tt> mode is selected automatically if a &#x2018;server class&#x2019; (large memory or 64-bit) platform is detected.</p>
<p>PostgreSQL will often be run on &#x2018;server class&#x2019; platforms, causing the VM to select <tt>server</tt> mode, when the usage pattern in PL/Java more closely resembles the <tt>client</tt> scenario.</p>
<p>While there is no one simple option to force <tt>client</tt> mode if the VM has selected <tt>server</tt>, it is possible to adjust individual settings to more appropriate values.</p>
<p>The heap size settings are important, because the defaults on a server-class machine will be to grab a substantial fraction of all memory. In a PL/Java application where many processes may run, it is more important to choose smaller heap sizes close to what is actually needed. The size can be set with <tt>-Xms</tt> to give a starting size, which the VM can expand if needed; this is a safe option when you have an idea what the usual case memory demand will be, but are not confident about the maximum that could sometimes be needed. A hard limit can be set with <tt>-Xmx</tt> if you know a heap size that your code should never need to exceed.</p>
<p>The [choice of garbage collector][gcchoice] can also affect the memory footprint, as the different collectors incur different memory overheads. If it performs adequately for the application, the <tt>Serial</tt> collector seems to lead the choices in space efficiency, followed by <tt>ConcMarkSweep</tt>. The <tt>G1</tt> collector, favored as <tt>ConcMarkSweep</tt>&#x2019;s replacement, uses slightly more space to work, while <tt>Parallel</tt> and <tt>ParallelOld</tt> will occupy more than double the space of any of these.</p>
<div class="section">
<h3><a name="Plausible_settings"></a>Plausible settings</h3>
<p>The optimal memory settings and garbage collector for a specific PL/Java application are best determined by testing, but it can be helpful to have an idea what is realistic. Java&#x2019;s default heap and metaspace sizes, especially on a server-class machine, tend to be far larger than necessary.</p>
<p>As a point of reference, PL/Java can load, and execute the tests in, its shipped <tt>pljava-examples</tt> jar with the following settings:</p>

<div class="source">
<div class="source">
<pre>-Xshare:on -XX:+DisableAttachMechanism -Xms2m -XX:+UseSerialGC
</pre></div></div>
<p>and end up with a heap grown to slightly under 4 MB, and a 5 MB metaspace with less than 2 MB used. (The only way to get a metaspace smaller than 5 MB is to use the <tt>-XX:MaxMetaspaceSize</tt> option, which is a hard limit, with the risk of out-of-memory errors if set too low. The test described here can be completed with the metaspace limited to 3 MB.)</p>
<p>If the Oracle <i>application class data sharing</i> feature is enabled, the metaspace limit can be set at 2 MB, and conclude the test without growing past 1 MB.</p>
<p>For an application where startup time is most critical (for example, only trivial work is being done in Java, but needed in many short-lived backend sessions), a few percent can be saved by setting the initial heap size slightly larger than the smallest that works, to avoid an initial garbage collection. In a test using PL/Java to do trivial work (nothing but <tt>SELECT sqlj.get_classpath('public')</tt>), the sweet spot comes around <tt>-Xms5m</tt> (which seems to end up allocating 6, but completes with no GC in my testing).</p></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2003&#x2013;2016
                        <a href="http://tada.se/eng/">Tada AB</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
