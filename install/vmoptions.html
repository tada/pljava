<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/markdown/install/vmoptions.md at 2023-06-13

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>PostgreSQL PL/Java &#x2013; PL/Java VM option recommendations</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2023-06-13</span>
          &#xA0;| <span id="projectVersion">Version: 1.6.5</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a></li>
     <li class="none"><a href="../install/upgrade.html" title="Upgrading">Upgrading</a></li>
     <li class="none"><a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>PL/Java VM option recommendations</h1>
<p>The PostgreSQL configuration variable <code>pljava.vmoptions</code> can be used to supply custom options to the Java VM when it is started. Several of these options are likely to be worth setting.</p>
<p>If using <a class="externalLink" href="https://www.eclipse.org/openj9/oj9_faq.html">the OpenJ9 JVM</a>, be sure to look also at the <a href="oj9vmopt.html">VM options specific to OpenJ9</a>.</p><section>
<h2><a name="Adding_to_the_set_of_readable_modules"></a>Adding to the set of readable modules</h2>
<p>By default, a small set of Java modules (including <code>java.base</code>, <code>org.postgresql.pljava</code>, and <code>java.sql</code> and its transitive dependencies, which include <code>java.xml</code>) will be readable to any Java code installed with <code>install_jar</code>.</p>
<p>While those modules may be enough for many uses, other modules are easily added using <code>--add-modules</code> within <code>pljava.vmoptions</code>. For example, <code>--add-modules=java.net.http,java.rmi</code> would make the HTTP Client and WebSocket APIs readable, along with the Remote Method Invocation API.</p>
<p>For convenience, the module <code>java.se</code> simply transitively requires all the modules that make up the full Java SE API, so <code>--add-modules=java.se</code> will make that full API available to PL/Java code without further thought. The cost, however, may be that PL/Java uses more memory and starts more slowly than if only a few needed modules were named.</p>
<p>Third-party modular code can be made available by adding the modular jars to <code>pljava.module_path</code> (see <a href="../use/variables.html">configuration variables</a>) and naming those modules in <code>--add-modules</code>. PL/Java currently treats all jars loaded with <code>install_jar</code> as unnamed-module, legacy classpath code.</p>
<p>For more, see <a href="../use/jpms.html">PL/Java and the Java Platform Module System</a>.</p></section><section>
<h2><a name="Byte_order_for_PL.2FJava-implemented_user-defined_types"></a>Byte order for PL/Java-implemented user-defined types</h2>
<p>PL/Java is free of byte-order issues except when using its features for building user-defined types in Java. At sites with no current or planned use of those features, this section does not require attention.</p>
<p>The 1.5.0 release of PL/Java begins a transition affecting the byte-order defaults, which will be completed in a future release. No immediate action is recommended; there is a <a href="../use/byteorder.html">byte-order page</a> for more on the topic and an advance notice of an expected future migration step.</p></section><section>
<h2><a name="Class_data_sharing"></a>Class data sharing</h2>
<p>Class data sharing is a commonly-supported Java virtual machine feature that reduces both VM startup time and memory footprint by having many of Java&#x2019;s runtime classes preprocessed into a file that can be quickly memory-mapped into the process at Java startup, and shared if there are multiple processes running Java VMs.</p>
<p>How to set it up differs depending on the Java VM in use, Hotspot (in <a class="externalLink" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Oracle Java</a> or <a class="externalLink" href="https://adoptopenjdk.net/">OpenJDK with Hotspot</a>), or OpenJ9 (an <a class="externalLink" href="https://www.eclipse.org/openj9/oj9_faq.html">alternate JVM</a> also available with <a class="externalLink" href="https://adoptopenjdk.net/">OpenJDK</a>). The instructions on this page are specific to Hotspot. For the corresponding feature in OpenJ9, which is worth a good look, see the <a href="oj9vmopt.html#How_to_set_up_class_sharing_in_OpenJ9">class sharing in OpenJ9</a> page.</p>
<p>For Hotspot, the class data sharing is enabled by including <code>-Xshare:on</code> or <code>-Xshare:auto</code> in the <code>pljava.vmoptions</code> string. In rough terms in 64-bit Java 8 it can reduce the &#x2018;Metaspace&#x2019; size per PL/Java backend by slightly over 4 MB, and cut about 15 percent from the PL/Java startup time per process.</p>
<p>Sharing may be enabled automatically if the Java VM runs in <code>client</code> mode (described below), but may need to be turned on with <code>-Xshare:on</code> or <code>-Xshare=auto</code> if the VM runs in <code>server</code> mode.</p>
<p>The <code>on</code> setting can be useful for quickly confirming that sharing works, as it will report a hard failure if anything is amiss. However, <code>auto</code> is recommended in production: on an operating system with address-space layout randomization, it is possible for some backends to (randomly) fail to map the share. Under the <code>auto</code> setting, they will proceed without sharing (and with higher resource usage, which may not be ideal), where with the <code>on</code> setting they would simply fail.</p>
<p><i>Note: the earliest documentation on class data sharing, dating to Java 1.5, suggested that the feature was not available at all in server mode. In recent VMs that is no longer the case, but it does have to be turned on.</i></p>
<p>To confirm that sharing is on, look at PL/Java&#x2019;s startup message for a line similar to:</p>

<div class="source">
<div class="source">
<pre>Java HotSpot(TM) 64-Bit Server VM (25.74-b02, mixed mode, sharing)
</pre></div></div>

<p>To see the startup message after PL/Java is already installed, use</p>

<div class="source">
<div class="source">
<pre>SET client_min_messages TO debug1;
</pre></div></div>

<p>in a new session, before executing any PL/Java function;</p>

<div class="source">
<div class="source">
<pre>SELECT sqlj.get_classpath('public');
</pre></div></div>

<p>for example.</p><section>
<h3><a name="classes.jsa_not_present"></a><code>classes.jsa</code> not present</h3>
<p>If the option <code>-Xshare:on</code> makes PL/Java fail to start, with a message like</p>

<div class="source">
<div class="source">
<pre>An error has occurred while processing the shared archive file.
Specified shared archive not found.
</pre></div></div>

<p>then the <code>classes.jsa</code> file was not automatically created when Java was installed. It can be created with the simple command <code>java -Xshare:dump</code> (run with adequate privilege to write in Java&#x2019;s installed location).</p></section><section>
<h3><a name="Preloading_PL.2FJava.E2.80.99s_classes_as_well_as_the_Java_runtime.E2.80.99s"></a>Preloading PL/Java&#x2019;s classes as well as the Java runtime&#x2019;s</h3>
<p>In Hotspot, the basic class data sharing feature includes only Java&#x2019;s own runtime classes in the shared archive. When using Java 8 from Oracle, 8u40 or later, or OpenJDK with Hotspot starting with Java 10, an expanded feature called <a class="externalLink" href="http://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html#app_class_data_sharing">application class data sharing</a> is available, with which you can build a shared archive that preloads PL/Java&#x2019;s classes as well as Java&#x2019;s own. In rough terms this doubles the improvement in startup time seen with basic class data sharing alone, for a total improvement (compared to no sharing) of 30 to 35 percent. It also allows the memory per backend to be even further scaled back, as discussed under &#x201c;plausible settings&#x201d; below.</p>
<p>(<a href="oj9vmopt.html#How_to_set_up_class_sharing_in_OpenJ9">In OpenJ9</a>, the basic class sharing feature since Java 8 already includes this ability, with no additional setup steps needed.)</p><section>
<h4><a name="Licensing_considerations"></a>Licensing considerations</h4>
<p>Basic class data sharing is widely available with no restriction, but <i>application class data sharing</i> <a class="externalLink" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">in Oracle Java</a> is a &#x201c;commercial feature&#x201d; that first appeared in Oracle Java 8. It will not work unless <code>pljava.vmoptions</code> also contain <code>-XX:+UnlockCommercialFeatures</code> , with implications described in the &#x201c;supplemental license terms&#x201d; of the Oracle <a class="externalLink" href="http://www.oracle.com/technetwork/java/javase/terms/license/index.html">binary code license for Java SE</a>. The license seems to impose no burden on use for internal development and testing, but requires negotiating an additional agreement with Oracle if the feature will be used &#x201c;in your internal business operations or for any commercial or production purpose.&#x201d; It is available to consider for any application where the additional performance margin can be given a price.</p>
<p><a class="externalLink" href="https://adoptopenjdk.net/">In OpenJDK (with Hotspot)</a>, starting in Java 10, the same feature is available and set up in the same way, but is freely usable; it does not require any additional license, and does not require any <code>-XX:+UnlockCommercialFeatures</code> to be added to the options.</p>
<p>Starting in Java 11, Oracle offers <a class="externalLink" href="https://blogs.oracle.com/java-platform-group/oracle-jdk-releases-for-java-11-and-later">Oracle-branded downloads of both &#x201c;Oracle JDK&#x201d; and &#x201c;Oracle&#x2019;s OpenJDK builds&#x201d;</a> that are &#x201c;functionally identical aside from some cosmetic and packaging differences&#x201d;. &#x201c;Oracle&#x2019;s OpenJDK builds&#x201d; may be used for production or commercial purposes with no additional licensing, while any such use of &#x201c;Oracle JDK&#x201d; requires a commercial license. The application class data sharing feature is available in both, and no longer requires the <code>-XX:+UnlockCommercialFeatures</code> in either case (not in &#x201c;Oracle&#x2019;s OpenJDK builds&#x201d; because their use is unrestricted, and not in &#x201c;Oracle JDK&#x201d; because the &#x201c;commercial feature&#x201d; is now, effectively, the entire JDK).</p>
<p><a class="externalLink" href="https://adoptopenjdk.net/">In OpenJDK (with OpenJ9)</a>, the class-sharing feature present from Java 8 onward will naturally share PL/Java&#x2019;s classes as well as the Java runtime&#x2019;s, with no additional setup steps.</p>
<p>Here are the instructions for <a href="appcds.html">setting up application class data sharing in Hotspot</a>.</p>
<p>Here are instructions for <a href="oj9vmopt.html#How_to_set_up_class_sharing_in_OpenJ9">setting up class sharing (including application classes!) in OpenJ9</a>.</p></section></section></section><section>
<h2><a name="a-XX:AOTLibrary.3D"></a><code>-XX:AOTLibrary=</code></h2>
<p>JDK 9 and later have included a tool, <code>jaotc</code>, that does ahead-of-time compilation of class files to native code, producing a shared-object file that can be named with the <code>-XX:AOTLibrary</code> option. Options to the <code>jaotc</code> command can specify which jars, modules, individual classes, or individual methods to compile and include. Optionally, <code>jaotc</code> can include additional metadata with the compiled code (at the cost of a slightly larger file), so that the Java runtime&#x2019;s tiered JIT compiler can still further optimize the compiled-in-advance methods that turn out to be hot spots.</p>
<p>To make a library of manageable size, a list of touched classes and methods from a sample run can be made, much as described above for application class data sharing.</p>
<p>A <a class="externalLink" href="http://web.archive.org/web/20191020025455/https://blog.gilliard.lol/2017/10/04/AppCDS-and-Clojure.html">blog post by Matthew Gilliard</a> reports successfully combining <code>jaotc</code> compilation and application class data sharing with good results, and goes into some detail on the preparation steps.</p></section><section>
<h2><a name="a-XX:.2BDisableAttachMechanism"></a><code>-XX:+DisableAttachMechanism</code></h2>
<p>Management and monitoring tools like <code>jvisualvm</code> (included with the Oracle JDK) can show basic information about any running Java process, but can show much more detailed information by &#x2018;attaching&#x2019; to the process.</p>
<p>By default, attachment requires the tool to be run on the same host as the database server, and under the same identity. Those existing restrictions should satisfy most security requirements (after all, a local process under the postgres identity has many other ways to bypass PostgreSQL&#x2019;s assurances), but there can also be non-security-related reasons to add the <code>-XX:+DisableAttachMechanism</code> option:</p>
<dl>

<dt>Interaction with class data sharing</dt>
<dd>Depending on the versions of Java and <code>jvisualvm</code>, it is possible for <code>jvisualvm</code> to hang after selecting a Java process to display, if that VM has class data sharing enabled. In such cases, adding <code>-XX:+DisableAttachMechanism</code> to the VM options will ensure that <code>jvisualvm</code> can at least display the usual overview information that is available when it cannot attach.</dd>
<dt>Memory footprint</dt>
<dd>In Java 8, running the VM with <code>-XX:+DisableAttachMechanism</code> seems to reduce the necessary <code>MetaspaceSize</code> by about 3 megabytes.</dd>
</dl></section><section>
<h2><a name="client_and_server_VM"></a><code>client</code> and <code>server</code> VM</h2>
<p>A Java VM may be able to operate in a <code>client</code> mode (optimized for starting small apps with minimal latency), or a <code>server</code> mode, tailored to large, long-running apps emphasizing throughput. Typically the <code>server</code> mode is selected automatically if a &#x2018;server class&#x2019; (large memory or 64-bit) platform is detected.</p>
<p>PostgreSQL will often be run on &#x2018;server class&#x2019; platforms, causing the VM to select <code>server</code> mode, when the usage pattern in PL/Java more closely resembles the <code>client</code> scenario.</p>
<p>While there is no one simple option to force <code>client</code> mode if the VM has selected <code>server</code>, it is possible to adjust individual settings to more appropriate values.</p>
<p>The heap size settings are important, because the defaults on a server-class machine will be to grab a substantial fraction of all memory. In a PL/Java application where many processes may run, it is more important to choose smaller heap sizes close to what is actually needed. The size can be set with <code>-Xms</code> to give a starting size, which the VM can expand if needed; this is a safe option when you have an idea what the usual case memory demand will be, but are not confident about the maximum that could sometimes be needed. A hard limit can be set with <code>-Xmx</code> if you know a heap size that your code should never need to exceed.</p>
<p>The <a class="externalLink" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/collectors.html">choice of garbage collector</a> can also affect the memory footprint, as the different collectors incur different memory overheads. If it performs adequately for the application, the <code>Serial</code> collector seems to lead the choices in space efficiency, followed by <code>ConcMarkSweep</code>. The <code>G1</code> collector, favored as <code>ConcMarkSweep</code>&#x2019;s replacement, uses slightly more space to work, while <code>Parallel</code> and <code>ParallelOld</code> will occupy more than double the space of any of these.</p><section>
<h3><a name="Plausible_settings"></a>Plausible settings</h3>
<p>The optimal memory settings and garbage collector for a specific PL/Java application are best determined by testing, but it can be helpful to have an idea what is realistic. Java&#x2019;s default heap and metaspace sizes, especially on a server-class machine, tend to be far larger than necessary.</p>
<p>As a point of reference, PL/Java can load, and execute the tests in, its shipped <code>pljava-examples</code> jar with the following settings:</p>

<div class="source">
<div class="source">
<pre>-Xshare:on -XX:+DisableAttachMechanism -Xms2m -XX:+UseSerialGC
</pre></div></div>

<p>and end up with a heap grown to slightly under 4 MB, and a 5 MB metaspace with less than 2 MB used. (The only way to get a metaspace smaller than 5 MB is to use the <code>-XX:MaxMetaspaceSize</code> option, which is a hard limit, with the risk of out-of-memory errors if set too low. The test described here can be completed with the metaspace limited to 3 MB.)</p>
<p>If the Oracle <i>application class data sharing</i> feature is enabled, the metaspace limit can be set at 2 MB, and conclude the test without growing past 1 MB.</p>
<p>For an application where startup time is most critical (for example, only trivial work is being done in Java, but needed in many short-lived backend sessions), a few percent can be saved by setting the initial heap size slightly larger than the smallest that works, to avoid an initial garbage collection. In a test using PL/Java to do trivial work (nothing but <code>SELECT sqlj.get_classpath('public')</code>), the sweet spot comes around <code>-Xms5m</code> (which seems to end up allocating 6, but completes with no GC in my testing).</p></section><section>
<h3><a name="Performance_tuning_tips_on_the_wiki"></a>Performance tuning tips on the wiki</h3>
<p>Between releases of this documentation, breaking news, tips, and metrics on PL/Java performance tuning may be shared <a class="externalLink" href="https://github.com/tada/pljava/wiki/Performance-tuning">on the performance-tuning wiki page</a>.</p></section></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2023<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
