<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2019-10-21 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>PostgreSQL PL/Java &#x2013; PL/Java VM option recommendations for the OpenJ9 JVM</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20191021" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean">
                                                <img src="../images/pljava_logo.jpg" alt="PL/Java logo combining the PostgreSQL elephant and a Java bean" />
                </a>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2019-10-21</span>
                  &nbsp;| <span id="projectVersion">Version: 1.5.4</span>
                      </div>
            <div class="xright">                    <a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a>
            |
                        <a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a>
            |
                        <a href="http://lists.pgfoundry.org/pipermail/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a>
            |
                        <a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Usage</h5>
                  <ul>
                  <li class="none">
                          <a href="../build/build.html" title="Building PL/Java">Building PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a>
            </li>
                  <li class="none">
                          <a href="../install/upgrade.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../use/use.html" title="User guide">User guide</a>
            </li>
                  <li class="none">
                          <a href="../develop/develop.html" title="Developer notes">Developer notes</a>
            </li>
          </ul>
                       <h5>Release Information</h5>
                  <ul>
                  <li class="none">
                          <a href="../releasenotes.html" title="Release notes">Release notes</a>
            </li>
          </ul>
                       <h5>Modules</h5>
                  <ul>
                  <li class="none">
                          <a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a>
            </li>
                  <li class="none">
                          <a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-deploy/index.html" title="PL/Java Deploy">PL/Java Deploy</a>
            </li>
                  <li class="none">
                          <a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a>
            </li>
                  <li class="none">
                          <a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a>
            </li>
                  <li class="none">
                          <a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>PL/Java VM option recommendations for the OpenJ9 JVM</h1>
<p>The OpenJ9 JVM accepts a number of standard options that are the same as those accepted by Hotspot, but also many nonstandardized ones that are not. A complete list of options it accepts can be found <a class="externalLink" href="https://www.ibm.com/support/knowledgecenter/SSYKE2_8.0.0/com.ibm.java.vm.80.doc/docs/x_jvm_commands.html">here</a>.</p>
<p>There is one option that should be considered for any PL/Java configuration:</p>

<ul>
  
<li><a class="externalLink" href="https://www.ibm.com/support/knowledgecenter/SSYKE2_8.0.0/com.ibm.java.vm.80.doc/docs/xquickstart.html"><tt>-Xquickstart</tt></a></li>
</ul>
<p>It can reduce the JVM startup time by doing less JIT compilation and at lower optimization levels. On the other hand, if the work to be done in PL/Java is substantial enough, the increased run time of the less-optimized code can make the overall performance effect net negative. It should be measured under expected conditions.</p>
<p>Beyond that, and the usual opportunities to adjust memory allocations and garbage-collector settings, anyone setting up PL/Java with OpenJ9 should seriously consider setting up class sharing, which is much simpler in OpenJ9 than in Hotspot, and is the subject of the rest of this page.</p>
<div class="section">
<h2><a name="How_to_set_up_class_sharing_in_OpenJ9"></a>How to set up class sharing in OpenJ9</h2>
<p>OpenJ9 is an <a class="externalLink" href="https://www.eclipse.org/openj9/oj9_faq.html">alternative to the Hotspot JVM</a> that is available in <a class="externalLink" href="https://adoptopenjdk.net/">OpenJDK</a> (which can be downloaded with the choice of either JVM).</p>
<p>OpenJ9 includes a <i>dynamically managed</i> class data sharing feature: it is able to cache ahead-of-time compiled versions of classes in a file to be sharably memory-mapped by all backends running PL/Java. The shared cache significantly reduces both the aggregate memory footprint of multiple backend JVMs and the per-JVM startup time. It is <a class="externalLink" href="https://www.ibm.com/developerworks/library/j-class-sharing-openj9/">described here</a>.</p>
<p>The OpenJ9 class-sharing feature is similar to Hotspot&#x2019;s <a href="appcds.html">application class data sharing</a>, but with a major advantage in the context of PL/Java: it is able to share not only classes of the Java runtime itself and those on <tt>pljava.classpath</tt> (PL/Java&#x2019;s own internals), but also classes from application jars loaded with <tt>sqlj.install_jar</tt>. The Hotspot counterpart can share only the first two of those categories.</p>
<p>OpenJ9 sharing is also free of the commercial-license encumbrance on the Hotspot feature in Oracle Java 8 and later (OpenJDK with Hotspot also includes the feature, without the encumbrance, but only from Java 10 on). OpenJ9 sharing is also much less fuss to set up.</p>
<p>To see how much less, the Hotspot setup is a manual, three-step affair to be done in advance of production use. You choose some code to run that you hope will exercise all the classes you would like in the shared archive and dump the loaded-class list, then generate the shared archive from that list, and finally save the right option in <tt>pljava.vmoptions</tt> to have the shared archive used at run time.</p>
<p>By contrast, you set up OpenJ9 to share classes with the following step:</p>

<ol style="list-style-type: decimal">
  
<li>Add an <tt>-Xshareclasses</tt> option to <tt>pljava.vmoptions</tt> to tell OpenJ9 to share classes.</li>
</ol>
<p>OpenJ9 will then, if the first time, create a shared archive and dynamically manage it, adding ahead-of-time-compiled versions of classes as they are used in your application.</p>
<div class="section">
<h3><a name="Setup"></a>Setup</h3>
<p>Arrange <tt>pljava.vmoptions</tt> to contain an option <tt>-Xshareclasses</tt>.</p>
<p>The option can take various suboptions. Two interesting ones are:</p>

<div class="source">
<div class="source">
<pre>-Xshareclasses:name=/path/to/some/file
-Xshareclasses:cacheDir=/path/to/some/dir
</pre></div></div>
<p>to control where PL/Java&#x2019;s shared class versions get cached. The first variant specifies the exact file that will be memory mapped, while the second specifies what directory will contain the (automatically named) file.</p>
<p>Using either suboption (or both; suboptions are separated by commas), you can arrange for PL/Java&#x2019;s shared classes to be cached separately from other uses of Java on the same system. You could even, by saving different <tt>pljava.vmoptions</tt> settings per database or per user, arrange separate class caches for distinct applications using PL/Java.</p>
<p>All of the suboptions accepted by <tt>-Xshareclasses</tt> are listed <a class="externalLink" href="https://www.ibm.com/support/knowledgecenter/SSYKE2_8.0.0/com.ibm.java.vm.80.doc/docs/xshareclasses.html">here</a>.</p>
<div class="section">
<h4><a name="Hotspot-like_loaded-once-and-frozen_class_share_or_dynamic_one"></a>Hotspot-like loaded-once-and-frozen class share, or dynamic one</h4>
<p>If you wish to emulate the Hotspot class sharing feature where a shared class archive is created ahead of time and then frozen, you can let the application run for a while with the <tt>-Xshareclasses</tt> option not containing <tt>readonly</tt>, until the shared cache has been well warmed, and then add <tt>readonly</tt> to the <tt>-Xshareclasses</tt> option as saved in <tt>pljava.vmoptions</tt>.</p>
<p>It will then be necessary (as it is with Hotspot) to expressly repeat the process when new versions of the JRE or PL/Java are installed, or (unlike Hotspot, which does not share them) application jars are updated. This is not because OpenJ9 would continue loading the wrong versions from cache, but because it would necessarily bypass the cache to load the current ones.</p>
<p>If the <tt>readonly</tt> option is not used, the OpenJ9 shared cache will dynamically cache new versions of classes as they are loaded. It does not, however, purge older versions automatically. There are <a class="externalLink" href="https://www.ibm.com/developerworks/library/j-class-sharing-openj9/#sharedclassesutilities">shared classes utilities</a> available to monitor utilization of the cache space, and to reset caches if needed.</p>
<p>With a dynamic shared cache, OpenJ9 may also continue to refine the shared data even for unchanged classes that have already been cached. It does not replace the originally cached representations, but over time can add JIT hints based on profile data collected in longer-running processes, which can help new, shorter-lived processes more quickly reach the same level of optimization as key methods are just-in-time recompiled.</p></div></div>
<div class="section">
<h3><a name="Effect_of_sqlj.replace_jar"></a>Effect of <tt>sqlj.replace_jar</tt></h3>
<p>When PL/Java replaces a jar, the class loaders and cached function mappings are reset in the backend that replaced the jar, so subsequent PL/Java function calls in that backend will use the new classes.</p>
<p>In other sessions active at the time the jar is replaced, without OpenJ9 class sharing, execution will continue with the already-loaded classes, unless/until another class needs to be loaded from the old jar, which will fail with a <tt>ClassNotFoundException</tt>.</p>
<p>With OpenJ9 class sharing, other sessions may continue executing even as they load classes, as long as the old class versions are found in the shared cache.</p></div>
<div class="section">
<h3><a name="Java_libraries"></a>Java libraries</h3>
<p>If your own PL/Java code depends on other Java libraries distributed as jars, the usual recommendation would be to install those as well into the database with <tt>sqlj.install_jar</tt>, and use <tt>sqlj.set_classpath</tt> to make them available. That keeps everything handled uniformly within the database. With OpenJ9 sharing, there is no downside to this approach, as classes installed in the database are shared, just as those on the system classpath.</p></div>
<div class="section">
<h3><a name="Thorough_class_verification"></a>Thorough class verification</h3>
<p>When using class sharing, consider adding <tt>-Xverify:all</tt> to the other VM options, perhaps once while warming a cache that you will then treat as <tt>readonly</tt>. Java sometimes applies more relaxed verification to classes it loads from the system classpath. With class sharing in use, classes may be loaded and verified early, then saved in the shared archive for quick loading later. In those circumstances, the cost of requesting verification for all classes may not be prohibitive, while increasing robustness against damaged class files.</p></div>
<div class="section">
<h3><a name="Cache_invalidation_if_database_or_PLJava_reinitialized"></a>Cache invalidation if database or PL/Java reinitialized</h3>
<p>The way that PL/Java&#x2019;s class loading currently integrates with OpenJ9 class sharing relies on a PostgreSQL <tt>SERIAL</tt> column to distinguish updated versions of classes loaded with <tt>sqlj.install_jar</tt>/<tt>replace_jar</tt>.</p>
<p>If the database is recreated, PL/Java is deinstalled and reinstalled, or anything else happens to restart the <tt>SERIAL</tt> sequence, it may be wise to destroy any existing OpenJ9 class share, to avoid incorrectly matching older cached versions of classes.</p></div>
<div class="section">
<h3><a name="Performance_tuning_tips_on_the_wiki"></a>Performance tuning tips on the wiki</h3>
<p>Between releases of this documentation, breaking news, tips, and metrics on PL/Java performance tuning may be shared <a class="externalLink" href="https://github.com/tada/pljava/wiki/Performance-tuning">on the performance-tuning wiki page</a>.</p></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2003&#x2013;2019
                        <a href="http://tada.se/eng/">Tada AB</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
