<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/markdown/install/install.md.vm at 2020-10-18

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>PostgreSQL PL/Java &#x2013; Installing PL/Java</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2020-10-18</span>
          &#xA0;| <span id="projectVersion">Version: 1.6.0</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><strong>Installing into PostgreSQL</strong></li>
     <li class="none"><a href="../install/upgrade.html" title="Upgrading">Upgrading</a></li>
     <li class="none"><a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>Installing PL/Java</h1><section>
<h2><a name="Selecting_a_current_Java_version_to_use_with_PL.2FJava"></a>Selecting a current Java version to use with PL/Java</h2>
<p>Whichever JDK version you use to build PL/Java, you may want to use PL/Java with another Java version at run time, so your PL/Java application code can use the newer Java features. When you reach the step <a href="#PLJava_configuration_variables">setting PL/Java configuration variables</a>, the <code>pljava.libjvm_location</code> variable will allow you to do that.</p></section><section>
<h2><a name="For_the_impatient"></a>For the impatient</h2>
<p>After completing the <a href="../build/build.html">build</a>:</p>

<div class="source">
<div class="source">
<pre>java -jar pljava-packaging/target/pljava-pgX.jar

   (run the above with sufficient privilege to write in the PostgreSQL
    installation directories, or read further for how to install in
    non-standard places)

psql
CREATE EXTENSION pljava;
GRANT USAGE ON LANGUAGE java TO ...; -- see &quot;Usage permission&quot; below
</pre></div></div>

<p>where <i>pgX</i> represents the PostgreSQL version, and &#x2026; wait, you&#x2019;re impatient, just look in the directory, you&#x2019;ll see the jar file there.</p>
<p><i>Upgrading an older PL/Java installation? Use <code>CREATE EXTENSION pljava FROM unpackaged;</code> after reading <b>Upgrade installations</b> below</i>.</p>
<p><i>Not running PostgreSQL 9.1 or higher? Use <code>LOAD 'libpljava-so-1.6.0';</code> instead of the <code>CREATE EXTENSION</code> command. (It works in later versions too, if you prefer it to <code>CREATE EXTENSION</code>.) Using a Mac? Be sure to add <code>.bundle</code> at the end of the file name in the <code>LOAD</code> command. Windows? Remove <code>lib</code> from the front. Something else? Keep reading.</i></p>
<p>You may get a message that some configuration variable must be set. If so, keep reading.</p><section>
<h3><a name="What_the_above_will_do"></a>What the above will do</h3>
<p>The jar file produced in <code>pljava-packaging/target</code> at the end of the build contains all the files needed to install PL/Java, and it is self-extracting when simply run with <code>java -jar</code>. It does not contain any complicated, black-box installer, and if you prefer, it is just as easy to extract normally with the <code>jar</code> command or any <code>zip</code> tool, in which case you will see that it contains files at symbolic paths such as</p>

<div class="source">
<div class="source">
<pre>pljava/pkglibdir/...
pljava/sharedir/...
</pre></div></div>

<p>which you can move to wherever you like. Those names are based on the options you would pass to <code>pg_config</code> to find the right locations for your PostgreSQL setup, and that is exactly what the self-extractor does. Assuming it is run with the permissions needed to write there, it will put the PL/Java files into the expected locations, so that <code>CREATE EXTENSION</code> will find it without much configuration needed.</p>
<p>Because that is done by the extractor, you can take the built jar file to other PostgreSQL installations, even with other filesystem layouts, and it will put the files in the right places there too.</p>
<p>It has to be able to find <code>pg_config</code>, and if you have more than one installation of PostgreSQL on the machine, it has to find the <i>right</i> <code>pg_config</code>. You can either arrange the path in your environment so the right <code>pg_config</code> comes first, or specify it with <code>-Dpgconfig=</code> on the command line:</p>

<div class="source">
<div class="source">
<pre>java -Dpgconfig=/local/pgsql/bin/pg_config -jar pljava-packaging/...
</pre></div></div>

<p>All of the standard install locations can also be changed with <code>-D</code> options:</p>

<div class="source">
<div class="source">
<pre>java -Dpgconfig.sharedir=/local/foo -jar pljava-packaging/...
</pre></div></div>

<p>would cause all the files that would normally go in the configured share directory to be placed in <code>/local/foo</code> instead. You can therefore install PL/Java in many situations where you might not have write access to the standard locations, or might have other reasons to prefer giving the files another location.</p>
<p>If you change locations, you will probably have to adjust some of PL/Java&#x2019;s configuration variables to match, before installation will succeed. For that, you will have to become patient, and read the rest of this page.</p>
<p><b>You will most probably have to set <code>pljava.libjvm_location</code>.</b> See the next section.</p>
<p><b>It is useful to consider <code>pljava.vmoptions</code>.</b> See the <a href="vmoptions.html">VM options page</a>.</p>
<p><i>One last small thing the extractor does, that won&#x2019;t automatically happen if you extract with other tools, is make sure the text files have the right line-ending style for your system. Everything will still work, and there are easy fixes if you open them in an editor and they look funny. As long as you just extract with <code>java -jar</code> the self-extractor takes care of it for you.</i></p></section></section><section>
<h2><a name="PL.2FJava_configuration_variables"></a>PL/Java configuration variables</h2>
<p>PL/Java has configuration variables for most important file locations. One that you will <i>almost always have to set</i> is <code>pljava.libjvm_location</code> because the PL/Java installer doesn&#x2019;t control where different platforms and packagers put the Java files. <i>(If it did, things would be a lot more organized, have no doubt.)</i></p>
<p>You can set these variables within a database session, before issuing the <code>LOAD</code> or <code>CREATE EXTENSION</code> command. (In case you don&#x2019;t always get things right on the first try, you might set them after, too.) For example:</p>

<div class="source">
<div class="source">
<pre>SET pljava.libjvm_location TO '/usr/lib/jvm/java-9/lib/...';
</pre></div></div>

<dl>

<dt><code>pljava.libjvm_location</code></dt>
<dd>You are looking for a file named <code>libjvm</code> (or just <code>jvm</code> on some platforms, such as Windows) with extension <code>.so</code>, <code>.dll</code>, <code>.bundle</code>, or <code>.dylib</code> typically, buried a few directories/folders down in the location where Java is installed. If more than one Java version is installed, be sure to find the library from the version you want PL/Java to use. See <a href="locatejvm.html">locating libjvm</a> for help finding it. Then set this variable to the full pathname, including the filename and extension.</dd>
<dt><code>pljava.vmoptions</code></dt>
<dd>While it should not be necessary to set these before seeing the first signs of life from PL/Java, there are useful options to consider setting here before calling the installation complete. Some are described on the <a href="vmoptions.html">VM options page</a>.</dd>
<dt><code>pljava.module_path</code></dt>
<dd>There is probably no need to set this variable unless installation locations were changed, in which case, it should be set to the final installed full pathnames of the files that are called <code>pljava/sharedir/pljava/pljava-1.6.0.jar</code> and <code>pljava/sharedir/pljava/pljava-api-1.6.0.jar</code> in the installer jar. The pathnames should be separated by the appropriate character for your platform; often a colon, or a semicolon on Windows. Note: this variable isn&#x2019;t meant to point to the code you develop and use in PL/Java&#x2014;that&#x2019;s what the <a class="externalLink" href="https://github.com/tada/pljava/wiki/SQL-functions"><code>sqlj.install_jar function</code></a> is for.</dd>
</dl>
<p>Those three are not the only PL/Java configuration variables there are, but it is unlikely you would have to change any others before installation succeeds. For the rest, there is a <a href="../use/variables.html">configuration variable reference</a> page.</p>
<p>One thing you can do with the configuration settings is quickly test that you have built a working PL/Java before installing the files in any permanent location. As long as the database server has access to the files in the build tree, you can start a session and set the variables to point to them, for a quick simple test. See <a href="locate.html">locating the built files</a> for how to find their exact names in your build tree. After testing, you would probably put the files in more permanent locations and discard the temporary variable settings.</p></section><section>
<h2><a name="Making_the_configuration_settings_persistent"></a>Making the configuration settings persistent</h2>
<p>If you have loaded PL/Java successfully after making necessary changes to some <code>pljava.*</code> variables, and the files are in the final locations where you want them, you will want your variable settings to stick. The simplest way is to reissue the same <code>SET</code> commands as <code>ALTER DATABASE</code> <i>databasename</i> <code>SET</code> <i>variablename</i> <code>FROM CURRENT</code> commands, which will preserve the current settings and make them effective when any user connects to the same database.</p>
<p>Another approach is to save them to the server&#x2019;s configuration file. If you wish PL/Java to be available for all databases in a cluster, it may be more convenient to put the settings in the file than to issue <code>ALTER DATABASE</code> for several databases, but <code>pg_ctl reload</code> will be needed to make changed settings effective. Starting with PostgreSQL 9.4, <code>ALTER SYSTEM</code> may be used as an alternative to editing the file.</p>
<p>If you have several databases in the cluster and you favor the <code>CREATE EXTENSION</code> way of installing PL/Java, setting the variables with <code>ALTER SYSTEM</code> or the cluster-wide configuration file will make sure that <code>CREATE EXTENSION</code> just works, in any database where PL/Java is wanted. Different per-database settings can still be made if one database needs them.</p>
<p>For PostgreSQL releases <a href="prepg92.html">earlier than 9.2</a>, the configuration file is the <i>only</i> way to make your settings persistent.</p></section><section>
<h2><a name="Upgrade_installations"></a>Upgrade installations</h2>
<p>PL/Java performs an upgrade installation if there is already an <code>sqlj</code> schema with tables that match a known PL/Java schema from version 1.3.0 or later. It will convert, preserving data, to the current schema if necessary.</p>
<p>A database cluster using PL/Java can be binary-upgraded using <code>pg_upgrade</code> when certain requirements are met.</p>
<p>For more on both procedures, see <a href="upgrade.html">Upgrading</a>.</p></section><section>
<h2><a name="Usage_permission"></a>Usage permission</h2>
<p>Installation of PL/Java creates two &#x201c;languages&#x201d;, <code>java</code> and <code>javau</code>. Functions that specify <code>LANGUAGE javau</code> can be created only by superusers, and are subject to very few restrictions at runtime. Functions that specify <code>LANGUAGE java</code> can be created by any user or role that has been granted <code>USAGE</code> permission <code>ON LANGUAGE java</code>. They run under a security manager that denies access to the host filesystem.</p>
<p>PostgreSQL, by default, would grant <code>USAGE</code> to <code>PUBLIC</code> on the <code>java</code> language, but PL/Java takes a more conservative approach on a new installation. In keeping with the principle of least privilege, selective access can then be granted to those users or roles that will be expected to install Java functions. Usage may be explicitly granted to <code>PUBLIC</code> if a site prefers that traditional policy.</p>
<p>In a repeat or upgrade installation (the language <code>java</code> already exists), no change will be made to the access permissions granted on it.</p></section><section>
<h2><a name="Special_topics"></a>Special topics</h2>
<p>Be sure to read these additional sections if:</p>
<ul>

<li>You are installing to <a href="prepg92.html">a PostgreSQL release earlier than 9.2</a></li>
<li>You are installing on <a href="selinux.html">a system using SELinux</a></li>
<li>You are installing on <a href="../build/macosx.html">Mac OS X</a></li>
<li>You are installing on <a href="../build/ubuntu.html">Ubuntu</a> and the self-extracting jar won&#x2019;t work</li>
</ul></section><section>
<h2><a name="Troubleshooting_the_installation"></a>Troubleshooting the installation</h2><section>
<h3><a name="Puzzling_error_message_from_CREATE_EXTENSION"></a>Puzzling error message from <code>CREATE EXTENSION</code></h3>

<div class="source">
<div class="source">
<pre>ERROR:  relation &quot;see doc: do CREATE EXTENSION PLJAVA in new session&quot;
already exists
</pre></div></div>

<p>For PL/Java, <code>CREATE EXTENSION</code> (which works in PostgreSQL 9.1 and later) is a wrapper around installation via <code>LOAD</code> (which works in all versions PL/Java supports). A quirk of this arrangement is that PostgreSQL treats <code>LOAD</code> as a no-op for the remainder of a session once the library has been loaded, so <code>CREATE EXTENSION pljava</code> works in a <i>fresh</i> session, but not in one where PL/Java&#x2019;s native code is already in place.</p>
<p>In that case, you see the above message about a strangely but meaningfully named table. The solution is simple: just retry in a new session (in <code>psql</code>, <code>\c</code> makes that easy).</p></section><section>
<h3><a name="Undefined_symbol_errors_at_LOAD_or_CREATE_EXTENSION_time"></a>Undefined symbol errors at <code>LOAD</code> or <code>CREATE EXTENSION</code> time</h3>
<p>If PL/Java loading fails with undefined-symbol errors that seem to refer to common system libraries (<code>libldap</code>, for example), see <a href="../build/runpath.html">Building PL/Java with a <code>RUNPATH</code></a>.</p></section></section><section>
<h2><a name="More_background_and_special_considerations"></a>More background and special considerations</h2>
<p>These last sections cover a little more of what happens under the hood. <code>CREATE EXTENSION</code> wraps these details up nicely, but they may still be of interest for particular needs.</p><section>
<h3><a name="Install.2C_configure.2C_check"></a>Install, configure, check</h3>
<p>Because PL/Java, by design, runs entirely in the backend process created for each connection to PostgreSQL, to configure it does not require any cluster-wide actions such as stopping or restarting the server, or editing the configuration file; any necessary settings can be made in SQL over an ordinary connection (in PostgreSQL 9.2 and later, anyway).</p>
<p><i>Caution: if you are installing a new, little-tested PL/Java build, be aware that in the unexpected case of a crash, the <code>postmaster</code> will kick other sessions out of the database for a moment to verify integrity, and then let them reconnect. If that would be disruptive, it may be best to <code>initdb</code> a new cluster in some temporary location and test PL/Java there, installing to a production server only when satisfied.</i></p>
<p>After connecting to the desired database (the connection must be as a PostgreSQL superuser), the commands for first-time PL/Java setup are:</p>

<div class="source">
<div class="source">
<pre>SET client_min_messages TO NOTICE; -- or anything finer (INFO, DEBUG, ...)
SET pljava.libjvm_location TO ' use the libjvm path here ';
SET pljava.module_path TO ' use the pljava and pljava-api jar paths here ';
LOAD ' use the PL/Java native library path here ';
</pre></div></div>

<p>(The <code>client_min_messages</code> setting is only to ensure you do not miss the <code>NOTICE</code> message in case of success.) If you see</p>

<div class="source">
<div class="source">
<pre>NOTICE: PL/Java loaded
</pre></div></div>

<p>then you are ready to test some PL/Java functions, such as the ones in the <a href="../examples/examples.html"><code>examples.jar</code> supplied in the build</a>.</p>
<p>Although typically only <code>pljava.libjvm_location</code> and <code>pljava.module_path</code> need to be right for PL/Java to function, there is a <a href="../use/variables.html">reference to PL/Java configuration variables</a> if you need it.</p></section><section>
<h3><a name="Choosing_where_to_place_the_files"></a>Choosing where to place the files</h3>
<p>Exactly where you place the files, and what pathnames you use in the above commands, can depend on your situation:</p>
<ul>

<li>Are you a superuser on the OS where PostgreSQL is installed (or are you a distribution maintainer building a PL/Java package for that platform)?</li>
<li>Are you not an OS superuser, but you have PostgreSQL superuser rights and OS permissions as the user that runs <code>postgres</code>?</li>
<li>Do you have only PostgreSQL superuser rights, no ability to write locations owned by the user <code>postgres</code> runs as, but the ability to write some locations that user can read?</li>
<li>Do you have PostgreSQL superuser rights and want to quickly test that you have built a working PL/Java?</li>
</ul>
<p>The rest of this page will cover those cases. First, the quick check.</p></section><section>
<h3><a name="A_quick_install_check"></a>A quick install check</h3>
<p>For a quick sanity test, there is no need to move the built files to more permanent locations, as long as the build tree location and permissions are such that the PostgreSQL backend can read them where they are. Use those pathnames directly in the <code>SET</code> and <code>LOAD</code> commands.</p>
<p>For the lowest-impact quick test, begin a transaction first, load PL/Java and run <a href="../examples/examples.html">any tests you like</a>, then roll the transaction back.</p></section><section>
<h3><a name="OS_superuser_or_distribution_maintainer"></a>OS superuser or distribution maintainer</h3>
<p>If you fall in this category, you can minimize configuration within PostgreSQL by placing the built files into standard locations, so <code>SET</code> commands are not needed for PostgreSQL to find them. For example, if the PL/Java native library is copied into the PostgreSQL <code>$libdir</code> (shown by <code>pg_config</code> as <code>PKGLIBDIR</code>), then the <code>LOAD</code> command can be given just the basename of the file instead of a full path. Or, if <code>dynamic_library_path</code> is already set, the file can be placed in any directory on that list for the same effect.</p>
<p>If the <code>pljava-${project.version}.jar</code> and <code>pljava-api-${project.version}.jar</code> files are placed in the default location (typically a <code>pljava</code> subdirectory of the PostgreSQL &#x201c;share&#x201d; directory), then <code>pljava.module_path</code> will not need to be set.</p>
<p>The self-extracting jar file produced by the build, assuming it is run with adequate permission, will extract the files into appropriate locations determined by querying <code>pg_config</code> on the target system. If that system may have more than one PostgreSQL installation and you wish to control which one the files get installed into, pass the full path to that installation&#x2019;s <code>pg_config</code> executable with <code>-Dpgconfig=</code> on that <code>java -jar ...</code> command line. (In more difficult cases, each category of file location, such as <code>pgconfig.sharedir</code>, can be separately overridden on the command line.)</p>
<p><b>If you are a distribution maintainer</b> packaging PL/Java for a certain platform, and you know or control that platform&#x2019;s conventions for where the Java <code>libjvm</code> should be found, please supply that full path on the <code>mvn</code> command line with <code>-Dpljava.libjvmdefault=</code> to make it the default for <code>pljava.libjvm_location</code>, so users on that platform can see a working PL/Java with no need to set that variable in the usual case. That tip and more are covered in <a href="../build/package.html">packaging PL/Java for a software distribution</a>.</p></section><section>
<h3><a name="PostgreSQL_superuser_with_access_as_user_running_postgres"></a>PostgreSQL superuser with access as user running postgres</h3>
<p>If you are not a superuser on the OS, you may not be able to place the PL/Java files in the default locations PostgreSQL was built with. If you have permissions as the user running <code>postgres</code>, you might choose locations in a directory associated with that user, such as the <code>DATADIR</code>, and set the <code>pljava.*</code> variables to point to them. Use a <code>LOAD</code> command with the full path of the native library, or set <code>dynamic_library_path</code> to include its location, and give only the basename to <code>LOAD</code>.</p>
<p>If you would rather ensure that the user running <code>postgres</code>, if compromised, could not modify these files, then the next case will be more appropriate.</p></section><section>
<h3><a name="PostgreSQL_superuser.2C_OS_user_distinct_from_the_user_running_postgres"></a>PostgreSQL superuser, OS user distinct from the user running postgres</h3>
<p>In this case, simply place the files in any location where you can make them readable by the user running <code>postgres</code>, and set the <code>pljava.*</code> variables accordingly.</p></section></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2020<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
