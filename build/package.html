<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/markdown/build/package.md at 2020-11-16

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>PostgreSQL PL/Java &#x2013; Packaging PL/Java for a software distribution</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2020-11-16</span>
          &#xA0;| <span id="projectVersion">Version: 1.6.1</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a></li>
     <li class="none"><a href="../install/upgrade.html" title="Upgrading">Upgrading</a></li>
     <li class="none"><strong>Packaging PL/Java</strong></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>Packaging PL/Java for a software distribution</h1>
<p>If you are responsible for creating or maintaining a PL/Java package for a particular software distribution, thank you. PL/Java reaches a larger community of potential users thanks to your efforts. To minimize frustration for your users and yourself, please consider these notes when building your package.</p><section>
<h2><a name="What_is_the_default_pljava.libjvm_location.3F"></a>What is the default <code>pljava.libjvm_location</code>?</h2>
<p>Users of a PL/Java source build nearly always have to set the PostgreSQL variable <code>pljava.libjvm_location</code> before the extension will work, because there is too much variation in where Java gets installed across systems for PL/Java to supply a useful default.</p>
<p>When you package for a particular platform, you may have the advantage of knowing the conventional location for Java on that platform, and you can improve the PL/Java setup experience for users of your package by adding <code>-Dpljava.libjvmdefault=...</code> on the <code>mvn</code> command line when building, where the <code>...</code> is the path to the JVM library shared object where it would be by default on your target platform. See <a href="../install/locatejvm.html">here</a> to find the exact file this should refer to.</p>
<p>When building a package, you are encouraged to set the default <code>pljava.libjvm_location</code> to the library of a JRE version that is expected to be present on your platform.</p>
<p><b>Note:</b> when building on Windows, the <code>-Dpljava.libjvmdefault</code> option is likely to produce a failed build or the wrong stored value for the library path. A fix for this option on Windows is unlikely (see <a class="externalLink" href="https://github.com/tada/pljava/issues/190">issue 190</a>); if preparing a package for Windows, it will be simplest to use a patch that changes the definition of <code>PLJAVA_LIBJVMDEFAULT</code> in <code>pljava-so/src/main/c/Backend.c</code>.</p></section><section>
<h2><a name="What_kind_of_a_package_is_this.3F"></a>What kind of a package is this?</h2>
<p>Your package may be for a distribution that has formal guidelines for how to package software in certain categories, such as &#x201c;Java applications&#x201d;, &#x201c;Java libraries&#x201d;, or &#x201c;PostgreSQL extensions&#x201d;. That may force a judgment as to which of those categories PL/Java falls in.</p><section>
<h3><a name="If_possible:_it.E2.80.99s_a_PostgreSQL_extension"></a>If possible: it&#x2019;s a PostgreSQL extension</h3>
<p>PL/Java has the most in common with other PostgreSQL extensions (even though it happens to involve Java). It has nearly nothing in common with &#x201c;Java applications&#x201d; or &#x201c;Java libraries&#x201d; as those are commonly understood. It is neither something that can run on its own as an application, nor a library that would be placed on the classpath in the usual fashion for other Java code to use. It is only usable within PostgreSQL under its own distinctive rules.</p></section><section>
<h3><a name="Not_recommended:_Java_application_or_library_guidelines"></a>Not recommended: Java application or library guidelines</h3>
<p>Formal guidelines developed for packaging Java applications or libraries are likely to impose requirements that have no value or are inappropriate in PL/Java&#x2019;s case. The necessary locations for PL/Java&#x2019;s components are determined by the rules of the PostgreSQL extension mechanism, not other platform rules that may apply to conventional Java libraries, for example.</p>
<p>A packaging system&#x2019;s built-in treatment for Java libraries may even actively break PL/Java. One packaging system apparently unpacks and repacks jar files in a way that adds spurious entries. It has that &#x201c;feature&#x201d; to address an obscure issue involving <a class="externalLink" href="https://www.redhat.com/archives/fedora-devel-java-list/2008-September/msg00040.html">multilib conflicts for packages that use GCJ</a>, which doesn&#x2019;t apply to PL/Java at all, and when the repacking silently added spurious entries to PL/Java&#x2019;s self-installer jar, it took time to track down why unexpected things were getting installed.</p>
<p>If you are using that packaging system, please be sure to follow the step shown in that link to disable the repacking of jars.</p></section><section>
<h3><a name="An_exception:_pljava-api"></a>An exception: <code>pljava-api</code></h3>
<p>The one part of PL/Java that could, if desired, be handled in the manner of Java libraries is <code>pljava-api</code>. This single jar file is needed on the classpath when compiling Java code that will be loaded into PL/Java in the database. It is <i>not</i> needed at the time that code will <i>run</i>. That means it could be appropriate to treat <code>pljava-api</code> as a separate <code>-devel</code> package, if your packaging guidelines encourage such a distinction. In that case, you would exclude the <code>pljava-api</code> jar file from the main package, and produce a <code>-devel</code> package that provides it.</p>
<p>A <code>-devel</code> package providing <code>pljava-api</code> might appropriately follow java library packaging guidelines to ensure it appears on a developer&#x2019;s classpath when compiling code to run in PL/Java. Ideally, such a package would also place the <code>pljava-api</code> artifact into the local Maven repository, if any. (PL/Java&#x2019;s <a href="../use/hello.html">hello world example</a> illustrates using Maven to build code for use in PL/Java, which assumes the local Maven repo contains <code>pljava-api</code>.)</p>
<p>To build <code>pljava-api</code> in isolation. simply run <code>mvn --projects pljava-api clean install</code>. It builds quickly and independently of the rest of the project, with fewer build dependencies than the project as a whole.</p>
<p>That <code>mvn clean install</code> also puts the <code>pljava-api</code> artifact into the local Maven repository on the build host. A <code>-devel</code> package will ideally put the same artifact into the local Maven repository of the installation target. (While the other subprojects in a PL/Java full build also create artifacts in the build host&#x2019;s local Maven repository, they can be ignored; <code>pljava-api</code> is the useful one to have in an installation target host&#x2019;s repository.)</p></section><section>
<h3><a name="PL.2FJava_API_javadocs"></a>PL/Java API javadocs</h3>
<p>The PL/Java build does not automatically build javadocs. Those that go with <code>pljava-api</code> can be easily generated by running <code>mvn --projects pljava-api javadoc:javadoc</code> to build them, then collecting the <code>apidocs</code> subtree from <code>target/site</code>. They can be included in the same package as <code>pljava-api</code> or in a separate javadoc package, as your guidelines may require.</p></section><section>
<h3><a name="An_examples_package.3F"></a>An <code>examples</code> package?</h3>
<p>A full PL/Java build also builds <code>pljava-examples</code>, which typically will also be installed into PostgreSQL&#x2019;s <i>SHAREDIR</i><code>/pljava</code> directory. If the packaging guidelines encourage placing examples into a separate package, this jar file can be excluded from the main package and delivered in a separate one. The examples can be built in isolation by running <code>mvn --projects pljava-examples clean package</code>, as long as the <code>pljava-api</code> has been built first and installed into the build host&#x2019;s local Maven repository.</p>
<p>Note that many of the examples do double duty as tests, as described in <i>confirming the build</i> below.</p>
<p>When building for (and with) Java 8 or later and PostgreSQL 8.4 or later, the XML examples based on the Saxon library should also be built, by adding <code>-Psaxon-examples</code> to the <code>mvn</code> command line.</p></section></section><section>
<h2><a name="Scripting_the_build"></a>Scripting the build</h2>
<p>Options on the <code>mvn</code> command line may be useful in the scripted build for the package.</p>
<dl>

<dt><code>-Dpljava.libjvmdefault=</code><i>path/to/jvm-shared-object</i></dt>
<dd>As suggested earlier, please use this option to build a useful default into PL/Java for the <code>pljava.libjvm_location</code> PostgreSQL variable, users of your package will not need to set that variable before <code>CREATE EXTENSION pljava</code> works.</dd>
<dt><code>-Dpgsql.pgconfig=</code><i>path/to/pg_config</i></dt>
<dd>If the build host may have more than one PostgreSQL version installed, a package specific to one version can be built by using this option to point to the <code>pg_config</code> command in the <code>bin</code> directory of the needed PostgreSQL version. (The same effect was always possible by making sure that <code>bin</code> directory was at the front of the <code>PATH</code> when invoking <code>mvn</code>, but this option on the <code>mvn</code> command makes it more explicit.)</dd>
</dl></section><section>
<h2><a name="Patching_PL.2FJava"></a>Patching PL/Java</h2>
<p>If your packaging project requires patches to PL/Java, and not simply the passing of options at build or packaging time as described on this page, please <a class="externalLink" href="https://github.com/tada/pljava/issues">open an issue</a> so that the possibility of addressing your need without patching can be discussed.</p></section><section>
<h2><a name="Confirming_the_build"></a>Confirming the build</h2>
<p>A full build also produces a <code>pljava-examples</code> jar, containing many examples that double as tests. Many of these are run from the deployment descriptor if the PL/Java extension is created in a PostgreSQL instance and then the examples jar is loaded with <code>install_jar</code> passing <code>deploy =&gt; true</code>, which should complete with no warnings.</p>
<p>Some tests involving Unicode are skipped if the <code>server_encoding</code> is not <code>utf-8</code>, so it is best to run them in a server instance created with that encoding.</p></section><section>
<h2><a name="Packaging_the_built_items"></a>Packaging the built items</h2>
<p>The end product of a full PL/Java source build is a jar file that functions as a self-extracting installer when run by <code>java -jar</code>. It contains the files that are necessary on a target system to use PL/Java with PostgreSQL, including those needed to support <code>ALTER EXTENSION UPGRADE</code>.</p>
<p>It also contains the <code>pljava-api</code> jar, needed for developing Java code to use in a database with PL/Java, and the <code>pljava-examples</code> jar. As discussed above, these may be omitted from a base package and supplied separately, if packaging guidelines require.</p>
<p>The self-extracting jar consults <code>pg_config</code> at the time of extraction to determine where the files should be installed.</p>
<p>Given this jar as the result of the build, there are three broad approaches to constructing a package:</p>
<table border="0" class="bodyTable">
<thead>

<tr class="a">
<th> Approach </th>
<th> Pro </th>
<th> Con </th></tr>
</thead><tbody>

<tr class="b">
<td>Capture self-extracting jar in package, deliver to target system and run it as a post-install action </td>
<td> Simple, closest to a vanilla PL/Java build. </td>
<td> May not integrate well into package manager for querying, uninstalling, or verifying installed files; probably leaves the self-installing jar on the target system, where it serves no further purpose. </td></tr>
<tr class="a">
<td>Run self-extracting jar at packaging time, and package the files it installs </td>
<td> Still simple, captures the knowledge embedded in the installer jar; integrates better with package managers needing the list of files installed. </td>
<td> Slightly less space-efficient? </td></tr>
<tr class="b">
<td>Ignore the self-extracting jar and hardcode a list of the individual files resulting from the build to be captured in the package </td>
<td> ? </td>
<td> Brittle, must reverse-engineer what pljava-packaging and installer jar are doing, from release to release. Possible to miss things. </td></tr>
</tbody>
</table>
<p>The sweet spot seems to be the middle approach.</p>
<p>When running the self-extractor, its output can be captured for a list of the files installed. (As always, parsing that output can get complicated if the pathnames have newlines or other tricky characters. The names of PL/Java-related files in the jar do not, so there is no problem as long as no tricky characters are in the PostgreSQL installation directory names reported by <code>pg_config</code>.)</p>
<p>A package specific to a PostgreSQL version can pass <code>-Dpgconfig=</code><i>path/to/pg_config</i> to Java when running the self-extractor, to ensure the locations are obtained from the desired version&#x2019;s <code>pg_config</code>. (This is the extraction-time analog of the <code>-Dpgsql.pgconfig</code> that can be passed to <code>mvn</code> at build time.)</p>
<p>If necessary to satisfy some packaging guideline, individual locations obtained from <code>pg_config</code> can be overridden with more specific options such as <code>-Dpgconfig.sharedir=...</code> as described in the <a href="../install/install.html">install</a> guide. Or, the packaging script might simply move files, or edit the paths they will have on the target system.</p>
<p>In addition to the files named in the self-extractor&#x2019;s output, additional files could be included in the package (if guidelines require the README or COPYRIGHT, for example). As discussed above, the <code>pljava-api</code> jar could be filtered from the list if it will be delivered in a separate <code>-devel</code> package, and the same could be done for <code>pljava-examples</code>.</p></section><section>
<h2><a name="Late-breaking_packaging_news_and_tips"></a>Late-breaking packaging news and tips</h2>
<p>A <a class="externalLink" href="https://github.com/tada/pljava/wiki/Packaging-tips">Packaging Tips</a> page on the PL/Java wiki will be created for information on packaging issues that may be reported and resolved between released updates to this documentation. Please be sure to check there for any packaging issue not covered here.</p></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2020<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
