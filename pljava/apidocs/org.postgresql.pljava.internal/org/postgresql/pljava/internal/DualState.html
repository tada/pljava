<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (21) on Sun Mar 23 16:07:28 EDT 2025 -->
<title>DualState (PL/Java backend Java code 1.6.9)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="dc.created" content="2025-03-23">
<meta name="description" content="declaration: module: org.postgresql.pljava.internal, package: org.postgresql.pljava.internal, class: DualState">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../script-dir/jquery-ui.min.css" title="Style">
<script type="text/javascript" src="../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top"><button id="navbar-toggle-button" aria-controls="navbar-top" aria-expanded="false" aria-label="Toggle navigation links"><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span></button>
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../module-summary.html">Module</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/DualState.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html#class">Help</a></li>
</ul>
<ul class="sub-nav-list-small">
<li>
<p>Summary:</p>
<ul>
<li><a href="#nested-class-summary">Nested</a></li>
<li><a href="#field-summary">Field</a></li>
<li><a href="#constructor-summary">Constr</a></li>
<li><a href="#method-summary">Method</a></li>
</ul>
</li>
<li>
<p>Detail:</p>
<ul>
<li><a href="#field-detail">Field</a></li>
<li><a href="#constructor-detail">Constr</a></li>
<li><a href="#method-detail">Method</a></li>
</ul>
</li>
</ul>
</div>
<div class="sub-nav">
<div id="navbar-sub-list">
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li><a href="#nested-class-summary">Nested</a>&nbsp;|&nbsp;</li>
<li><a href="#field-summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor-summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-summary">Method</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li><a href="#field-detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor-detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-detail">Method</a></li>
</ul>
</div>
<div class="nav-list-search"><a href="../../../../../search.html">SEARCH</a>
<input type="text" id="search-input" disabled placeholder="Search">
<input type="reset" id="reset-button" disabled value="reset">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="module-label-in-type">Module</span>&nbsp;<a href="../../../../module-summary.html">org.postgresql.pljava.internal</a></div>
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">org.postgresql.pljava.internal</a></div>
<h1 title="Class DualState" class="title">Class DualState&lt;T&gt;</h1>
</div>
<div class="inheritance" title="Inheritance Tree"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">java.lang.Object</a>
<div class="inheritance"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html" title="class or interface in java.lang.ref" class="external-link">java.lang.ref.Reference</a>&lt;T&gt;
<div class="inheritance"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/WeakReference.html" title="class or interface in java.lang.ref" class="external-link">java.lang.ref.WeakReference</a>&lt;T&gt;
<div class="inheritance">org.postgresql.pljava.internal.DualState&lt;T&gt;</div>
</div>
</div>
</div>
<section class="class-description" id="class-description">
<dl class="notes">
<dt>Direct Known Subclasses:</dt>
<dd><code><a href="DualState.SingleGuardedLong.html" title="class in org.postgresql.pljava.internal">DualState.SingleGuardedLong</a></code></dd>
</dl>
<hr>
<div class="type-signature"><span class="modifiers">public abstract class </span><span class="element-name type-name-label">DualState&lt;T&gt;</span>
<span class="extends-implements">extends <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/WeakReference.html" title="class or interface in java.lang.ref" class="external-link">WeakReference</a>&lt;T&gt;</span></div>
<div class="block">Base class for object state with corresponding Java and native components.
<p>
 A <code>DualState</code> object connects some state that exists in the JVM
 as well as some native/PostgreSQL resources. It will 'belong' to some Java
 object that holds a strong reference to it, and this state object is,
 in turn, a <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/WeakReference.html" title="class or interface in java.lang.ref" class="external-link"><code>WeakReference</code></a> to that object. Java state may be held in
 that object (if it needs only to be freed by the garbage collector when
 unreachable), or in this object if it needs some more specific cleanup.
 Native state will be referred to by this object.
<p>
 These interesting events are possible in the life cycle of a
 <code>DualState</code> object:
 <ul>
 <li>It is explicitly closed by the Java code using it. It, and any associated
 native state, should be released.</li>
 <li>It is found unreachable by the Java garbage collector. Again, any
 associated state should be released.</li>
 <li>Its associated native state is released or invalidated (such as by exit
 of a corresponding context). If the object is still reachable from Java, it
 must throw an exception for any future attempted access to its
 native state.</li>
 </ul>
<p>
 A subclass overrides the <a href="#javaStateReleased(boolean)"><code>javaStateReleased</code></a>,
 <a href="#javaStateUnreachable(boolean)"><code>javaStateUnreachable</code></a>, or
 <a href="#nativeStateReleased(boolean)"><code>nativeStateReleased</code></a> methods, respectively,
 to add behavior for those life cycle events.
<p>
 A subclass calls <a href="#releaseFromJava()"><code>releaseFromJava</code></a> to signal an event
 of the first kind. Events of the second kind are, naturally, detected by the
 Java garbage collector. To detect events of the third kind, a resource owner
 must be associated with the instance.
<p>
 A parameter to the <code>DualState</code> constructor is a <code>ResourceOwner</code>,
 a PostgreSQL implementation concept introduced in PG 8.0. A
 <code>nativeStateReleased</code> event occurs when the corresponding
 <code>ResourceOwner</code> is released in PostgreSQL.
<p>
 However, this class does not require the <code>resourceOwner</code> parameter to
 be, in all cases, a pointer to a PostgreSQL <code>ResourceOwner</code>. It is
 treated simply as an opaque <code>long</code> value, to be compared to a value
 passed at release time (as if in a <code>ResourceOwner</code> callback). Other
 values (such as pointers to other allocated structures, which of course
 cannot match any PG <code>ResourceOwner</code> existing at the same time) can also
 be used. In PostgreSQL 9.5 and later, a <code>MemoryContext</code> could be used,
 with its address passed to a <code>MemoryContextCallback</code> for release. For
 state that is scoped to a single invocation of a PL/Java function, the
 address of the <code>Invocation</code> can be used. Such references can be
 considered "generalized" resource owners.
<p>
 Java code may execute in multiple threads, but PostgreSQL is not
 multi-threaded; at any given time, there is no more than one thread that may
 safely make JNI calls into PostgreSQL routines (for that thread,
 <code>Backend.threadMayEnterPG()</code> returns true). Depending on the setting of
 the <code>pljava.java_thread_pg_entry</code> PostgreSQL configuration variable,
 that may be the same one thread for the duration of a session, or it may be
 possible for one thread to relinquish that status and another thread to take
 it: for the <code>pljava.java_thread_pg_entry</code> setting <code>allow</code>, the
 status is represented by holding the object monitor on
 <code>Backend.THREADLOCK</code>, and <code>Backend.threadMayEnterPG()</code> returns
 true for whatever thread holds it. Under that setting, there can be moments
 when <code>Backend.threadMayEnterPG()</code> is not true for any thread, if one
 has released the monitor and no other thread has yet acquired it. For brevity
 in what follows, "the PG thread" will be used to mean whatever thread, at a
 given moment, would observe <code>Backend.threadMayEnterPG()</code> to return
 true.
<p>
 Some methods of <code>DualState</code> and subclasses may be called from any Java
 thread, while some must be called from the PG thread. The life-cycle
 callbacks, <code>javaStateReleased</code>, <code>javaStateUnreachable</code>, and
 <code>nativeStateReleased</code>, are called by the implementation, and always
 on the PG thread.
<p>
 The Java Memory Model imposes strict conditions for updates to memory state
 made in one thread to be visible to other threads. Methods that are known to
 be called only on the PG thread can sidestep those complexities, at least
 to the extent that they manipulate only data structures not accessed in other
 threads. This is true even under the <code>pljava.java_thread_pg_entry</code>
 setting <code>allow</code>, where "the PG thread" may not always be the same
 thread. Because a Java synchronization event is involved whenever
 "the PG thread" changes, unbroken visibility is assured, just as it would be
 in one unchanging thread, so one can say "the PG thread" for convenience and
 without loss of generality.
<p>
 For the <code>nativeStateReleased</code> lifecycle event, rules for memory
 visibility are not enough; a mechanism for mutual exclusion is needed. The
 callback is made on the PG thread from PostgreSQL code that is in the process
 of invalidating the native state, and will do so once the callback returns.
 If any other Java thread is actively referring to that native state, there is
 no choice but to block the PG thread making the callback until such other
 threads are no longer relying on the native state.
<p>
 To that end, the <a href="#pin()"><code>pin</code></a> and <a href="#unpin()"><code>unpin</code></a> methods are
 provided, and must be used to surround any block of code that accesses the
 native state:
<pre>
pin();
try
{
    ... code that dereferences or relies on
    a valid native state ...
}
finally
{
    unpin();
}
</pre>
<p>
 Pins are lightweight, nonexclusive (any number of threads may simultaneously
 pin the same <code>DualState</code> instance), and reentrant (a single thread may
 obtain and release nested pins on the same instance). The code protected by a
 pin is ideally a short sequence representing a simple operation (reading a
 value, or refilling a small buffer with data) on the native state. The chief
 purpose of holding a pin is to hold off the possible invalidation of the
 native state until the pin is released.
<p>
 If either the native state or the Java state has been released already (by
 the resource owner callback or an explicit call to <code>releaseFromJava</code>,
 respectively), <code>pin()</code> will detect that and throw the appropriate
 exception. Otherwise, the state is safe to make use of until <code>unpin</code>.
 A subclass can customize the messages or <code>SQLSTATE</code> codes for the
 exceptions <code>pin()</code> may throw, by overriding one or more of
 <a href="#identifierForMessage()"><code>identifierForMessage</code></a>,
 <a href="#invalidMessage()"><code>invalidMessage</code></a>,
 <a href="#releasedMessage()"><code>releasedMessage</code></a>,
 <a href="#invalidSqlState()"><code>invalidSqlState</code></a>, or
 <a href="#releasedSqlState()"><code>releasedSqlState</code></a>.
<p>
 Code that holds a pin may safely act on components of the native state from
 any thread, so long as the actions do not include native calls to PostgreSQL
 routines (directly or transitively). Access to the native memory through a
 direct byte buffer would be a permitted example, or even calls to JNI methods
 to retrieve fields from C <code>struct</code>s or chase pointers through a data
 structure, as long as only thread-safe routines from the C runtime are called
 and no routines of PostgreSQL itself, and as long as the memory or structure
 being accessed is known to be safe from modification by PostgreSQL while the
 pin is held. In the future, PL/Java may one day have an annotation that can
 be used to mark native methods that satisfy these limits; at present, there
 has been no effort to segregate them into those that do and those that don't.
 Native methods that may (under any circumstances!) invoke PG routines must
 be invoked on the PG thread.
<p>
 The exclusive counterparts to <code>pin</code> and <code>unpin</code> are
 <a href="#lock(boolean)"><code>lock</code></a> and <a href="#unlock(int,boolean)"><code>unlock</code></a>, which are not
 expected to be used as widely. The chief use of <code>lock</code>/<code>unlock</code>
 is around the call to <code>nativeStateReleased</code> when handling a resource
 owner callback from PostgreSQL. They can be used in subclasses to surround
 modifications to the state, as needed. A <code>lock</code> will block until all
 earlier-acquired pins are released; subsequent pins block until the lock is
 released. Only the PG thread may use <code>lock</code>/<code>unlock</code>. An
 <code>upgrade</code> argument to <code>lock</code> allows the lock to be acquired
 when the PG thread already holds a pin; it should be specified
 only when inspection of the code identifies a nearby enclosing pin and
 confirms that the planned locked actions will not break the pinning code's
 assumptions. Pins can be freely acquired by the PG thread while it holds a
 lock; the coding convention's strict nesting assures they will all be
 released before the lock is.
<p>
 In an explicit call to <code>releaseFromJava</code>, which may be made from any
 thread, the instance is immediately, atomically, flagged as released. No
 subsequent pin will succeed. Pins already held are unaffected, so there must
 be no changes made to the state, at the time <code>releaseFromJava</code> is
 called, that could confuse any code that already holds a pin and is relying
 on the state. Such changes must be made in the <code>javaStateReleased</code>
 callback, which will execute only after release of the last pin, if any, and
 always on the PG thread. If the last pin is released by a thread other than
 the PG thread, the callback does not execute immediately, but via a queue
 that is polled from the PG thread at convenient points.
<p>
 Instances whose referents are found unreachable by Java's garbage collector
 are placed on the same queue, so their <code>javaStateUnreachable</code> callbacks
 will be executed on the PG thread when the queue is polled. The callbacks
 should clean up any lingering native state.
<p>
 As the callbacks are executed on the PG thread, any native calls they may
 need to make into PostgreSQL are allowed without extra ceremony.
<p>
 There are different abstract subclasses of <code>DualState</code> that wrap
 different sorts of PostgreSQL native state, and encapsulate what needs to be
 done when such state is released from the Java or native side. More such
 subclasses can be added as needed.
<p>
 A client class of <code>DualState</code> will typically contain a static nested
 class that further extends one of these abstract subclasses, and the client
 instance will hold a strong reference to an instance of that
 <code>DualState</code> subclass constructed at the same time.
<p>
 <strong>This class uses some private data structures, to track
 created instances through their life cycles, that are not synchronized or
 thread-safe.</strong> The design rests on the following requirements:
 <ul>
 <li>The structures are only traversed or modified during:
  <ul>
  <li>Instance construction
  <li>Reference queue processing (instances found unreachable by Java's
  garbage collector, or enqueued following <code>releaseFromJava</code>)
  <li>Exit of a resource owner's scope
  </ul>
 <li>There is only one PG thread, or only one at a time.
 <li>Construction of any <code>DualState</code> instance is to take place only on
 the PG thread. The requirement to pass any
 constructor a <code>DualState.Key</code> instance, obtainable by native code, is
 intended to reinforce that convention. It is not abuse-proof, or intended as
 a security mechanism, but only a guard against programming mistakes.
 <li>Reference queue processing takes place only at chosen points where a
 thread enters or exits native code, on the PG thread.
 <li>Resource-owner callbacks originate in native code, on the PG thread.
 </ul></div>
</section>
<section class="summary">
<ul class="summary-list">
<!-- ======== NESTED CLASS SUMMARY ======== -->
<li>
<section class="nested-class-summary" id="nested-class-summary">
<h2>Nested Class Summary</h2>
<div class="caption"><span>Nested Classes</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Class</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>static final class&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="DualState.Key.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.Key</a></code></div>
<div class="col-last even-row-color">
<div class="block">Magic cookie needed as a constructor parameter to confirm that
 <code>DualState</code> subclass instances are being constructed from
 native code.</div>
</div>
<div class="col-first odd-row-color"><code>static class&nbsp;</code></div>
<div class="col-second odd-row-color"><code><a href="DualState.SingleFreeErrorData.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.SingleFreeErrorData</a>&lt;<a href="DualState.SingleFreeErrorData.html" title="type parameter in DualState.SingleFreeErrorData">T</a>&gt;</code></div>
<div class="col-last odd-row-color">
<div class="block">A <code>DualState</code> subclass whose only native resource releasing action
 needed is <code>FreeErrorData</code> of a single pointer.</div>
</div>
<div class="col-first even-row-color"><code>static class&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="DualState.SingleFreeTupleDesc.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.SingleFreeTupleDesc</a>&lt;<a href="DualState.SingleFreeTupleDesc.html" title="type parameter in DualState.SingleFreeTupleDesc">T</a>&gt;</code></div>
<div class="col-last even-row-color">
<div class="block">A <code>DualState</code> subclass whose only native resource releasing action
 needed is <code>FreeTupleDesc</code> of a single pointer.</div>
</div>
<div class="col-first odd-row-color"><code>static class&nbsp;</code></div>
<div class="col-second odd-row-color"><code><a href="DualState.SingleGuardedLong.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.SingleGuardedLong</a>&lt;<a href="DualState.SingleGuardedLong.html" title="type parameter in DualState.SingleGuardedLong">T</a>&gt;</code></div>
<div class="col-last odd-row-color">
<div class="block">A <code>DualState</code> subclass serving only to guard access to a single
 nonzero <code>long</code> value (typically a native pointer).</div>
</div>
<div class="col-first even-row-color"><code>static class&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="DualState.SingleHeapFreeTuple.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.SingleHeapFreeTuple</a>&lt;<a href="DualState.SingleHeapFreeTuple.html" title="type parameter in DualState.SingleHeapFreeTuple">T</a>&gt;</code></div>
<div class="col-last even-row-color">
<div class="block">A <code>DualState</code> subclass whose only native resource releasing action
 needed is <code>heap_freetuple</code> of a single pointer.</div>
</div>
<div class="col-first odd-row-color"><code>static class&nbsp;</code></div>
<div class="col-second odd-row-color"><code><a href="DualState.SingleMemContextDelete.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.SingleMemContextDelete</a>&lt;<a href="DualState.SingleMemContextDelete.html" title="type parameter in DualState.SingleMemContextDelete">T</a>&gt;</code></div>
<div class="col-last odd-row-color">
<div class="block">A <code>DualState</code> subclass whose only native resource releasing action
 needed is <code>MemoryContextDelete</code> of a single context.</div>
</div>
<div class="col-first even-row-color"><code>static class&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="DualState.SinglePfree.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.SinglePfree</a>&lt;<a href="DualState.SinglePfree.html" title="type parameter in DualState.SinglePfree">T</a>&gt;</code></div>
<div class="col-last even-row-color">
<div class="block">A <code>DualState</code> subclass whose only native resource releasing action
 needed is <code>pfree</code> of a single pointer.</div>
</div>
<div class="col-first odd-row-color"><code>static class&nbsp;</code></div>
<div class="col-second odd-row-color"><code><a href="DualState.SingleSPIcursorClose.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.SingleSPIcursorClose</a>&lt;<a href="DualState.SingleSPIcursorClose.html" title="type parameter in DualState.SingleSPIcursorClose">T</a>&gt;</code></div>
<div class="col-last odd-row-color">
<div class="block">A <code>DualState</code> subclass whose only native resource releasing action
 needed is <code>SPI_cursor_close</code> of a single pointer.</div>
</div>
<div class="col-first even-row-color"><code>static class&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="DualState.SingleSPIfreeplan.html" class="type-name-link" title="class in org.postgresql.pljava.internal">DualState.SingleSPIfreeplan</a>&lt;<a href="DualState.SingleSPIfreeplan.html" title="type parameter in DualState.SingleSPIfreeplan">T</a>&gt;</code></div>
<div class="col-last even-row-color">
<div class="block">A <code>DualState</code> subclass whose only native resource releasing action
 needed is <code>SPI_freeplan</code> of a single pointer.</div>
</div>
</div>
</section>
</li>
<!-- =========== FIELD SUMMARY =========== -->
<li>
<section class="field-summary" id="field-summary">
<h2>Field Summary</h2>
<div class="caption"><span>Fields</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Field</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>protected final long</code></div>
<div class="col-second even-row-color"><code><a href="#m_resourceOwner" class="member-name-link">m_resourceOwner</a></code></div>
<div class="col-last even-row-color">
<div class="block">Pointer value of the <code>ResourceOwner</code> this instance belongs to,
 if any.</div>
</div>
</div>
</section>
</li>
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<li>
<section class="constructor-summary" id="constructor-summary">
<h2>Constructor Summary</h2>
<div class="caption"><span>Constructors</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier</div>
<div class="table-header col-second">Constructor</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>protected </code></div>
<div class="col-constructor-name even-row-color"><code><a href="#%3Cinit%3E(org.postgresql.pljava.internal.DualState.Key,T,long)" class="member-name-link">DualState</a><wbr>(<a href="DualState.Key.html" title="class in org.postgresql.pljava.internal">DualState.Key</a>&nbsp;cookie,
 <a href="DualState.html" title="type parameter in DualState">T</a>&nbsp;referent,
 long&nbsp;resourceOwner)</code></div>
<div class="col-last even-row-color">
<div class="block">Construct a <code>DualState</code> instance with a reference to the Java
 object whose state it represents.</div>
</div>
</div>
</section>
</li>
<!-- ========== METHOD SUMMARY =========== -->
<li>
<section class="method-summary" id="method-summary">
<h2>Method Summary</h2>
<div id="method-summary-table">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="method-summary-table-tab0" role="tab" aria-selected="true" aria-controls="method-summary-table.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table', 3)" class="active-table-tab">All Methods</button><button id="method-summary-table-tab1" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab1', 3)" class="table-tab">Static Methods</button><button id="method-summary-table-tab2" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab2', 3)" class="table-tab">Instance Methods</button><button id="method-summary-table-tab4" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab4', 3)" class="table-tab">Concrete Methods</button></div>
<div id="method-summary-table.tabpanel" role="tabpanel">
<div class="summary-table three-column-summary" aria-labelledby="method-summary-table-tab0">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Method</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected final void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#adoptionLock(org.postgresql.pljava.internal.DualState.Key)" class="member-name-link">adoptionLock</a><wbr>(<a href="DualState.Key.html" title="class in org.postgresql.pljava.internal">DualState.Key</a>&nbsp;cookie)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Specialized version of <a href="#lock(boolean)"><code>lock</code></a> for use by code implementing an
 <code>adopt</code> operation (in which complete control of an object is handed
 back to PostgreSQL and it is dissociated from Java).</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected final void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#adoptionUnlock(org.postgresql.pljava.internal.DualState.Key)" class="member-name-link">adoptionUnlock</a><wbr>(<a href="DualState.Key.html" title="class in org.postgresql.pljava.internal">DualState.Key</a>&nbsp;cookie)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Specialized version of <a href="#unlock(int,boolean)"><code>unlock</code></a> for use by
 code implementing an <code>adopt</code> operation (in which complete control
 of an object is handed back to PostgreSQL and it is dissociated from
 Java).</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab1 method-summary-table-tab4"><code>protected static void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab1 method-summary-table-tab4"><code><a href="#checkCookie(org.postgresql.pljava.internal.DualState.Key)" class="member-name-link">checkCookie</a><wbr>(<a href="DualState.Key.html" title="class in org.postgresql.pljava.internal">DualState.Key</a>&nbsp;cookie)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab1 method-summary-table-tab4">
<div class="block">Check that a cookie is valid, throwing an unchecked exception otherwise.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>final void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#clear()" class="member-name-link">clear</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Throws <code>UnsupportedOperationException</code>; <code>releaseFromJava</code>
 must be used rather than calling this method directly.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>final boolean</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#enqueue()" class="member-name-link">enqueue</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Throws <code>UnsupportedOperationException</code>; <code>releaseFromJava</code>
 must be used rather than calling this method directly.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>final <a href="DualState.html" title="type parameter in DualState">T</a></code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#get()" class="member-name-link">get</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Throws <code>UnsupportedOperationException</code>; client code should already
 hold a reference.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#identifierForMessage()" class="member-name-link">identifierForMessage</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Return a string identifying this object in a way useful within an
 exception message for use of this state after native release or Java
 release.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#invalidMessage()" class="member-name-link">invalidMessage</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Return a string for an exception message reporting the use of this object
 after the native state has been released.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#invalidSqlState()" class="member-name-link">invalidSqlState</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Return the SQLSTATE appropriate for an attempt to use this object
 after its native state has been released.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#javaStateReleased(boolean)" class="member-name-link">javaStateReleased</a><wbr>(boolean&nbsp;nativeStateLive)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Called after client code has called <code>releaseFromJava</code>, always on
 a thread for which <code>Backend.threadMayEnterPG()</code> is true, and after
 any pins held on the state have been released.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#javaStateUnreachable(boolean)" class="member-name-link">javaStateUnreachable</a><wbr>(boolean&nbsp;nativeStateLive)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Method that will be called when the Java garbage collector has determined
 the referent object is no longer strongly reachable.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected final int</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#lock(boolean)" class="member-name-link">lock</a><wbr>(boolean&nbsp;upgrade)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Take an exclusive lock in preparation to mutate the state.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#nativeStateReleased(boolean)" class="member-name-link">nativeStateReleased</a><wbr>(boolean&nbsp;javaStateLive)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Method that will be called when the associated <code>ResourceOwner</code>
 is released, indicating that the native portion of the state
 is no longer valid.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>final void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#pin()" class="member-name-link">pin</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Obtain a pin on this state, throwing an appropriate exception if it
 is not still valid, blocking if necessary until release of a lock.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>final boolean</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#pinnedByCurrentThread()" class="member-name-link">pinnedByCurrentThread</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Whether the current thread has pinned this object, for use in assertions.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>final boolean</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#pinUnlessReleased()" class="member-name-link">pinUnlessReleased</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Obtain a pin on this state, if it is still valid, blocking if necessary
 until release of a lock.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected final <a href="DualState.html" title="type parameter in DualState">T</a></code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#referent()" class="member-name-link">referent</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Used internally to obtain this object's referent.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#releasedMessage()" class="member-name-link">releasedMessage</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Return a string for an exception message reporting the use of this object
 after the Java state has been released.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#releasedSqlState()" class="member-name-link">releasedSqlState</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Return the SQLSTATE appropriate for an attempt to use this object
 after its Java state has been released.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected final void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#releaseFromJava()" class="member-name-link">releaseFromJava</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">What Java code will call to explicitly release this instance
 (in the implementation of <code>close</code>, for example).</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#toString()" class="member-name-link">toString</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Produce a string describing this state object in a way useful for
 debugging, with such information as the associated <code>ResourceOwner</code>
 and whether the state is fresh or stale.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#toString(java.lang.Object)" class="member-name-link">toString</a><wbr>(<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a>&nbsp;o)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Produce a string with such details of this object as might be useful for
 debugging, starting with an abbreviated form of the class name of the
 supplied object.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected final void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#unlock(int)" class="member-name-link">unlock</a><wbr>(int&nbsp;s)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Calls <a href="#unlock(int,boolean)"><code>unlock(s, false)</code></a>.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>protected final void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#unlock(int,boolean)" class="member-name-link">unlock</a><wbr>(int&nbsp;s,
 boolean&nbsp;isNativeRelease)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Release a lock, optionally setting the <code>NATIVE_RELEASED</code> flag
 atomically in the process.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>final void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#unpin()" class="member-name-link">unpin</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Release a pin.</div>
</div>
</div>
</div>
</div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.ref.Reference">Methods inherited from class&nbsp;java.lang.ref.<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html" title="class or interface in java.lang.ref" class="external-link">Reference</a></h3>
<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#clone()" title="class or interface in java.lang.ref" class="external-link">clone</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#isEnqueued()" title="class or interface in java.lang.ref" class="external-link">isEnqueued</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#reachabilityFence(java.lang.Object)" title="class or interface in java.lang.ref" class="external-link">reachabilityFence</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#refersTo(T)" title="class or interface in java.lang.ref" class="external-link">refersTo</a></code></div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.Object">Methods inherited from class&nbsp;java.lang.<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></h3>
<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#equals(java.lang.Object)" title="class or interface in java.lang" class="external-link">equals</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#finalize()" title="class or interface in java.lang" class="external-link">finalize</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#getClass()" title="class or interface in java.lang" class="external-link">getClass</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#hashCode()" title="class or interface in java.lang" class="external-link">hashCode</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notify()" title="class or interface in java.lang" class="external-link">notify</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notifyAll()" title="class or interface in java.lang" class="external-link">notifyAll</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait()" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait(long)" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait(long,int)" title="class or interface in java.lang" class="external-link">wait</a></code></div>
</section>
</li>
</ul>
</section>
<section class="details">
<ul class="details-list">
<!-- ============ FIELD DETAIL =========== -->
<li>
<section class="field-details" id="field-detail">
<h2>Field Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="m_resourceOwner">
<h3>m_resourceOwner</h3>
<div class="member-signature"><span class="modifiers">protected final</span>&nbsp;<span class="return-type">long</span>&nbsp;<span class="element-name">m_resourceOwner</span></div>
<div class="block">Pointer value of the <code>ResourceOwner</code> this instance belongs to,
 if any.</div>
</section>
</li>
</ul>
</section>
</li>
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<li>
<section class="constructor-details" id="constructor-detail">
<h2>Constructor Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="&lt;init&gt;(org.postgresql.pljava.internal.DualState.Key,T,long)">
<h3 id="&lt;init&gt;(org.postgresql.pljava.internal.DualState.Key,java.lang.Object,long)">DualState</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="element-name">DualState</span><wbr><span class="parameters">(<a href="DualState.Key.html" title="class in org.postgresql.pljava.internal">DualState.Key</a>&nbsp;cookie,
 <a href="DualState.html" title="type parameter in DualState">T</a>&nbsp;referent,
 long&nbsp;resourceOwner)</span></div>
<div class="block">Construct a <code>DualState</code> instance with a reference to the Java
 object whose state it represents.
<p>
 Subclass constructors must accept a <em>cookie</em> parameter from the
 native caller, and pass it along to superclass constructors. That allows
 some confidence that constructor parameters representing native values
 are for real, and also that the construction is taking place on a thread
 holding the native lock, keeping the concurrency story simple.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>cookie</code> - Capability held by native code to invoke <code>DualState</code>
 constructors.</dd>
<dd><code>referent</code> - The Java object whose state this instance represents.</dd>
<dd><code>resourceOwner</code> - Pointer value of the native <code>ResourceOwner</code>
 whose release callback will indicate that this object's native state is
 no longer valid. If zero (a NULL pointer in C), it indicates that the
 state is held in long-lived native memory (such as JavaMemoryContext),
 and can only be released via <code>javaStateUnreachable</code> or
 <code>javaStateReleased</code>.</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
<!-- ============ METHOD DETAIL ========== -->
<li>
<section class="method-details" id="method-detail">
<h2>Method Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="checkCookie(org.postgresql.pljava.internal.DualState.Key)">
<h3>checkCookie</h3>
<div class="member-signature"><span class="modifiers">protected static</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">checkCookie</span><wbr><span class="parameters">(<a href="DualState.Key.html" title="class in org.postgresql.pljava.internal">DualState.Key</a>&nbsp;cookie)</span></div>
<div class="block">Check that a cookie is valid, throwing an unchecked exception otherwise.</div>
</section>
</li>
<li>
<section class="detail" id="nativeStateReleased(boolean)">
<h3>nativeStateReleased</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">nativeStateReleased</span><wbr><span class="parameters">(boolean&nbsp;javaStateLive)</span></div>
<div class="block">Method that will be called when the associated <code>ResourceOwner</code>
 is released, indicating that the native portion of the state
 is no longer valid. The implementing class should clean up
 whatever is appropriate to that event.
<p>
 This object's exclusive <code>lock()</code>  will always be held when this
 method is called during resource owner release. The class whose state
 this is must use <a href="#pin()"><code>pin()</code></a>, followed by
 <a href="#unpin()"><code>unpin()</code></a> in a <code>finally</code> block, around every
 (ideally short) block of code that could refer to the native state.
<p>
 This default implementation does nothing.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>javaStateLive</code> - true is passed if the instance's "Java state" is
 still considered live, that is, <code>releaseFromJava</code> has not been
 called, and the garbage collector has not determined the referent to be
 unreachable.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="javaStateUnreachable(boolean)">
<h3>javaStateUnreachable</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">javaStateUnreachable</span><wbr><span class="parameters">(boolean&nbsp;nativeStateLive)</span></div>
<div class="block">Method that will be called when the Java garbage collector has determined
 the referent object is no longer strongly reachable. This default
 implementation does nothing; a subclass should override it to do any
 cleanup, or release of native resources, that may be required.
<p>
 If the <code>nativeStateLive</code> parameter is false, this method must avoid
 any action (such as freeing) it would otherwise take on the associated
 native state; if it does not, double-free crashes can result.
<p>
 It is not necessary for this method to remove the instance from the
 live-instances data structures; that will have been done just before
 this method is called.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>nativeStateLive</code> - true is passed if the instance's "native state" is
 still considered live, that is, no resource-owner callback has been
 invoked to stamp it invalid (nor has it been "adopted").</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="javaStateReleased(boolean)">
<h3>javaStateReleased</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">javaStateReleased</span><wbr><span class="parameters">(boolean&nbsp;nativeStateLive)</span></div>
<div class="block">Called after client code has called <code>releaseFromJava</code>, always on
 a thread for which <code>Backend.threadMayEnterPG()</code> is true, and after
 any pins held on the state have been released.
<p>
 This should not be called directly. When Java code has called
 <code>releaseFromJava</code>, the state will be changed to 'released'
 immediately, though without actually disturbing any state that might be
 referenced by threads with existing pins. This method will be called
 at some later time, always on a thread able to enter PG, and with no
 other threads having the native state pinned, so this is the place for
 any actual release of native state that may be needed.
<p>
 If the <code>nativeStateLive</code> parameter is false, this method must avoid
 any action (such as freeing) it would otherwise take on the associated
 native state; if it does not, double-free crashes can result.
<p>
 This default implementation calls <code>javaStateUnreachable</code>, which, in
 typical cases, will have the same cleanup to do.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>nativeStateLive</code> - true is passed if the instance's "native state" is
 still considered live, that is, no resource-owner callback has been
 invoked to stamp it invalid (nor has it been "adopted").</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="releaseFromJava()">
<h3>releaseFromJava</h3>
<div class="member-signature"><span class="modifiers">protected final</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">releaseFromJava</span>()</div>
<div class="block">What Java code will call to explicitly release this instance
 (in the implementation of <code>close</code>, for example).
<p>
 The state is immediately marked 'released' to prevent future use, while
 a call to <code>javaStateReleased</code> will be deferred until after any pins
 currently held on the state have been released.</div>
</section>
</li>
<li>
<section class="detail" id="enqueue()">
<h3>enqueue</h3>
<div class="member-signature"><span class="modifiers">public final</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">enqueue</span>()</div>
<div class="block">Throws <code>UnsupportedOperationException</code>; <code>releaseFromJava</code>
 must be used rather than calling this method directly.</div>
<dl class="notes">
<dt>Overrides:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#enqueue()" title="class or interface in java.lang.ref" class="external-link">enqueue</a></code>&nbsp;in class&nbsp;<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html" title="class or interface in java.lang.ref" class="external-link">Reference</a>&lt;<a href="DualState.html" title="type parameter in DualState">T</a>&gt;</code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="clear()">
<h3>clear</h3>
<div class="member-signature"><span class="modifiers">public final</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">clear</span>()</div>
<div class="block">Throws <code>UnsupportedOperationException</code>; <code>releaseFromJava</code>
 must be used rather than calling this method directly.</div>
<dl class="notes">
<dt>Overrides:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#clear()" title="class or interface in java.lang.ref" class="external-link">clear</a></code>&nbsp;in class&nbsp;<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html" title="class or interface in java.lang.ref" class="external-link">Reference</a>&lt;<a href="DualState.html" title="type parameter in DualState">T</a>&gt;</code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="get()">
<h3>get</h3>
<div class="member-signature"><span class="modifiers">public final</span>&nbsp;<span class="return-type"><a href="DualState.html" title="type parameter in DualState">T</a></span>&nbsp;<span class="element-name">get</span>()</div>
<div class="block">Throws <code>UnsupportedOperationException</code>; client code should already
 hold a reference.</div>
<dl class="notes">
<dt>Overrides:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#get()" title="class or interface in java.lang.ref" class="external-link">get</a></code>&nbsp;in class&nbsp;<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html" title="class or interface in java.lang.ref" class="external-link">Reference</a>&lt;<a href="DualState.html" title="type parameter in DualState">T</a>&gt;</code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="referent()">
<h3>referent</h3>
<div class="member-signature"><span class="modifiers">protected final</span>&nbsp;<span class="return-type"><a href="DualState.html" title="type parameter in DualState">T</a></span>&nbsp;<span class="element-name">referent</span>()</div>
<div class="block">Used internally to obtain this object's referent.</div>
</section>
</li>
<li>
<section class="detail" id="pin()">
<h3>pin</h3>
<div class="member-signature"><span class="modifiers">public final</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">pin</span>()
               throws <span class="exceptions"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.sql/java/sql/SQLException.html" title="class or interface in java.sql" class="external-link">SQLException</a></span></div>
<div class="block">Obtain a pin on this state, throwing an appropriate exception if it
 is not still valid, blocking if necessary until release of a lock.
<p>
 Pins are re-entrant; a thread may obtain more than one on the same
 object, in strictly nested fashion. Only the outer acquisition (and
 corresponding release) will have any memory synchronization effect;
 likewise, only the outer acquisition will detect release of the object
 and throw the associated exception.</div>
<dl class="notes">
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.sql/java/sql/SQLException.html" title="class or interface in java.sql" class="external-link">SQLException</a></code> - if the native state or the Java state has been
 released.</dd>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/concurrent/CancellationException.html" title="class or interface in java.util.concurrent" class="external-link">CancellationException</a></code> - if the thread is interrupted while waiting.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="pinUnlessReleased()">
<h3>pinUnlessReleased</h3>
<div class="member-signature"><span class="modifiers">public final</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">pinUnlessReleased</span>()</div>
<div class="block">Obtain a pin on this state, if it is still valid, blocking if necessary
 until release of a lock.
<p>
 Pins are re-entrant; a thread may obtain more than one on the same
 object, in strictly nested fashion. Only the outer acquisition (and
 corresponding release) will have any memory synchronization effect;
 likewise, only the outer acquisition will detect release of the object
 and throw the associated exception.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>true if the state has already been released; this will often be
 used in a caller (such as a <code>close</code> or <code>free</code> operation) that
 will have nothing to do and return immediately if this method returns
 true.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/concurrent/CancellationException.html" title="class or interface in java.util.concurrent" class="external-link">CancellationException</a></code> - if the thread is interrupted while waiting.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="unpin()">
<h3>unpin</h3>
<div class="member-signature"><span class="modifiers">public final</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">unpin</span>()</div>
<div class="block">Release a pin.
<p>
 If the current thread has pinned the same object more than once, only the
 last <code>unpin</code> will have any memory synchronization effect.</div>
</section>
</li>
<li>
<section class="detail" id="pinnedByCurrentThread()">
<h3>pinnedByCurrentThread</h3>
<div class="member-signature"><span class="modifiers">public final</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">pinnedByCurrentThread</span>()</div>
<div class="block">Whether the current thread has pinned this object, for use in assertions.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>true if the current thread holds a(t least one) pin on
 the receiver, or is the PG thread and holds the lock.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="lock(boolean)">
<h3>lock</h3>
<div class="member-signature"><span class="modifiers">protected final</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">lock</span><wbr><span class="parameters">(boolean&nbsp;upgrade)</span></div>
<div class="block">Take an exclusive lock in preparation to mutate the state.
<p>
 Only a thread for which <code>Backend.threadMayEnterPG()</code> returns true
 may acquire this lock.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>upgrade</code> - whether to acquire the lock without blocking even in the
 presence of a pin held by this thread; should be true only in cases where
 inspection shows a nearby enclosing pin whose assumptions clearly will
 not be violated by the actions to be taken under the lock.</dd>
<dt>Returns:</dt>
<dd>A semi-redacted version of the lock state, enough to discern
 whether it contains <code>NATIVE_RELEASED</code> or <code>JAVA_RELEASED</code>
 in case the caller cares, and for the paired <code>unlock</code> call to know
 whether this was a reentrant call, or should really be released.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="unlock(int)">
<h3>unlock</h3>
<div class="member-signature"><span class="modifiers">protected final</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">unlock</span><wbr><span class="parameters">(int&nbsp;s)</span></div>
<div class="block">Calls <a href="#unlock(int,boolean)"><code>unlock(s, false)</code></a>.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>s</code> - must be the value returned by the <code>lock</code> call.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="unlock(int,boolean)">
<h3>unlock</h3>
<div class="member-signature"><span class="modifiers">protected final</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">unlock</span><wbr><span class="parameters">(int&nbsp;s,
 boolean&nbsp;isNativeRelease)</span></div>
<div class="block">Release a lock, optionally setting the <code>NATIVE_RELEASED</code> flag
 atomically in the process.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>s</code> - must be the value returned by the <code>lock</code> call.</dd>
<dd><code>isNativeRelease</code> - whether to set the <code>NATIVE_RELEASED</code> flag.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="adoptionLock(org.postgresql.pljava.internal.DualState.Key)">
<h3>adoptionLock</h3>
<div class="member-signature"><span class="modifiers">protected final</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">adoptionLock</span><wbr><span class="parameters">(<a href="DualState.Key.html" title="class in org.postgresql.pljava.internal">DualState.Key</a>&nbsp;cookie)</span>
                           throws <span class="exceptions"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.sql/java/sql/SQLException.html" title="class or interface in java.sql" class="external-link">SQLException</a></span></div>
<div class="block">Specialized version of <a href="#lock(boolean)"><code>lock</code></a> for use by code implementing an
 <code>adopt</code> operation (in which complete control of an object is handed
 back to PostgreSQL and it is dissociated from Java).
<p>
 Can only be called on the PG thread, which must already hold a pin.
 No other thread can hold a pin, and neither the <code>NATIVE_RELEASED</code>
 nor <code>JAVA_RELEASED</code> flag may be set. This method is non-blocking
 and will simply throw an exception if these preconditions are not
 satisfied.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>cookie</code> - Capability held by native code to invoke special
 <code>DualState</code> methods.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.sql/java/sql/SQLException.html" title="class or interface in java.sql" class="external-link">SQLException</a></code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="adoptionUnlock(org.postgresql.pljava.internal.DualState.Key)">
<h3>adoptionUnlock</h3>
<div class="member-signature"><span class="modifiers">protected final</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">adoptionUnlock</span><wbr><span class="parameters">(<a href="DualState.Key.html" title="class in org.postgresql.pljava.internal">DualState.Key</a>&nbsp;cookie)</span>
                             throws <span class="exceptions"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.sql/java/sql/SQLException.html" title="class or interface in java.sql" class="external-link">SQLException</a></span></div>
<div class="block">Specialized version of <a href="#unlock(int,boolean)"><code>unlock</code></a> for use by
 code implementing an <code>adopt</code> operation (in which complete control
 of an object is handed back to PostgreSQL and it is dissociated from
 Java).
<p>
 Must only be called on the PG thread, which must have acquired
 <code>adoptionLock</code>. Invokes the <code>nativeStateReleased</code> callback,
 then releases the lock, leaving both <code>NATIVE_RELEASED</code>
 and <code>JAVA_RELEASED</code> flags set. When the calling code releases the
 prior pin it was expected to hold, the <code>javaStateReleased</code> callback
 will execute. A value of false will be passed to both callbacks.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>cookie</code> - Capability held by native code to invoke special
 <code>DualState</code> methods.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.sql/java/sql/SQLException.html" title="class or interface in java.sql" class="external-link">SQLException</a></code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="identifierForMessage()">
<h3>identifierForMessage</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">identifierForMessage</span>()</div>
<div class="block">Return a string identifying this object in a way useful within an
 exception message for use of this state after native release or Java
 release.
<p>
 This implementation returns the class name of the referent, or of this
 object if the referent has already been cleared.</div>
</section>
</li>
<li>
<section class="detail" id="invalidMessage()">
<h3>invalidMessage</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">invalidMessage</span>()</div>
<div class="block">Return a string for an exception message reporting the use of this object
 after the native state has been released.
<p>
 This implementation returns <code>identifierForMessage()</code> with
 " used beyond its PostgreSQL lifetime" appended.</div>
</section>
</li>
<li>
<section class="detail" id="releasedMessage()">
<h3>releasedMessage</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">releasedMessage</span>()</div>
<div class="block">Return a string for an exception message reporting the use of this object
 after the Java state has been released.
<p>
 This implementation returns <code>identifierForMessage()</code> with
 " used after released by Java" appended.</div>
</section>
</li>
<li>
<section class="detail" id="invalidSqlState()">
<h3>invalidSqlState</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">invalidSqlState</span>()</div>
<div class="block">Return the SQLSTATE appropriate for an attempt to use this object
 after its native state has been released.
<p>
 This implementation returns 55000, object not in prerequisite state.</div>
</section>
</li>
<li>
<section class="detail" id="releasedSqlState()">
<h3>releasedSqlState</h3>
<div class="member-signature"><span class="modifiers">protected</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">releasedSqlState</span>()</div>
<div class="block">Return the SQLSTATE appropriate for an attempt to use this object
 after its Java state has been released.
<p>
 This implementation returns 55000, object not in prerequisite state.</div>
</section>
</li>
<li>
<section class="detail" id="toString()">
<h3>toString</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">toString</span>()</div>
<div class="block">Produce a string describing this state object in a way useful for
 debugging, with such information as the associated <code>ResourceOwner</code>
 and whether the state is fresh or stale.
<p>
 This method calls <a href="#toString(java.lang.Object)"><code>toString(Object)</code></a> passing <code>this</code>.
 Subclasses are encouraged to override that method with versions that add
 subclass-specific details.</div>
<dl class="notes">
<dt>Overrides:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#toString()" title="class or interface in java.lang" class="external-link">toString</a></code>&nbsp;in class&nbsp;<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></code></dd>
<dt>Returns:</dt>
<dd>Description of this state object.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="toString(java.lang.Object)">
<h3>toString</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">toString</span><wbr><span class="parameters">(<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a>&nbsp;o)</span></div>
<div class="block">Produce a string with such details of this object as might be useful for
 debugging, starting with an abbreviated form of the class name of the
 supplied object.
<p>
 Subclasses are encouraged to override this and then call it, via super,
 passing the object unchanged, and then append additional
 subclass-specific details to the result.
<p>
 Because the recursion ends here, this one actually does construct the
 abbreviated form of the class name of the object, and use it at the start
 of the returned string.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>o</code> - An object whose class name (abbreviated by stripping the package
 prefix) will be used at the start of the string. Passing <code>null</code> is
 the same as passing <code>this</code>.</dd>
<dt>Returns:</dt>
<dd>Description of this state object, prefixed with the abbreviated
 class name of the passed object.</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2003&#x2013;2025<a href='http://tada.se/eng/'>Tada AB</a></small></p>
</footer>
</div>
</div>
</body>
</html>
