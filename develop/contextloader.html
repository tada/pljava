<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/develop/contextloader.md at 2024-10-19

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>PostgreSQL PL/Java &#x2013; The thread context class loader</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2024-10-19</span>
           | <span id="projectVersion">Version: 1.6.8</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a></li>
     <li class="none"><a href="../install/upgrade.html" title="Upgrading">Upgrading</a></li>
     <li class="none"><a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>The thread context class loader</h1>
<p>Starting with PL/Java 1.6.3, within an SQL-declared PL/Java function, the
class loader returned by <code>Thread.currentThread().getContextClassLoader</code>
is the one that corresponds to the per-schema classpath that has been set
with <a href="../pljava/apidocs/org.postgresql.pljava.internal/org/postgresql/pljava/management/Commands.html#set_classpath"><code>SQLJ.SET_CLASSPATH</code></a> for the schema where the function is
declared (assuming no Java code uses <code>setContextClassLoader</code> to change it).</p>
<p>Many available Java libraries, as well as built-in Java facilities using the
<a class="externalLink" href="https://docs.oracle.com/javase/9/docs/api/java/util/ServiceLoader.html"><code>ServiceLoader</code></a>, refer to the context class loader, so this behavior
ensures they will see the classes that are available on the classpath that was
set up for the PL/Java function. In versions where PL/Java did not set the
context loader, awkward arrangements could be needed in user code for the
desired classes or services to be found.</p><section>
<h2><a name="Limits_on_the_implementation"></a>Limits on the implementation</h2>
<p>To set this loader with minimal overhead on function entry, PL/Java uses native
access to a <code>Thread</code> field. It is possible that some Java runtimes can exist
where the expected field is not present, and PL/Java will fall back (with a
warning) to not managing the context loader. The warning can be suppressed
by explicitly configuring PL/Java not to manage the context loader, as described
below.</p>
<p>It is also possible for an application or library to create subclasses
of <code>Thread</code> that override the behavior of <code>getContextClassLoader</code> so that
the value set by PL/Java will have no effect. PL/Java does not detect or work
around such a case. A clear sign of code that does subclass <code>Thread</code>
in this way is that it will need the <code>enableContextClassLoaderOverride</code>
<a class="externalLink" href="https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/lang/RuntimePermission.html"><code>RuntimePermission</code></a> to be granted in
the <a href="../use/policy.html">policy</a>.</p></section><section>
<h2><a name="Effects_on_application_code"></a>Effects on application code</h2>
<p>With this change as of PL/Java 1.6.3, application or library code that uses
the <a class="externalLink" href="https://docs.oracle.com/javase/9/docs/api/java/util/ServiceLoader.html"><code>ServiceLoader</code></a>, or otherwise refers to the context class loader,
will find services or resources available on the class path that was set up
for the function. Typically, this behavior is wanted. In prior PL/Java versions,
services and resources might be found only if they were available to the
system class loader.</p>
<p>For example, a call like <code>javax.xml.transform.TransformerFactory.newInstance()</code>
might return Java's built-in XSLT 1.0 implementation if there is nothing else
on the class path, but return an XSLT 3.0 implementation if the configured
PL/Java class path includes a Saxon jar.</p>
<p>If there are cases where an application intends to use a built-in Java
implementation regardless of the class path, there may be a method available
that specifies that behavior. For example,
<a class="externalLink" href="https://docs.oracle.com/javase/9/docs/api/javax/xml/transform/TransformerFactory.html#newDefaultInstance--"><code>TransformerFactory.newDefaultInstance()</code></a> will always return Java's
own <code>Transformer</code> implementation.</p>
<p>If an application misbehaves as a result of finding implementations on the
class path it was not finding before, and cannot be conveniently fixed by
adjusting the class path or changing to <code>newDefaultInstance</code>-like methods
in the code, PL/Java can be configured for its old behavior of not setting
the context class loader, as described below.</p></section><section>
<h2><a name="Effects_on_UDT_methods"></a>Effects on UDT methods</h2>
<p>User-defined types implemented in PL/Java have support methods that are
transparently invoked to convert database values to Java values and back.
This can happen within a PL/Java function, when it gets or sets values in
<code>ResultSet</code>, <code>PreparedStatement</code>, <code>SQLInput</code>, or <code>SQLOutput</code> objects, and
also conceptually &#x201c;before&#x201d; or &#x201c;after&#x201d; the function proper, to convert its
incoming parameters and its return value(s). In all such contexts, the UDT
methods are considered to act on behalf of that target PL/Java function,
and the context class loader they see is the one for the schema where the
target function is declared.</p>
<p>A <a href="../pljava-api/apidocs/org.postgresql.pljava/org/postgresql/pljava/annotation/BaseUDT.html"><code>BaseUDT</code></a> implemented in PL/Java has support methods that are
declared to PostgreSQL as SQL functions in their own right. In addition to being
transparently called on behalf of another PL/Java function, with the behavior
described above, they can be called directly by PostgreSQL like any other
SQL function. When that happens, like any other declared function, they will
have the context class loader set according to the schema containing the
declaration.</p></section><section>
<h2><a name="Suppressing_context_loader_management"></a>Suppressing context loader management</h2>
<p>Some circumstances may call for keeping the pre-1.6.3 behavior
where no management of the context class loader was done. That could be to
avoid unplanned effects on applications as described above, or to suppress
the warning message if running on a JVM where PL/Java's technique doesn't work.</p>
<p>To suppress the loader management, add</p>

<div class="source">
<pre><code>-Dorg.postgresql.pljava.context.loader=unmanaged
</code></pre></div>
<p>in the <code>pljava.vmoptions</code> <a href="../use/variables.html">setting</a>.</p></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2024<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
