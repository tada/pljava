<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (21) on Fri May 09 16:58:21 EDT 2025 -->
<title>ExprContextImpl (PL/Java backend Java code 1.7-SNAPSHOT)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="dc.created" content="2025-05-09">
<meta name="description" content="declaration: module: org.postgresql.pljava.internal, package: org.postgresql.pljava.pg, class: ExprContextImpl">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../script-dir/jquery-ui.min.css" title="Style">
<script type="text/javascript" src="../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top"><button id="navbar-toggle-button" aria-controls="navbar-top" aria-expanded="false" aria-label="Toggle navigation links"><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span></button>
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../module-summary.html">Module</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/ExprContextImpl.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html#class">Help</a></li>
</ul>
<ul class="sub-nav-list-small">
<li>
<p>Summary:</p>
<ul>
<li><a href="#nested-class-summary">Nested</a></li>
<li>Field</li>
<li>Constr</li>
<li><a href="#method-summary">Method</a></li>
</ul>
</li>
<li>
<p>Detail:</p>
<ul>
<li>Field</li>
<li>Constr</li>
<li>Method</li>
</ul>
</li>
</ul>
</div>
<div class="sub-nav">
<div id="navbar-sub-list">
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li><a href="#nested-class-summary">Nested</a>&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#method-summary">Method</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li>Method</li>
</ul>
</div>
<div class="nav-list-search"><a href="../../../../../search.html">SEARCH</a>
<input type="text" id="search-input" disabled placeholder="Search">
<input type="reset" id="reset-button" disabled value="reset">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="module-label-in-type">Module</span>&nbsp;<a href="../../../../module-summary.html">org.postgresql.pljava.internal</a></div>
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">org.postgresql.pljava.pg</a></div>
<h1 title="Class ExprContextImpl" class="title">Class ExprContextImpl</h1>
</div>
<div class="inheritance" title="Inheritance Tree"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">java.lang.Object</a>
<div class="inheritance"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html" title="class or interface in java.lang.ref" class="external-link">java.lang.ref.Reference</a>&lt;<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&gt;
<div class="inheritance"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/WeakReference.html" title="class or interface in java.lang.ref" class="external-link">java.lang.ref.WeakReference</a>&lt;<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&gt;
<div class="inheritance"><a href="../internal/DualState.html" title="class in org.postgresql.pljava.internal">org.postgresql.pljava.internal.DualState</a>&lt;<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&gt;
<div class="inheritance"><a href="../internal/DualState.ListHead.html" title="class in org.postgresql.pljava.internal">org.postgresql.pljava.internal.DualState.ListHead</a>
<div class="inheritance"><a href="../internal/LifespanImpl.html" title="class in org.postgresql.pljava.internal">org.postgresql.pljava.internal.LifespanImpl</a>
<div class="inheritance">org.postgresql.pljava.pg.ExprContextImpl</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section class="class-description" id="class-description">
<dl class="notes">
<dt>All Implemented Interfaces:</dt>
<dd><code><a href="../../../../../../../pljava-api/apidocs/org.postgresql.pljava/org/postgresql/pljava/Lifespan.html" title="class or interface in org.postgresql.pljava" class="external-link">Lifespan</a></code></dd>
</dl>
<hr>
<div class="type-signature"><span class="modifiers">public class </span><span class="element-name type-name-label">ExprContextImpl</span>
<span class="extends-implements">extends <a href="../internal/LifespanImpl.html" title="class in org.postgresql.pljava.internal">LifespanImpl</a></span></div>
<div class="block">A lazily-created mirror of a PostgreSQL ExprContext, exposing only as much
 as might be useful in the dispatching of set-returning functions.
<p>
 There is no PL/Java API interface that corresponds to this model; it is only
 used in the implementation module. It may be exposed in the API as an object
 that implements <code>Lifespan</code> but is otherwise unspecified.
<p>
 PostgreSQL is creating, resetting, and deleting ExprContexts all the time,
 and most of them will never be visible in PL/Java; one of these objects only
 gets created when Java code specifically requests a reference to a particular
 context, generally to make it the <code>Lifespan</code> of some PL/Java object
 that should be invalidated when the context is shut down.
<p>
 Once an instance of this class has been instantiated and before it escapes to
 calling Java code, it is registered for a shutdown callback on the
 underlying PostgreSQL context so it can track its life cycle and invalidate,
 when the time comes, any objects it has been used as the "owner" of.
 All creation, traversal, and mutation has to happen on the PG thread. Once
 published and while valid, an instance can be observed by other threads.
<p>
 Events that can occur in the life of an ExprContext:
<dl>
 <dt>Rescan<dd>PostgreSQL calls <code>ReScanExprContext</code> before re-scanning
 its plan node from the start. Its callbacks are invoked and left
 unregistered.
 <dt>Free<dd>PostgreSQL calls <code>FreeExprContext</code> when done with the node,
 whether on a successful path or in error cleanup. All callbacks are left
 unregistered, but will have been invoked only in the successful case. In
 either case, the backing native structure is then freed.
</dl>
<p>
 Because <code>FreeExprContext</code> in error cleanup does not invoke callbacks,
 it is quite possible for the native memory backing an ExprContext to vanish
 without notice, so any values of interest from the structure (chiefly its
 per-tuple and per-query memory contexts) must be eagerly fetched while it is
 known valid. Its callback can become unregistered while thought to be
 registered. And the chief need for the callback (for PL/Java's purposes),
 to ensure that the <a href="../../../../../../../pljava-api/apidocs/org.postgresql.pljava/org/postgresql/pljava/PLJavaBasedLanguage.SRFNext.html#close()" title="class or interface in org.postgresql.pljava" class="external-link"><code>close()</code></a> method
 of a set-returning function gets called, goes unmet in error cleanup if
 relying on the ExprContext callback alone.
<p>
 It is also unsafe to call <code>UnregisterExprContextCallback</code> at an
 arbitrary time. Unregistering an already-unregistered callback is not
 a problem, but unregistering a callback on an ExprContext that has been
 freed without notice is crashworthy. Happily, the only time PL/Java might
 explicitly unregister the callback is after a successful final call of
 <a href="../../../../../../../pljava-api/apidocs/org.postgresql.pljava/org/postgresql/pljava/PLJavaBasedLanguage.SRFNext.html#nextResult(org.postgresql.pljava.model.RegProcedure.Call)" title="class or interface in org.postgresql.pljava" class="external-link"><code>nextResult</code></a>, a moment when
 error cleanup is not in progress and the ExprContext can be safely expected
 to be live.
<p>
 To ensure that <a href="../../../../../../../pljava-api/apidocs/org.postgresql.pljava/org/postgresql/pljava/PLJavaBasedLanguage.SRFNext.html#close()" title="class or interface in org.postgresql.pljava" class="external-link"><code>close()</code></a> is
 called even in error cleanup, this object is itself given a state with
 a <code>Lifespan</code>, namely, that of the per-query memory context, in which
 the ExprContext is normally allocated, and expiration of that
 <code>Lifespan</code> will also be treated as expiration of this one.
<p>
 The approach is nonconservative: because an ExprContext can be (and normally
 is) freed explicitly, there is no guarantee it is live whenever its
 <code>Lifespan</code> is unexpired, but it is definitely gone when its
 <code>Lifespan</code> is.
<p>
 With that addition, it is not strictly necessary to have an action on a
 successful final call of <code>nextResult</code>; one of the two events already
 handled (the callback firing or the memory context being reset) will
 eventually occur and mop up the state. The final-call action could be added
 as an optimization to release the instance more promptly.</div>
</section>
<section class="summary">
<ul class="summary-list">
<!-- ======== NESTED CLASS SUMMARY ======== -->
<li>
<section class="nested-class-summary" id="nested-class-summary">
<h2>Nested Class Summary</h2>
<div class="inherited-list">
<h2 id="nested-classes-inherited-from-class-org.postgresql.pljava.internal.LifespanImpl">Nested classes/interfaces inherited from class&nbsp;org.postgresql.pljava.internal.<a href="../internal/LifespanImpl.html" title="class in org.postgresql.pljava.internal">LifespanImpl</a></h2>
<code><a href="../internal/LifespanImpl.Addressed.html" title="interface in org.postgresql.pljava.internal">LifespanImpl.Addressed</a></code></div>
<div class="inherited-list">
<h2 id="nested-classes-inherited-from-class-org.postgresql.pljava.internal.DualState">Nested classes/interfaces inherited from class&nbsp;org.postgresql.pljava.internal.<a href="../internal/DualState.html" title="class in org.postgresql.pljava.internal">DualState</a></h2>
<code><a href="../internal/DualState.BBHeapFreeTuple.html" title="class in org.postgresql.pljava.internal">DualState.BBHeapFreeTuple</a>&lt;<a href="../internal/DualState.BBHeapFreeTuple.html" title="type parameter in DualState.BBHeapFreeTuple">T</a>&gt;, <a href="../internal/DualState.ListHead.html" title="class in org.postgresql.pljava.internal">DualState.ListHead</a>, <a href="../internal/DualState.Pinned.html" title="interface in org.postgresql.pljava.internal">DualState.Pinned</a>, <a href="../internal/DualState.SingleDeleteGlobalRefP.html" title="class in org.postgresql.pljava.internal">DualState.SingleDeleteGlobalRefP</a>&lt;<a href="../internal/DualState.SingleDeleteGlobalRefP.html" title="type parameter in DualState.SingleDeleteGlobalRefP">T</a>&gt;, <a href="../internal/DualState.SingleFreeErrorData.html" title="class in org.postgresql.pljava.internal">DualState.SingleFreeErrorData</a>&lt;<a href="../internal/DualState.SingleFreeErrorData.html" title="type parameter in DualState.SingleFreeErrorData">T</a>&gt;, <a href="../internal/DualState.SingleFreeTupleDesc.html" title="class in org.postgresql.pljava.internal">DualState.SingleFreeTupleDesc</a>&lt;<a href="../internal/DualState.SingleFreeTupleDesc.html" title="type parameter in DualState.SingleFreeTupleDesc">T</a>&gt;, <a href="../internal/DualState.SingleGuardedBB.html" title="class in org.postgresql.pljava.internal">DualState.SingleGuardedBB</a>&lt;<a href="../internal/DualState.SingleGuardedBB.html" title="type parameter in DualState.SingleGuardedBB">T</a>&gt;, <a href="../internal/DualState.SingleGuardedLong.html" title="class in org.postgresql.pljava.internal">DualState.SingleGuardedLong</a>&lt;<a href="../internal/DualState.SingleGuardedLong.html" title="type parameter in DualState.SingleGuardedLong">T</a>&gt;, <a href="../internal/DualState.SingleHeapFreeTuple.html" title="class in org.postgresql.pljava.internal">DualState.SingleHeapFreeTuple</a>&lt;<a href="../internal/DualState.SingleHeapFreeTuple.html" title="type parameter in DualState.SingleHeapFreeTuple">T</a>&gt;, <a href="../internal/DualState.SingleMemContextDelete.html" title="class in org.postgresql.pljava.internal">DualState.SingleMemContextDelete</a>&lt;<a href="../internal/DualState.SingleMemContextDelete.html" title="type parameter in DualState.SingleMemContextDelete">T</a>&gt;, <a href="../internal/DualState.SinglePfree.html" title="class in org.postgresql.pljava.internal">DualState.SinglePfree</a>&lt;<a href="../internal/DualState.SinglePfree.html" title="type parameter in DualState.SinglePfree">T</a>&gt;, <a href="../internal/DualState.SingleSPIcursorClose.html" title="class in org.postgresql.pljava.internal">DualState.SingleSPIcursorClose</a>&lt;<a href="../internal/DualState.SingleSPIcursorClose.html" title="type parameter in DualState.SingleSPIcursorClose">T</a>&gt;, <a href="../internal/DualState.SingleSPIfreeplan.html" title="class in org.postgresql.pljava.internal">DualState.SingleSPIfreeplan</a>&lt;<a href="../internal/DualState.SingleSPIfreeplan.html" title="type parameter in DualState.SingleSPIfreeplan">T</a>&gt;, <a href="../internal/DualState.SingleSPIfreetuptable.html" title="class in org.postgresql.pljava.internal">DualState.SingleSPIfreetuptable</a>&lt;<a href="../internal/DualState.SingleSPIfreetuptable.html" title="type parameter in DualState.SingleSPIfreetuptable">T</a>&gt;</code></div>
</section>
</li>
<!-- ========== METHOD SUMMARY =========== -->
<li>
<section class="method-summary" id="method-summary">
<h2>Method Summary</h2>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-org.postgresql.pljava.internal.LifespanImpl">Methods inherited from class&nbsp;org.postgresql.pljava.internal.<a href="../internal/LifespanImpl.html" title="class in org.postgresql.pljava.internal">LifespanImpl</a></h3>
<code><a href="../internal/LifespanImpl.html#toString()">toString</a>, <a href="../internal/LifespanImpl.html#toString(java.lang.Object)">toString</a></code></div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-org.postgresql.pljava.internal.DualState.ListHead">Methods inherited from class&nbsp;org.postgresql.pljava.internal.<a href="../internal/DualState.ListHead.html" title="class in org.postgresql.pljava.internal">DualState.ListHead</a></h3>
<code><a href="../internal/DualState.ListHead.html#lifespanRelease()">lifespanRelease</a></code></div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-org.postgresql.pljava.internal.DualState">Methods inherited from class&nbsp;org.postgresql.pljava.internal.<a href="../internal/DualState.html" title="class in org.postgresql.pljava.internal">DualState</a></h3>
<code><a href="../internal/DualState.html#adoptionLock()">adoptionLock</a>, <a href="../internal/DualState.html#adoptionUnlock()">adoptionUnlock</a>, <a href="../internal/DualState.html#clear()">clear</a>, <a href="../internal/DualState.html#enqueue()">enqueue</a>, <a href="../internal/DualState.html#get()">get</a>, <a href="../internal/DualState.html#identifierForMessage()">identifierForMessage</a>, <a href="../internal/DualState.html#invalidMessage()">invalidMessage</a>, <a href="../internal/DualState.html#invalidSqlState()">invalidSqlState</a>, <a href="../internal/DualState.html#javaStateReleased(boolean)">javaStateReleased</a>, <a href="../internal/DualState.html#javaStateUnreachable(boolean)">javaStateUnreachable</a>, <a href="../internal/DualState.html#lock(boolean)">lock</a>, <a href="../internal/DualState.html#m(T)">m</a>, <a href="../internal/DualState.html#nativeStateReleased(boolean)">nativeStateReleased</a>, <a href="../internal/DualState.html#pin()">pin</a>, <a href="../internal/DualState.html#pinned()">pinned</a>, <a href="../internal/DualState.html#pinnedByCurrentThread()">pinnedByCurrentThread</a>, <a href="../internal/DualState.html#pinnedNoChecked()">pinnedNoChecked</a>, <a href="../internal/DualState.html#pinUnlessReleased()">pinUnlessReleased</a>, <a href="../internal/DualState.html#referent()">referent</a>, <a href="../internal/DualState.html#releasedMessage()">releasedMessage</a>, <a href="../internal/DualState.html#releasedSqlState()">releasedSqlState</a>, <a href="../internal/DualState.html#releaseFromJava()">releaseFromJava</a>, <a href="../internal/DualState.html#unlessReleased(org.postgresql.pljava.internal.Checked.Runnable)">unlessReleased</a>, <a href="../internal/DualState.html#unlock(int)">unlock</a>, <a href="../internal/DualState.html#unlock(int,boolean)">unlock</a>, <a href="../internal/DualState.html#unpin()">unpin</a></code></div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.ref.Reference">Methods inherited from class&nbsp;java.lang.ref.<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html" title="class or interface in java.lang.ref" class="external-link">Reference</a></h3>
<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#clone()" title="class or interface in java.lang.ref" class="external-link">clone</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#isEnqueued()" title="class or interface in java.lang.ref" class="external-link">isEnqueued</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#reachabilityFence(java.lang.Object)" title="class or interface in java.lang.ref" class="external-link">reachabilityFence</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ref/Reference.html#refersTo(T)" title="class or interface in java.lang.ref" class="external-link">refersTo</a></code></div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.Object">Methods inherited from class&nbsp;java.lang.<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></h3>
<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#equals(java.lang.Object)" title="class or interface in java.lang" class="external-link">equals</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#finalize()" title="class or interface in java.lang" class="external-link">finalize</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#getClass()" title="class or interface in java.lang" class="external-link">getClass</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#hashCode()" title="class or interface in java.lang" class="external-link">hashCode</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notify()" title="class or interface in java.lang" class="external-link">notify</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notifyAll()" title="class or interface in java.lang" class="external-link">notifyAll</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait()" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait(long)" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait(long,int)" title="class or interface in java.lang" class="external-link">wait</a></code></div>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2003&#x2013;2025<a href='http://tada.se/eng/'>Tada AB</a></small></p>
</footer>
</div>
</div>
</body>
</html>
