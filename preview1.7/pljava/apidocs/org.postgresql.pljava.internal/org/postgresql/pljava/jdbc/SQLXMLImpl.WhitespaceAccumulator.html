<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (21) on Fri May 30 18:27:09 EDT 2025 -->
<title>SQLXMLImpl.WhitespaceAccumulator (PL/Java backend Java code 1.7-SNAPSHOT)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="dc.created" content="2025-05-30">
<meta name="description" content="declaration: module: org.postgresql.pljava.internal, package: org.postgresql.pljava.jdbc, class: SQLXMLImpl, class: WhitespaceAccumulator">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../script-dir/jquery-ui.min.css" title="Style">
<script type="text/javascript" src="../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top"><button id="navbar-toggle-button" aria-controls="navbar-top" aria-expanded="false" aria-label="Toggle navigation links"><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span><span class="nav-bar-toggle-icon">&nbsp;</span></button>
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../module-summary.html">Module</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/SQLXMLImpl.WhitespaceAccumulator.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html#class">Help</a></li>
</ul>
<ul class="sub-nav-list-small">
<li>
<p>Summary:</p>
<ul>
<li>Nested</li>
<li><a href="#field-summary">Field</a></li>
<li><a href="#constructor-summary">Constr</a></li>
<li><a href="#method-summary">Method</a></li>
</ul>
</li>
<li>
<p>Detail:</p>
<ul>
<li><a href="#field-detail">Field</a></li>
<li><a href="#constructor-detail">Constr</a></li>
<li><a href="#method-detail">Method</a></li>
</ul>
</li>
</ul>
</div>
<div class="sub-nav">
<div id="navbar-sub-list">
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li><a href="#field-summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor-summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-summary">Method</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li><a href="#field-detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor-detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-detail">Method</a></li>
</ul>
</div>
<div class="nav-list-search"><a href="../../../../../search.html">SEARCH</a>
<input type="text" id="search-input" disabled placeholder="Search">
<input type="reset" id="reset-button" disabled value="reset">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="module-label-in-type">Module</span>&nbsp;<a href="../../../../module-summary.html">org.postgresql.pljava.internal</a></div>
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">org.postgresql.pljava.jdbc</a></div>
<h1 title="Class SQLXMLImpl.WhitespaceAccumulator" class="title">Class SQLXMLImpl.WhitespaceAccumulator</h1>
</div>
<div class="inheritance" title="Inheritance Tree"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">java.lang.Object</a>
<div class="inheritance">org.postgresql.pljava.jdbc.SQLXMLImpl.WhitespaceAccumulator</div>
</div>
<section class="class-description" id="class-description">
<dl class="notes">
<dt>Enclosing class:</dt>
<dd><code><a href="SQLXMLImpl.html" title="class in org.postgresql.pljava.jdbc">SQLXMLImpl</a>&lt;<a href="SQLXMLImpl.html" title="type parameter in SQLXMLImpl">V</a> extends <a href="../../../../../../../pljava-api/apidocs/org.postgresql.pljava/org/postgresql/pljava/adt/spi/Datum.html" title="class or interface in org.postgresql.pljava.adt.spi" class="external-link">Datum</a>&gt;</code></dd>
</dl>
<hr>
<div class="type-signature"><span class="modifiers">static class </span><span class="element-name type-name-label">SQLXMLImpl.WhitespaceAccumulator</span>
<span class="extends-implements">extends <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></span></div>
<div class="block">Accumulate whitespace at top level (outside any element) pending
 determination of what to do with it.
<p>
 The handling of whitespace at the top level is a subtle business. Per the
 XML spec "Character Data and Markup" section (in either spec version),
 whitespace is considered, when at the top level, "markup" rather than
 "character data". And the section on "White Space Handling" spells out
 that an XML processor "MUST always pass all characters in a document that
 are not markup through to the application." A sharp-eyed language lawyer
 will see right away that whitespace at the top level does not fall
 under that mandate. (It took me longer.) Indeed, a bit of experimenting
 with a SAX parser will show that it doesn't invoke any handler callbacks
 at all for whitespace at the top level. The whitespace could as well not
 even be there. Some applications rely on that and will report an error if
 the parser shows them any whitespace outside the element they expect.
<p>
 Our application of a wrapping element, to avoid parse errors for the
 <code>XML(CONTENT)</code> form, alters the treatment of whitespace that would
 otherwise have been at the top level. As it will now be inside of
 an element, Java's parser will want to pass it on, and our unwrap filter
 will have to fix that.
<p>
 Complicating matters, our determination whether to apply a wrapping
 element is lazy. It looks only far enough into the start of the stream
 to conclude one of: (1) it is definitely <code>XML(DOCUMENT)</code>,
 (2) it is definitely <code>XML(CONTENT)</code>, or (3) it could be either and
 has to be be wrapped in case it turns out to be <code>XML(CONTENT)</code>.
<p>
 The first two cases are simple. In case (1), we apply no wrapping and
 no filter, and the underlying parser does the right thing. In case (2)
 we know this is not a document, and no whitespace should be filtered out.
<p>
 Case (3) is the tricky one, and as long as PostgreSQL does not store any
 <code>DOCUMENT</code>/<code>CONTENT</code> flag with the value and we have no API
 for the application to say what's expected, unless we are willing to
 pre-parse what could end up being the whole stream just to decide how
 to parse it, we'll have to settle for an approximate behavior.
<p>
 What's implemented here is to handle character data reported by the
 parser, if it is at "top level" (within our added wrapping element), by
 accumulating any whitespace here until we see what comes next.
<p>
 This must be applied above the parser (that is, to character events that
 the parser reports), because it applies the XML definition of whitespace,
 which includes only the four characters " \t\n\r" but recognizes them
 <em>after</em> the parser has normalized various newline styles to '\n'.
 The exact set of those newline styles depends on the XML version, and the
 XML 1.1 set includes non-ASCII characters and therefore depend on the
 parser's knowledge of the input stream encoding.
<p>
 If the character data includes anything other than whitespace, we emit
 it intact including the whitespace, and note that the input is now known
 to be <code>CONTENT</code> and gets no more special whitespace treatment.
<p>
 If all whitespace, and followed by the end of input or by an element that
 is <em>not</em> the first one to be seen, we emit it intact and turn off
 special whitespace handling for the remainder of the stream (if any).
<p>
 If all whitespace and followed by a comment, PI, or the first element
 to be seen it is discarded.
<p>
 This strategy will produce correct results for any case (3) input that
 turns out to be <code>XML(DOCUMENT)</code>. In the case of input that turns
 out to be <code>XML(CONTENT)</code>, it can fail to preserve whitespace ahead
 of the first point where the input is definitely known to be
 <code>CONTENT</code>.
<p>
 That may be good enough for many cases. To cover those where it isn't,
 it may be necessary to offer a nonstandard API to specify what the
 application expects, or observe the PostgreSQL <code>XMLOPTION</code> setting
 in case 3, or both.</div>
</section>
<section class="summary">
<ul class="summary-list">
<!-- =========== FIELD SUMMARY =========== -->
<li>
<section class="field-summary" id="field-summary">
<h2>Field Summary</h2>
<div class="caption"><span>Fields</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Field</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>(package private) int</code></div>
<div class="col-second even-row-color"><code><a href="#m_bufPos" class="member-name-link">m_bufPos</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>(package private) int</code></div>
<div class="col-second odd-row-color"><code><a href="#m_disbursePos" class="member-name-link">m_disbursePos</a></code></div>
<div class="col-last odd-row-color">&nbsp;</div>
<div class="col-first even-row-color"><code>(package private) <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/regex/Matcher.html" title="class or interface in java.util.regex" class="external-link">Matcher</a></code></div>
<div class="col-second even-row-color"><code><a href="#m_matcher" class="member-name-link">m_matcher</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>(package private) byte[]</code></div>
<div class="col-second odd-row-color"><code><a href="#m_rleBuffer" class="member-name-link">m_rleBuffer</a></code></div>
<div class="col-last odd-row-color">&nbsp;</div>
<div class="col-first even-row-color"><code>(package private) static final int</code></div>
<div class="col-second even-row-color"><code><a href="#MAX_RUN" class="member-name-link">MAX_RUN</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>(package private) static final <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/regex/Pattern.html" title="class or interface in java.util.regex" class="external-link">Pattern</a></code></div>
<div class="col-second odd-row-color"><code><a href="#s_wsChunk" class="member-name-link">s_wsChunk</a></code></div>
<div class="col-last odd-row-color">
<div class="block">A Pattern to walk through some character data in runs of the same
 whitespace character, allowing a rudimentary run-length encoding.</div>
</div>
</div>
</section>
</li>
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<li>
<section class="constructor-summary" id="constructor-summary">
<h2>Constructor Summary</h2>
<div class="caption"><span>Constructors</span></div>
<div class="summary-table two-column-summary">
<div class="table-header col-first">Constructor</div>
<div class="table-header col-last">Description</div>
<div class="col-constructor-name even-row-color"><code><a href="#%3Cinit%3E()" class="member-name-link">WhitespaceAccumulator</a>()</code></div>
<div class="col-last even-row-color">&nbsp;</div>
</div>
</section>
</li>
<!-- ========== METHOD SUMMARY =========== -->
<li>
<section class="method-summary" id="method-summary">
<h2>Method Summary</h2>
<div id="method-summary-table">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="method-summary-table-tab0" role="tab" aria-selected="true" aria-controls="method-summary-table.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table', 3)" class="active-table-tab">All Methods</button><button id="method-summary-table-tab2" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab2', 3)" class="table-tab">Instance Methods</button><button id="method-summary-table-tab4" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab4', 3)" class="table-tab">Concrete Methods</button></div>
<div id="method-summary-table.tabpanel" role="tabpanel">
<div class="summary-table three-column-summary" aria-labelledby="method-summary-table-tab0">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Method</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>(package private) int</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#accumulate(char%5B%5D,int,int)" class="member-name-link">accumulate</a><wbr>(char[]&nbsp;content,
 int&nbsp;start,
 int&nbsp;length)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Given an array with reported character data, return -1 if exclusively
 whitespace characters were seen and have been added to the
 accumulator; otherwise return an index into the input array from
 which the caller should emit the tail unprocessed after using
 <a href="#disburse(char%5B%5D)"><code>disburse</code></a> here to emit any earlier-accumulated
 whitespace.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>(package private) int</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#disburse(char%5B%5D)" class="member-name-link">disburse</a><wbr>(char[]&nbsp;into)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Retrieve the accumulated whitespace if it is not to be discarded.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>(package private) void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#discard()" class="member-name-link">discard</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Discard the accumulated whitespace.</div>
</div>
</div>
</div>
</div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.Object">Methods inherited from class&nbsp;java.lang.<a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></h3>
<code><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#clone()" title="class or interface in java.lang" class="external-link">clone</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#equals(java.lang.Object)" title="class or interface in java.lang" class="external-link">equals</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#finalize()" title="class or interface in java.lang" class="external-link">finalize</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#getClass()" title="class or interface in java.lang" class="external-link">getClass</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#hashCode()" title="class or interface in java.lang" class="external-link">hashCode</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notify()" title="class or interface in java.lang" class="external-link">notify</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notifyAll()" title="class or interface in java.lang" class="external-link">notifyAll</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#toString()" title="class or interface in java.lang" class="external-link">toString</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait()" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait(long)" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait(long,int)" title="class or interface in java.lang" class="external-link">wait</a></code></div>
</section>
</li>
</ul>
</section>
<section class="details">
<ul class="details-list">
<!-- ============ FIELD DETAIL =========== -->
<li>
<section class="field-details" id="field-detail">
<h2>Field Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="s_wsChunk">
<h3>s_wsChunk</h3>
<div class="member-signature"><span class="modifiers">static final</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/regex/Pattern.html" title="class or interface in java.util.regex" class="external-link">Pattern</a></span>&nbsp;<span class="element-name">s_wsChunk</span></div>
<div class="block">A Pattern to walk through some character data in runs of the same
 whitespace character, allowing a rudimentary run-length encoding.</div>
</section>
</li>
<li>
<section class="detail" id="MAX_RUN">
<h3>MAX_RUN</h3>
<div class="member-signature"><span class="modifiers">static final</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">MAX_RUN</span></div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="tag-list">
<li><a href="../../../../../constant-values.html#org.postgresql.pljava.jdbc.SQLXMLImpl.WhitespaceAccumulator.MAX_RUN">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="m_rleBuffer">
<h3>m_rleBuffer</h3>
<div class="member-signature"><span class="return-type">byte[]</span>&nbsp;<span class="element-name">m_rleBuffer</span></div>
</section>
</li>
<li>
<section class="detail" id="m_bufPos">
<h3>m_bufPos</h3>
<div class="member-signature"><span class="return-type">int</span>&nbsp;<span class="element-name">m_bufPos</span></div>
</section>
</li>
<li>
<section class="detail" id="m_disbursePos">
<h3>m_disbursePos</h3>
<div class="member-signature"><span class="return-type">int</span>&nbsp;<span class="element-name">m_disbursePos</span></div>
</section>
</li>
<li>
<section class="detail" id="m_matcher">
<h3>m_matcher</h3>
<div class="member-signature"><span class="return-type"><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/regex/Matcher.html" title="class or interface in java.util.regex" class="external-link">Matcher</a></span>&nbsp;<span class="element-name">m_matcher</span></div>
</section>
</li>
</ul>
</section>
</li>
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<li>
<section class="constructor-details" id="constructor-detail">
<h2>Constructor Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="&lt;init&gt;()">
<h3>WhitespaceAccumulator</h3>
<div class="member-signature"><span class="element-name">WhitespaceAccumulator</span>()</div>
</section>
</li>
</ul>
</section>
</li>
<!-- ============ METHOD DETAIL ========== -->
<li>
<section class="method-details" id="method-detail">
<h2>Method Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="accumulate(char[],int,int)">
<h3>accumulate</h3>
<div class="member-signature"><span class="return-type">int</span>&nbsp;<span class="element-name">accumulate</span><wbr><span class="parameters">(char[]&nbsp;content,
 int&nbsp;start,
 int&nbsp;length)</span></div>
<div class="block">Given an array with reported character data, return -1 if exclusively
 whitespace characters were seen and have been added to the
 accumulator; otherwise return an index into the input array from
 which the caller should emit the tail unprocessed after using
 <a href="#disburse(char%5B%5D)"><code>disburse</code></a> here to emit any earlier-accumulated
 whitespace.
<p>
 Java's XML parsing APIs generally do not promise to supply all
 characters of contiguous text in one parse event, so this method
 may be called more than once accumulating whitespace from several
 consecutive events.</div>
</section>
</li>
<li>
<section class="detail" id="disburse(char[])">
<h3>disburse</h3>
<div class="member-signature"><span class="return-type">int</span>&nbsp;<span class="element-name">disburse</span><wbr><span class="parameters">(char[]&nbsp;into)</span></div>
<div class="block">Retrieve the accumulated whitespace if it is not to be discarded.
<p>
 If the caller detects that the whitespace is significant (either
 because <a href="#accumulate(char%5B%5D,int,int)"><code>accumulate</code></a> returned a nonnegative result
 or because the next parse event was a second top-level element or
 the end-event of the wrapping element), the caller should allocate
 a <code>char</code> array of length at least <code>MAX_RUN</code> and supply it
 to this method until zero is returned; for each non-zero value
 returned, that many <code>char</code>s at the head of the array should be
 passed to the application as a character event.
<p>
 After this method has returned zero, if the caller had received a
 non-negative result from <code>accumulate</code>, it should present one
 more character event to the application, containing the tail of the
 the array that was given to <code>accumulate</code>, starting at the index
 <code>accumulate</code> returned.</div>
</section>
</li>
<li>
<section class="detail" id="discard()">
<h3>discard</h3>
<div class="member-signature"><span class="return-type">void</span>&nbsp;<span class="element-name">discard</span>()</div>
<div class="block">Discard the accumulated whitespace.
<p>
 This should be called if some whitespace was successfully accumulated
 (<code>accumulate</code> returned -1) but the following parse event is one
 that must be passed to the application and does not force the input
 to be classified as <code>XML(CONTENT)</code>.</div>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2003&#x2013;2025<a href='http://tada.se/eng/'>Tada AB</a></small></p>
</footer>
</div>
</div>
</body>
</html>
