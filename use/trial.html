<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/markdown/use/trial.md at 2021-10-10

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>PostgreSQL PL/Java &#x2013; Migrating to policy-based permissions from an earlier PL/Java release</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2021-10-10</span>
          &#xA0;| <span id="projectVersion">Version: 1.6.3</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a></li>
     <li class="none"><a href="../install/upgrade.html" title="Upgrading">Upgrading</a></li>
     <li class="none"><a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>Migrating to policy-based permissions from an earlier PL/Java release</h1>
<p>When migrating existing code from a PL/Java 1.5 or earlier release to 1.6, it may be necessary to add permission grants in the new <code>pljava.policy</code> file, which grants few permissions by default. PL/Java&#x2019;s security policy configuration is described <a href="policy.html">here</a>.</p>
<p>To simplify migration, it is possible to run with a &#x2018;trial&#x2019; policy initially, allowing code to run but logging permissions that may need to be added in <code>pljava.policy</code>.</p><section>
<h2><a name="Configuring_a_trial_policy"></a>Configuring a trial policy</h2>
<p>Even when running with a trial policy, the <a href="variables.html">configuration variable</a> <code>pljava.policy_urls</code> should point to the normal policy file(s), as usual. That is where the ultimate policy for production will be developed.</p>
<p>The trial policy is configured by creating another policy file somewhere, using the same policy file syntax, and pointing to it with <code>-Dorg.postgresql.pljava.policy.trial=</code><i>url</i> added to the configuration variable <code>pljava.vmoptions</code>.</p>
<p>Anything <i>this</i> policy allows will be allowed, but will be logged if the regular policy would have denied it. So you can make this one more generous than the regular policy, and use the log entries to identify grants that might belong in the regular policy. As you add the missing ones to the real policy, they stop getting logged by this one, and the log gets quieter. You can make this one as generous as you are comfortable making it during the period of testing and tuning.</p>
<p>At the very extreme of generosity it could be this:</p>

<div class="source">
<div class="source">
<pre>grant {
  permission java.security.AllPermission;
};
</pre></div></div>

<p>and it would happily allow the code under test to do <i>anything at all</i>, while logging whatever permissions aren&#x2019;t in the regular policy. (A side effect of this would be to erase any distinction between <code>java</code> and <code>javaU</code> for as long as the trial policy is in place.) Such a setting would be difficult to recommend in general, but it might suffice if the only code being tested has already been in use for years under PL/Java 1.5 and is well trusted, users of the database have not been granted permission to install more PL/Java functions, and if the purpose of testing is only to learn what permissions the code uses that may need to be granted in the 1.6 policy.</p><section>
<h3><a name="Granting_TrialPolicy.24Permission"></a>Granting <code>TrialPolicy$Permission</code></h3>
<p>When <code>AllPermission</code> is too broad, there is the difficulty that Java&#x2019;s permission model does not have a subtractive mode; it is not simple to say &#x201c;grant <code>AllPermission</code> except for this list of the ones I&#x2019;d really rather not.&#x201d; Therefore, PL/Java offers a custom &#x201c;meta-permission&#x201d; with roughly that meaning:</p>

<div class="source">
<div class="source">
<pre>grant {
  permission org.postgresql.pljava.policy.TrialPolicy$Permission;
};
</pre></div></div>

<p><code>TrialPolicy$Permission</code>  is effectively <code>AllPermission</code> but excluding any <code>FilePermission</code> (so that <code>java</code>/<code>javaU</code> distinction stays meaningful) as well as a couple dozen other various <code>SecurityPermission</code>/<code>ReflectPermission</code>/<code>RuntimePermission</code> instances in the &#x201c;really rather not&#x201d; category. If its hard-coded exclusion list excludes any permissions that some unusual code under test might legitimately need, those can be explicitly added to the trial policy too.</p>
<p>Configuring a trial policy can be a bit of a balancing act: if it is very generous, that minimizes the chance of breaking the code under test because of a denied permission, but increases potential exposure if that code misbehaves. A more limited trial policy decreases exposure but increase the risk of service interruption if the code under test really does need some permission that you weren&#x2019;t comfortable putting in the trial policy. Somewhere near the sweet spot is where <code>TrialPolicy$Permission</code> is aimed.</p>
<p>All other normal policy features also work in the trial policy. If your code is installed in several different jars, you can use <code>grant codebase</code> separately to put different outer limits around different jars, and completely remove the grants for one jar after another as you are satisfied you have added the right things for each one in the regular policy. You could also set different limits for <code>java</code> and <code>javaU</code> by granting to the <code>PLPrincipal</code>, just as you can in the regular policy.</p></section></section><section>
<h2><a name="About_false_positives"></a>About false positives</h2>
<p>One thing to be aware of is that the trial policy can give false alarms. It is not uncommon for software to include configuration-dependent bits that tentatively try certain actions, catch exceptions, and then proceed normally, having discovered what the configuration allows. The trial policy can log permission denials that happen in the course of such checks, even if the denial has no functional impact on the code.</p>
<p>There may be no perfect way to tell which denials being logged by the trial policy are false alarms. One approach would be to collect a sampling of log entries, figure out what user-visible functions of the code they were coming from, and then start a dedicated session without the <code>-Dorg.postgresql.pljava.policy.trial</code> setting (or with it pointing to a different, more restrictive version of the policy, not granting the permissions you&#x2019;re curious about), then exercise those functions of the code and see if anything breaks. Other users could still have the more generous trial setting in their sessions, so as not to be affected by your experiments.</p>
<p>False positives, of course, are also affected by the choice of how generous to make the trial policy. Log entries are only produced for permissions that the regular policy denies but the trial policy allows. If the permissions being silently checked by benign code are not granted in the trial policy, they will be silently denied, just as they would in normal operation, and produce no log entries.</p></section><section>
<h2><a name="Format_of_the_log_entries"></a>Format of the log entries</h2>
<p>To avoid bloating logs too much, <code>TrialPolicy</code> emits an abbreviated form of stack trace for each entry. The approach is to keep one stack frame above and one below each crossing of a module or protection-domain boundary, with <code>...</code> replacing intermediate frames within the same module/domain, and the code source/principals of the denied domain shown wrapped in <code>&gt;&gt; &lt;&lt;</code>at the appropriate position in the trace. For the purpose of identifying the source of a permission request and the appropriate domain(s) to be granted the permission, this is probably more usable than the very long full traces available with <code>java.security.debug</code>.</p>
<p>The messages are sent through the PostgreSQL log if the thread making the permission check knows it can do so without blocking; otherwise they just go to standard error, which should wind up in the PostgreSQL log anyway, if <code>logging_collector</code> is on; otherwise it may be system-dependent where they go.</p>
<p>There isn&#x2019;t really a reliable &#x201c;can I do so without blocking?&#x201d; check for every setting of the <code>pljava.java_thread_pg_entry</code> configuration variable. If it is set to <code>throw</code> (and that is a workable setting for the code under test), the logging behavior will be more predictable; entries from the main thread will go through PostgreSQL&#x2019;s log facility always, and those from any other thread will go to standard error.</p>
<p>Here is an example of two log entries, generated by the same permission check:</p>

<div class="source">
<div class="source">
<pre>POLICY DENIES/TRIAL POLICY ALLOWS: (&quot;java.net.SocketPermission&quot; &quot;127.0.0.1:5432&quot; &quot;connect,resolve&quot;)
java.base/java.security.ProtectionDomain.implies(ProtectionDomain.java:321)
...
java.base/java.net.Socket.&lt;init&gt;(Socket.java:294)
&gt;&gt; null [PLPrincipal.Sandboxed: java] &lt;&lt;
jdk.translet/die.verwandlung.GregorSamsa.template$dot$0()
...
jdk.translet/die.verwandlung.GregorSamsa.transform()
java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.transform(AbstractTranslet.java:624)
...
java.xml/com.sun.org.apache.xalan.internal.xsltc.trax.TransformerImpl.transform(TransformerImpl.java:383)
schema:public//org.postgresql.pljava.example.annotation.PassXML.transformXML(PassXML.java:561)

POLICY DENIES/TRIAL POLICY ALLOWS: (&quot;java.net.SocketPermission&quot; &quot;127.0.0.1:5432&quot; &quot;connect,resolve&quot;)
java.base/java.security.ProtectionDomain.implies(ProtectionDomain.java:321)
...
java.base/java.net.Socket.&lt;init&gt;(Socket.java:294)
jdk.translet/die.verwandlung.GregorSamsa.template$dot$0()
...
jdk.translet/die.verwandlung.GregorSamsa.transform()
java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.transform(AbstractTranslet.java:624)
...
java.xml/com.sun.org.apache.xalan.internal.xsltc.trax.TransformerImpl.transform(TransformerImpl.java:383)
&gt;&gt; sqlj:examples [PLPrincipal.Sandboxed: java] &lt;&lt;
schema:public//org.postgresql.pljava.example.annotation.PassXML.transformXML(PassXML.java:561)
</pre></div></div>

<p>The example shows the use of an XSLT 1.0 transform that appears to make use of the Java XSLT ability to call out to arbitrary Java, and is trying to make a network connection back to PostgreSQL on <code>localhost</code>. Java&#x2019;s XSLTC implementation compiles the transform to a class in <code>jdk.translet</code> with null as its codebase, and the first log entry shows permission is denied at that level (the protection domain shown as <code>&gt;&gt; null [PLPrincipal.Sandboxed: java] &lt;&lt;</code>).</p>
<p>A second log entry results because <code>TrialPolicy</code> turns the first failure to success, allowing the permission check to continue, and it next fails at the PL/Java function being called, in the <code>sqlj:examples</code> jar. Under the trial policy, that also is logged and then allowed to succeed.</p>
<p>The simplest way to allow this connection in the production policy would be to grant the needed <code>java.net.SocketPermission</code> to <code>PLPrincipal$Sandboxed</code>, as that is present in both denied domains. It would be possible to grant the permission by codebase to <code>sqlj:examples</code> instead, but not to the nameless codebase of the compiled XSLT transform.</p></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2021<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
