<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2018-10-17 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>PostgreSQL PL/Java &#x2013; Mapping between PostgreSQL and Java date/time types</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20181017" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean">
                                                <img src="../images/pljava_logo.jpg" alt="PL/Java logo combining the PostgreSQL elephant and a Java bean" />
                </a>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2018-10-17</span>
                  &nbsp;| <span id="projectVersion">Version: 1.5.1</span>
                      </div>
            <div class="xright">                    <a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a>
            |
                        <a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a>
            |
                        <a href="http://lists.pgfoundry.org/pipermail/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a>
            |
                        <a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Usage</h5>
                  <ul>
                  <li class="none">
                          <a href="../build/build.html" title="Building PL/Java">Building PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a>
            </li>
                  <li class="none">
                          <a href="../install/upgrade.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../use/use.html" title="User guide">User guide</a>
            </li>
                  <li class="none">
                          <a href="../develop/develop.html" title="Developer notes">Developer notes</a>
            </li>
          </ul>
                       <h5>Release Information</h5>
                  <ul>
                  <li class="none">
                          <a href="../releasenotes.html" title="Release notes">Release notes</a>
            </li>
          </ul>
                       <h5>Modules</h5>
                  <ul>
                  <li class="none">
                          <a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a>
            </li>
                  <li class="none">
                          <a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-deploy/index.html" title="PL/Java Deploy">PL/Java Deploy</a>
            </li>
                  <li class="none">
                          <a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a>
            </li>
                  <li class="none">
                          <a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a>
            </li>
                  <li class="none">
                          <a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>Mapping between PostgreSQL and Java date/time types</h1>
<div class="section">
<h2><a name="Legacy_JDBC_mappings"></a>Legacy JDBC mappings</h2>
<p>The first mappings to be specified in JDBC used the JDBC-specific classes <tt>java.sql.Date</tt>, <tt>java.sql.Time</tt>, and <tt>java.sql.Timestamp</tt>, all of which are based on <tt>java.util.Date</tt> (but only as an implementation detail; they should always be treated as their own types and not as instances of <tt>java.util.Date</tt>).</p>
<p>PL/Java function parameters and returns can be declared in Java to have those types, objects of those types can be passed to <tt>PreparedStatement.setObject</tt>, <tt>ResultSet.updateObject</tt>, and <tt>SQLOutput.writeObject</tt> methods, as well as to the methods that are specific to those types. The JDBC <tt>getObject</tt> and <tt>readObject</tt> methods that do not take a <tt>Class&lt;?&gt;</tt> parameter will return objects of those types when retrieving PostgreSQL date or time values.</p>
<div class="section">
<h3><a name="Shortcomings"></a>Shortcomings</h3>
<p>Those classes have never been a good representation for PostgreSQL date/time values, because they are based on <tt>java.util.Date</tt>, which implies knowledge of a time zone, even when they are used to represent PostgreSQL values with no time zone at all. For all of these conversions but one, PL/Java must do time zone computations, with the one exception being, unintuitively, <tt>timestamp with time
zone</tt>. The conversions of non-zoned values involve a hidden dependency on the PostgreSQL session&#x2019;s current setting of <tt>TimeZone</tt>, which can vary from session to session at the connecting client&#x2019;s preference.</p></div></div>
<div class="section">
<h2><a name="Java_8__JDBC_4.2_datetime_mappings"></a>Java 8 / JDBC 4.2 date/time mappings</h2>
<p>Java 8 introduced the much improved set of date/time classes in the <tt>java.time</tt> package specified by <a class="externalLink" href="https://www.threeten.org/">JSR 310</a>. JDBC 4.2 (the version in Java 8) allows those as alternate Java class mappings of the SQL types <tt>date</tt>, <tt>time</tt> (with and without timezone), and <tt>timestamp</tt> (with/without timezone). These new types are a much better fit to the corresponding PostgreSQL types than the original JDBC <tt>java.sql</tt> <tt>Date</tt>/<tt>Time</tt>/<tt>Timestamp</tt> classes.</p>
<p>To avoid a breaking change, JDBC 4.2 does not modify what any of the pre-existing JDBC API does by default. The <tt>getDate</tt>, <tt>getTime</tt>, and <tt>getTimestamp</tt> methods on a <tt>ResultSet</tt> still return the same <tt>java.sql</tt> types, and so does <tt>getObject</tt> in the form that does not specify a class. Instead, the update takes advantage of the general purpose <tt>ResultSet.getObject</tt> methods that take a <tt>Class&lt;?&gt;</tt> parameter (added in JDBC 4.1), and likewise the <tt>SQLInput.readObject</tt> method with a <tt>Class&lt;?&gt;</tt> parameter (overlooked in 4.1 but added in 4.2), so a caller can request a <tt>java.time</tt> class by passing the right <tt>Class</tt>:</p>

<table border="0" class="bodyTable"><caption>Correspondence of PostgreSQL date/time types and Java 8 <tt>java.time</tt> classes</caption>
  <thead>
    
<tr class="a">
      
<th align="right">PostgreSQL type </th>
      
<th align="left">Pass to <tt>getObject</tt>/<tt>readObject</tt> </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td align="right"><tt>date</tt></td>
      
<td align="left"><tt>java.time.LocalDate.class</tt></td>
    </tr>
    
<tr class="a">
      
<td align="right"><tt>time without time zone</tt></td>
      
<td align="left"><tt>java.time.LocalTime.class</tt></td>
    </tr>
    
<tr class="b">
      
<td align="right"><tt>time with time zone</tt></td>
      
<td align="left"><tt>java.time.OffsetTime.class</tt></td>
    </tr>
    
<tr class="a">
      
<td align="right"><tt>timestamp without time zone</tt></td>
      
<td align="left"><tt>java.time.LocalDateTime.class</tt></td>
    </tr>
    
<tr class="b">
      
<td align="right"><tt>timestamp with time zone</tt></td>
      
<td align="left"><tt>java.time.OffsetDateTime.class</tt></td>
    </tr>
  </tbody>
  
</table>
<p>The <tt>java.time</tt> types can also be used as parameter and return types of PL/Java functions without special effort (the generated function declarations will make the right conversions happen), and passed to the setter methods of prepared statements, writable result sets (for triggers or composite-returning functions), and <tt>SQLOutput</tt> for UDTs.</p>
<p>Conversions to and from these types never involve the PostgreSQL session time zone, which can vary from session to session. Any code developed for PL/Java and Java 8 or newer is strongly encouraged to use these types for date/time manipulations, for their much better fit to the PostgreSQL types.</p>
<div class="section">
<h3><a name="Mapping_of_time_and_timestamp_with_time_zone"></a>Mapping of time and timestamp with time zone</h3>
<p>When a <tt>time with time zone</tt> is mapped to a <tt>java.time.OffsetTime</tt>, the Java value will have a zone offset equal to the one assigned to the value in PostgreSQL, and so in the reverse direction.</p>
<p>When a <tt>timestamp with time zone</tt> is mapped to a <tt>java.time.OffsetDateTime</tt>, the Java value will always have a zone offset of zero (UTC). When an <tt>OffsetDateTime</tt> created in Java is mapped to a PostgreSQL <tt>timestamp with time zone</tt>, if its offset is not zero, the value adjusted to UTC is used.</p>
<p>These different behaviors accurately reflect how PostgreSQL treats the two types differently.</p></div>
<div class="section">
<h3><a name="Infinite_dates_and_timestamps"></a>Infinite dates and timestamps</h3>
<p>PostgreSQL allows <tt>date</tt> and <tt>timestamp</tt> (with or without time zone) values of <tt>infinity</tt> and <tt>-infinity</tt>.</p>
<p>There is no such notion in the corresponding Java classes (the original JDBC ones or the JDBC 4.2 / JSR 310 ones), but PL/Java will map those PostgreSQL values repeatably to certain values of the Java classes, and will map Java objects with those exact values back to PostgreSQL <tt>infinity</tt> or <tt>-infinity</tt> on the return trip. Java code that needs to recognize those values could do an initial query returning <tt>infinity</tt> and <tt>-infinity</tt> and save the resulting Java values to compare others against. It must compare with <tt>equals()</tt>; it cannot assume that the mapping will produce the very same Java objects repeatedly, but only objects with equal values.</p>
<p>When timestamps are mapped to the <tt>java.time</tt> classes, the mapping will have the useful property that <tt>-infinity</tt> really is earlier than other PostgreSQL-representable values, and <tt>infinity</tt> really is later. That does not hold under the old <tt>java.sql.Timestamp</tt> mapping, where both values will be distant from the present but not further specified.</p>
<p>The convenient relation does not hold for dates at all, under the <tt>java.sql</tt> or <tt>java.time</tt> mappings; <tt>infinity</tt> and <tt>-infinity</tt> just have to be treated as two special values. They come out as two consecutive days in the late Miocene, as it happens, in the third week of June.</p>
<div class="section">
<h4><a name="Infinite_timestamps_without_integer_datetimes"></a>Infinite timestamps without <tt>integer_datetimes</tt></h4>
<p>In PostgreSQL builds with <tt>integer_datetimes</tt> as <tt>off</tt> (a configuration that is non-default since PostgreSQL 8.4, and impossible since PG 10), an error results if a timestamp being converted to Java has either infinite value. As uses of infinite timestamps are probably rare and the configuration is long out of use, there is no plan to lift this limitation unless an issue is opened to address a practical need.</p></div></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2003&#x2013;2018
                        <a href="http://tada.se/eng/">Tada AB</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
