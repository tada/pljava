<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/use/hello.md.vm at 2024-10-19

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>PostgreSQL PL/Java &#x2013; The obligatory Hello example</title>
    <link rel="stylesheet" href="../css/maven-base.css" />
    <link rel="stylesheet" href="../css/maven-theme.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean"><img src="../images/pljava_logo.jpg"  alt="PL/Java logo combining the PostgreSQL elephant and a Java bean"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2024-10-19</span>
           | <span id="projectVersion">Version: 1.6.8</span>
      </div>
      <div class="xright"><a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a> |
<a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a> |
<a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a> |
<a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Usage</h5>
    <ul>
     <li class="none"><a href="../build/build.html" title="Building PL/Java">Building PL/Java</a></li>
     <li class="none"><a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a></li>
     <li class="none"><a href="../install/upgrade.html" title="Upgrading">Upgrading</a></li>
     <li class="none"><a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a></li>
     <li class="none"><a href="../use/use.html" title="User guide">User guide</a></li>
     <li class="none"><a href="../develop/develop.html" title="Developer notes">Developer notes</a></li>
    </ul>
       <h5>Release Information</h5>
    <ul>
     <li class="none"><a href="../releasenotes.html" title="Release notes">Release notes</a></li>
    </ul>
       <h5>Modules</h5>
    <ul>
     <li class="none"><a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a></li>
     <li class="none"><a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a></li>
     <li class="none"><a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a></li>
     <li class="none"><a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a></li>
     <li class="none"><a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a></li>
     <li class="none"><a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a></li>
     <li class="none"><a href="../pljava-pgxs/index.html" title="PL/Java PGXS">PL/Java PGXS</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<h1>The obligatory Hello example</h1>
<p>Every employee of <code>example.com</code> is required to write a function that says
<code>Hello, world!</code>. There is no escape from this requirement. This page is
dedicated to all those <code>example.com</code> employees faced with that terrible task.</p><section>
<h2><a name="The_goal"></a>The goal</h2>
<p>Clearly, a function that only returns <code>Hello, world!</code> is useless for
illustrating how to pass parameters. So, the goal will be a function
that works like this:</p>

<div class="source">
<pre><code class="language-sql"># \df
                           List of functions
 Schema | Name  | Result data type  |   Argument data types    |  Type  
--------+-------+-------------------+--------------------------+--------
 public | hello | character varying | towhom character varying | normal
(1 row)
# select hello('world');
     hello     
---------------
 Hello, world!
(1 row)
</code></pre></div></section><section>
<h2><a name="A_start:_the_Java_program"></a>A start: the Java program</h2>
<p>Employees of <code>example.com</code> never forget to put their Java code in a package
that begins with <code>com.example</code>, so very quickly this program takes shape:</p>

<div class="source">
<pre><code class="language-java">package com.example.proj;

public class Hello {

  public static String hello(String toWhom) {
    return &quot;Hello, &quot; + toWhom + &quot;!&quot;;
  }

}
</code></pre></div></section><section>
<h2><a name="How_to_build_it:_a_Maven_project"></a>How to build it: a Maven project</h2>
<p>Such a small program might not need a build system like Maven, but like any
project, the requirements could grow over time, so it might as well be set up
right from the beginning.</p>
<p>In preparation, PL/Java must have been built, using the command
<code>mvn clean install</code>. Recall from the <a href="../install/install.html">installation</a> page that
the <code>install</code> Maven goal has nothing to do with installing PL/Java into
PostgreSQL, but <i>does</i> register PL/Java in your Maven
repository. With that done, any project of your own needs only declare
<code>pljava-api</code> as a dependency, and Maven can compile and package it for you.</p><section>
<h3><a name="The_POM_file"></a>The POM file</h3>
<p>The project begins as an empty directory (named <code>proj</code> in this example),
and the first thing to go in that directory is a <code>pom.xml</code> file. The
Project Object Model is what tells Maven all it needs to know about
this project. It is XML and verbose, and more lines than the Hello program
itself! But it is mostly unchanging boilerplate and, as you can see, only
has a few places to change for information specific to the project.</p>
<p>An important Maven feature is POM inheritance. In an organization with many
similar projects, there might be one <code>pom.xml</code> like this one, and many
individual projects with shorter <code>pom.xml</code> files naming this as the parent.</p>

<div class="source">
<pre><code class="language-xml">&lt;project
 xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
 xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
 xsi:schemaLocation=
 &quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;
&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;!-- Above is all boilerplate. Next: your project's &quot;Maven coordinates&quot; --&gt;

  &lt;groupId&gt;com.example&lt;/groupId&gt;
  &lt;artifactId&gt;proj&lt;/artifactId&gt;
  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;

  &lt;!-- Coordinates are nice, but so are names and descriptions for humans. --&gt;

  &lt;name&gt;Hello in PL/Java&lt;/name&gt;
  &lt;description&gt;Project that provides a Hello function&lt;/description&gt;

  &lt;!--
    Many Maven plugins care what character set encoding your files are in.
    For this example I've chosen the most restrictive (US-ASCII). Change if
    your files use a different encoding, but be sure not to lie. You should
    be sure the encoding named here IS the way your source files are coded.
  --&gt;
  
  &lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;US-ASCII&lt;/project.build.sourceEncoding&gt;
  &lt;/properties&gt;

  &lt;!-- Here's where you say your project depends on a pljava-api version. --&gt;

  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
      &lt;artifactId&gt;pljava-api&lt;/artifactId&gt;
      &lt;version&gt;1.6.8&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;

  &lt;!-- The rest here is pretty much boilerplate. --&gt;

  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
        &lt;version&gt;3.10.1&lt;/version&gt;
        &lt;configuration&gt;
          &lt;release&gt;9&lt;/release&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
        &lt;version&gt;3.3.0&lt;/version&gt;
        &lt;configuration&gt;
          &lt;archive&gt;
            &lt;manifest&gt;
              &lt;!-- This identifies and version-stamps the jar.
                 Not essential, but easy and useful. --&gt;
              &lt;addDefaultImplementationEntries&gt;
                true
              &lt;/addDefaultImplementationEntries&gt;
            &lt;/manifest&gt;

            &lt;manifestSections&gt;
              &lt;!-- This identifies a file in the jar named
                 pljava.ddr as an SQLJDeploymentDescriptor. --&gt;
              &lt;manifestSection&gt;
                &lt;name&gt;pljava.ddr&lt;/name&gt;
                &lt;manifestEntries&gt;
                  &lt;SQLJDeploymentDescriptor&gt;
                    true
                  &lt;/SQLJDeploymentDescriptor&gt;
                &lt;/manifestEntries&gt;
              &lt;/manifestSection&gt;
            &lt;/manifestSections&gt;
          &lt;/archive&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;
&lt;/project&gt;
</code></pre></div>
<p>So far, so good. There is a new <code>proj</code> directory with only this <code>pom.xml</code> file
in it:</p>

<div class="source">
<pre><code>proj
   | pom.xml
</code></pre></div>
<p>What happens if <code>mvn clean package</code> is run in this directory, even before
any Java code has been written?</p>

<div class="source">
<pre><code>[WARNING] JAR will be empty - no content was marked for inclusion!
[INFO] Building jar: /var/tmp/proj/target/proj-0.0.1-SNAPSHOT.jar
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
</code></pre></div>
<p>Now there is a <code>target</code> subdirectory with something in it:</p>

<div class="source">
<pre><code>proj
   | pom.xml
   | target
          | proj-0.0.1-SNAPSHOT.jar
</code></pre></div>
<p>Although Maven warned the jar would be empty, in fact it is not <i>completely</i>
empty:</p>

<div class="source">
<pre><code>$ jar tf target/proj-0.0.1-SNAPSHOT.jar 
META-INF/
META-INF/MANIFEST.MF
META-INF/maven/
META-INF/maven/com.example/
META-INF/maven/com.example/proj/
META-INF/maven/com.example/proj/pom.xml
META-INF/maven/com.example/proj/pom.properties
</code></pre></div>
<p>It has a manifest file, and a couple of files Maven adds to save information
about the build. What is in the manifest?</p>

<div class="source">
<pre><code>$ unzip -c target/proj-0.0.1-SNAPSHOT.jar META-INF/MANIFEST.MF
Manifest-Version: 1.0
Implementation-Title: Hello in PL/Java
Implementation-Version: 0.0.1-SNAPSHOT
Implementation-Vendor-Id: com.example

Name: pljava.ddr
SQLJDeploymentDescriptor: true
</code></pre></div>
<p>Clearly, Maven did what the POM told it to do. It created a manifest with
naming and version information for the project, and declaring that the file
<code>pljava.ddr</code> (if there were such a file in the jar) is special because it is
an <a class="externalLink" href="https://github.com/tada/pljava/wiki/Sql-deployment-descriptor">SQLJ deployment descriptor</a>.</p>
<p><b>This proves that Maven can successfully build an empty project with no code!</b></p></section><section>
<h3><a name="Adding_the_Java_code"></a>Adding the Java code</h3>
<p>Maven has a <i>convention over configuration</i> philosophy: it has strict
expectations of how the project directories will be laid out, and if those
expectations are followed, it knows what to do, without need to add more
information in the POM. Sources go in <code>src</code>, and they are split between <code>main</code>
and <code>test</code> for sources that are only built for tests. Sources written in Java
go in a <code>java</code> subdirectory. So, the Java class that was shown earlier could be
saved as <code>Hello.java</code>, here:</p>

<div class="source">
<pre><code>proj
   | pom.xml
   | src
   |   | main
   |        | java
   |             | Hello.java
   | target
          | proj-0.0.1-SNAPSHOT.jar
</code></pre></div>
<p>After running <code>mvn clean package</code> again, what is now in the jar?</p>

<div class="source">
<pre><code>$ jar tf target/proj-0.0.1-SNAPSHOT.jar 
META-INF/
META-INF/MANIFEST.MF
com/
com/example/
com/example/proj/
com/example/proj/Hello.class
META-INF/maven/
META-INF/maven/com.example/
META-INF/maven/com.example/proj/
META-INF/maven/com.example/proj/pom.xml
META-INF/maven/com.example/proj/pom.properties
</code></pre></div>
<p>This is good progress. The class file is placed in the jar at its correct,
package-based path, even though the Java file was saved directly in
<code>src/main/java</code>. That is convenient for such a small project. A larger project
with many classes would probably organize the source files into package-based
subdirectories of <code>src/main/java</code> also.</p>
<p>But something is still missing from this jar. It does not contain any
<code>pljava.ddr</code> file to tell PL/Java what to do when loading it.</p></section><section>
<h3><a name="Annotating_the_Java_code"></a>Annotating the Java code</h3>
<p>That can be fixed by adding two lines to the Java code:</p>

<div class="source">
<pre><code class="language-java">package com.example.proj;

import org.postgresql.pljava.annotation.Function;

public class Hello {

  @Function
  public static String hello(String toWhom) {
    return &quot;Hello, &quot; + toWhom + &quot;!&quot;;
  }

}
</code></pre></div>
<p>The <a href="../pljava-api/apidocs/org.postgresql.pljava/org/postgresql/pljava/annotation/Function.html">@Function annotation</a> declares that the <code>hello</code> function should
be available from SQL, so a <code>pljava.ddr</code> file will be added to the jar,
containing the SQL commands to make that happen.</p>
<p>One more try with <code>mvn clean package</code> and there it is:</p>

<div class="source">
<pre><code>$ jar tf target/proj-0.0.1-SNAPSHOT.jar 
META-INF/
META-INF/MANIFEST.MF
com/
com/example/
com/example/proj/
com/example/proj/Hello.class
pljava.ddr
META-INF/maven/
META-INF/maven/com.example/
META-INF/maven/com.example/proj/
META-INF/maven/com.example/proj/pom.xml
META-INF/maven/com.example/proj/pom.properties
</code></pre></div>
<p>Curious about what is <i>in</i> the <code>pljava.ddr</code> file?</p>

<div class="source">
<pre><code>$ unzip -c target/proj-0.0.1-SNAPSHOT.jar pljava.ddr
SQLActions[]={
&quot;BEGIN INSTALL
BEGIN PostgreSQL
CREATE OR REPLACE FUNCTION hello(
	toWhom pg_catalog.varchar)
	RETURNS pg_catalog.varchar
	LANGUAGE java VOLATILE
	AS 'java.lang.String=com.example.proj.Hello.hello(java.lang.String)'
END PostgreSQL;
END INSTALL&quot;,
&quot;BEGIN REMOVE
BEGIN PostgreSQL
DROP FUNCTION hello(
	toWhom pg_catalog.varchar)
END PostgreSQL;
END REMOVE&quot;
}
</code></pre></div>
<p>There you have it. A jar file containing the new class, and the instructions
PL/Java needs when installing or removing it.</p></section></section><section>
<h2><a name="Using_the_jar_in_PostgreSQL"></a>Using the jar in PostgreSQL</h2>
<p>The time has come to load this jar file into PostgreSQL and try it out!
Within PL/Java, each jar has a short name; this one can be <code>myjar</code>. The
final <code>true</code> parameter to <code>install_jar</code> means that the deployment descriptor
commands should be used.</p>

<div class="source">
<pre><code class="language-sql"># select sqlj.install_jar(
  'file:/home/me/proj/target/proj-0.0.1-SNAPSHOT.jar', 'myjar', true);
 install_jar 
-------------
 
(1 row)
</code></pre></div>
<p>The result returned by <code>install_jar</code> isn't very interesting, but it does not
show an error, so is the function ready to use?</p>

<div class="source">
<pre><code class="language-sql"># \df
                           List of functions
 Schema | Name  | Result data type  |   Argument data types    |  Type  
--------+-------+-------------------+--------------------------+--------
 public | hello | character varying | towhom character varying | normal
(1 row)
# select hello('world');
ERROR:  java.lang.ClassNotFoundException: com.example.proj.Hello
</code></pre></div>
<p>Not so fast! In PL/Java, there is a classpath for every schema. (This is
not quite what the SQL-JRT standard intended, but it is manageable for
some related functions grouped into a schema.) The <code>hello</code> function was put
into the <code>public</code> schema. Why could the class not be found?</p>

<div class="source">
<pre><code class="language-sql"># select sqlj.get_classpath('public');
 get_classpath 
---------------
 
(1 row)
</code></pre></div>
<p>An empty classpath would have that effect. The short name <code>myjar</code> should be
added.</p>

<div class="source">
<pre><code class="language-sql"># select sqlj.set_classpath('public', 'myjar');
 set_classpath 
---------------
 
(1 row)

# select hello('world');
     hello     
---------------
 Hello, world!
(1 row)
</code></pre></div>
<p><b>Success!</b></p><section>
<h3><a name="One_or_two_refinements"></a>One or two refinements</h3>
<p>The function says hello, but it also does this:</p>

<div class="source">
<pre><code class="language-sql"># select hello(null);
    hello     
--------------
 Hello, null!
(1 row)
</code></pre></div>
<p>The function has not been written to notice when the parameter is null.
In this case, Java substitutes the word <code>null</code> and nothing worse happens,
but perhaps the function should do something different. If the function
should <i>return</i> null whenever a parameter is null, there is no need to
even add any code to the function. It can be annotated to declare that
behavior, and then PostgreSQL will consider it to return null <i>without
even calling the function</i> any time a parameter is null.</p>

<div class="source">
<pre><code class="language-java">  @Function(onNullInput=Function.OnNullInput.RETURNS_NULL)
  public static String hello(String toWhom) {
  ...
</code></pre></div>
<p>Another optimization suggests itself because the <code>hello</code> function has
no side effects, and its result depends on nothing except the parameter passed
to it. By default, functions are assumed to possibly have side effects, depend
on database contents or outside influences, and otherwise be harder to reason
about. The PostgreSQL optimizer will be helped if this function is declared
<code>IMMUTABLE</code>. That leads to a program like this:</p>

<div class="source">
<pre><code class="language-java">package com.example.proj;

import org.postgresql.pljava.annotation.Function;

import static org.postgresql.pljava.annotation.Function.Effects.IMMUTABLE;
import static
  org.postgresql.pljava.annotation.Function.OnNullInput.RETURNS_NULL;

public class Hello {

  @Function(onNullInput=RETURNS_NULL, effects=IMMUTABLE)
  public static String hello(String toWhom) {
    return &quot;Hello, &quot; + toWhom + &quot;!&quot;;
  }

}
</code></pre></div></section></section><section>
<h2><a name="Further_reading"></a>Further reading</h2>
<p>From here, consider:</p>
<ul>

<li>The documentation for <a href="../pljava-api/apidocs/org.postgresql.pljava/org/postgresql/pljava/annotation/Function.html">@Function</a> and the rest of the
<a href="../pljava-api/apidocs/index.html?org/postgresql/pljava/package-summary.html#package_description">PL/Java API</a></li>
<li>The user guide pages <a class="externalLink" href="https://github.com/tada/pljava/wiki/User-guide">on the wiki</a></li>
<li>The many pre-built <a href="../examples/examples.html">examples</a></li>
</ul></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2003&#x2013;2024<a href="http://tada.se/eng/">Tada AB</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
