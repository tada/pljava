<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2019-11-03 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>PostgreSQL PL/Java &#x2013; XML view of non-XML data</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20191103" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean">
                                                <img src="../images/pljava_logo.jpg" alt="PL/Java logo combining the PostgreSQL elephant and a Java bean" />
                </a>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2019-11-03</span>
                  &nbsp;| <span id="projectVersion">Version: 1.5.5</span>
                      </div>
            <div class="xright">                    <a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a>
            |
                        <a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a>
            |
                        <a href="http://lists.pgfoundry.org/pipermail/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a>
            |
                        <a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Usage</h5>
                  <ul>
                  <li class="none">
                          <a href="../build/build.html" title="Building PL/Java">Building PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a>
            </li>
                  <li class="none">
                          <a href="../install/upgrade.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../use/use.html" title="User guide">User guide</a>
            </li>
                  <li class="none">
                          <a href="../develop/develop.html" title="Developer notes">Developer notes</a>
            </li>
          </ul>
                       <h5>Release Information</h5>
                  <ul>
                  <li class="none">
                          <a href="../releasenotes.html" title="Release notes">Release notes</a>
            </li>
          </ul>
                       <h5>Modules</h5>
                  <ul>
                  <li class="none">
                          <a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a>
            </li>
                  <li class="none">
                          <a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-deploy/index.html" title="PL/Java Deploy">PL/Java Deploy</a>
            </li>
                  <li class="none">
                          <a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a>
            </li>
                  <li class="none">
                          <a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a>
            </li>
                  <li class="none">
                          <a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>XML view of non-XML data</h1>
<p>Because Java has a rich ecosystem of APIs and tools for XML processing, and JDBC supports those directly with the <a href="sqlxml.html">SQLXML data type</a>, it may be useful to offer XML &#x201c;views&#x201d; of other PostgreSQL data types that are not XML, but are similarly tree-structured.</p>
<p>A preview of such a feature is included in this release, allowing values of PostgreSQL&#x2019;s <tt>pg_node_tree</tt> type to be retrieved as if they were XML.</p>
<div class="section">
<h2><a name="pg_node_tree"></a><tt>pg_node_tree</tt></h2>
<p>The <tt>pg_node_tree</tt> type is a representation of PostgreSQL internal data structures, serialized to a text form found in various places in the system catalogs: default expressions for attributes, types, or function parameters, constraint and index expressions, trigger and policy qualifiers, rewrite rule actions, and so on.</p>
<p>To make full use of the information in a <tt>pg_node_tree</tt> would require access to all of the PostgreSQL native structure definitions used in it (which could become feasible in a future PostgreSQL version if some <a class="externalLink" href="https://www.postgresql.org/message-id/20190828234136.fk2ndqtld3onfrrp%40alap3.anarazel.de">current work-in-progress</a> is completed and released). On the other hand, depending on need, some partial information may be usefully extracted from a <tt>pg_node_tree</tt> using a simple syntactic transformation and standard tools for XML querying.</p>
<p>For an example of the current <tt>pg_node_tree</tt> syntax, here is the <tt>yes_or_no_check</tt> constraint in PostgreSQL 12 (on a little-endian machine):</p>

<div class="source">
<div class="source">
<pre>SELECT conbin FROM pg_constraint WHERE conname = 'yes_or_no_check';

{SCALARARRAYOPEXPR :opno 98 :opfuncid 67 :useOr true :inputcollid 100
:args ({RELABELTYPE :arg {COERCETODOMAINVALUE :typeId 1043 :typeMod 7
:collation 100 :location 133} :resulttype 25 :resulttypmod -1
:resultcollid 100 :relabelformat 2 :location -1} {ARRAYCOERCEEXPR
:arg {ARRAY :array_typeid 1015 :array_collid 100 :element_typeid 1043
:elements ({CONST :consttype 1043 :consttypmod -1 :constcollid 100
:constlen -1 :constbyval false :constisnull false :location 143
:constvalue 7 [ 28 0 0 0 89 69 83 ]} {CONST :consttype 1043 :consttypmod -1
:constcollid 100 :constlen -1 :constbyval false :constisnull false :location 150
:constvalue 6 [ 24 0 0 0 78 79 ]}) :multidims false :location -1}
:elemexpr {RELABELTYPE :arg {CASETESTEXPR :typeId 1043 :typeMod -1 :collation 0}
:resulttype 25 :resulttypmod -1 :resultcollid 100 :relabelformat 2 :location -1}
:resulttype 1009 :resulttypmod -1 :resultcollid 100 :coerceformat 2 :location -1
}) :location 139}
</pre></div></div>
<p>A Java function receiving a <tt>pg_node_tree</tt> as an argument could be declared this way:</p>

<div class="source">
<div class="source">
<pre>@Function
public static void pgNodeTreeAsXML(@SQLType(&quot;pg_node_tree&quot;) SQLXML pgt)
{
    ...
</pre></div></div>
<p>A parameter with the Java type <tt>SQLXML</tt> would normally lead to a parameter type of <tt>xml</tt> in the generated SQL function declaration, but here the <tt>@SQLType</tt> annotation is used to change that, declaring a function that accepts a <tt>pg_node_tree</tt> in SQL, but presents it to Java as the <tt>SQLXML</tt> type.</p>
<p>The <a href="../examples/examples.html"><tt>pljava-examples</tt> jar</a> includes just such a function, only declared to return <tt>xml</tt> rather than <tt>void</tt>. In fact, it returns its argument untouched, so it can be treated as XML by the surrounding query. Its full implementation is:</p>

<div class="source">
<div class="source">
<pre>@Function
public static SQLXML pgNodeTreeAsXML(@SQLType(&quot;pg_node_tree&quot;) SQLXML pgt)
throws SQLException
{
    return pgt;
}
</pre></div></div>
<p>Using that function (and the XQuery <a class="externalLink" href="https://www.w3.org/TR/xpath-functions-31/#func-serialize">serialize</a> function with the <tt>indent</tt> option for readability, courtesy of <a href="../examples/saxon.html#An_XMLTABLE-like_function">XQuery-based <tt>XMLTABLE</tt></a>), the same node tree can be viewed in a more familiar structured syntax:</p>

<div class="source">
<div class="source">
<pre>SELECT
    xmltable.*
  FROM
    pg_constraint,
    LATERAL (SELECT PgNodeTreeAsXML(conbin) AS &quot;.&quot;) AS p,
    &quot;xmltable&quot;('serialize(., map{&quot;indent&quot;:true()})',
      passing =&gt; p, columns =&gt; '{.}') AS (indented text)
  WHERE
    conname = 'yes_or_no_check';

&lt;SCALARARRAYOPEXPR&gt;
   &lt;member name=&quot;opno&quot;&gt;98&lt;/member&gt;
   &lt;member name=&quot;opfuncid&quot;&gt;67&lt;/member&gt;
   &lt;member name=&quot;useOr&quot;&gt;true&lt;/member&gt;
   &lt;member name=&quot;inputcollid&quot;&gt;100&lt;/member&gt;
   &lt;member name=&quot;args&quot;&gt;
      &lt;list&gt;
         &lt;RELABELTYPE&gt;
            &lt;member name=&quot;arg&quot;&gt;
               &lt;COERCETODOMAINVALUE&gt;
                  &lt;member name=&quot;typeId&quot;&gt;1043&lt;/member&gt;
                  &lt;member name=&quot;typeMod&quot;&gt;7&lt;/member&gt;
                  &lt;member name=&quot;collation&quot;&gt;100&lt;/member&gt;
                  &lt;member name=&quot;location&quot;&gt;133&lt;/member&gt;
               &lt;/COERCETODOMAINVALUE&gt;
            &lt;/member&gt;
            &lt;member name=&quot;resulttype&quot;&gt;25&lt;/member&gt;
            &lt;member name=&quot;resulttypmod&quot;&gt;-1&lt;/member&gt;
            &lt;member name=&quot;resultcollid&quot;&gt;100&lt;/member&gt;
            &lt;member name=&quot;relabelformat&quot;&gt;2&lt;/member&gt;
            &lt;member name=&quot;location&quot;&gt;-1&lt;/member&gt;
         &lt;/RELABELTYPE&gt;
         &lt;ARRAYCOERCEEXPR&gt;
            &lt;member name=&quot;arg&quot;&gt;
               &lt;ARRAY&gt;
                  &lt;member name=&quot;array_typeid&quot;&gt;1015&lt;/member&gt;
                  &lt;member name=&quot;array_collid&quot;&gt;100&lt;/member&gt;
                  &lt;member name=&quot;element_typeid&quot;&gt;1043&lt;/member&gt;
                  &lt;member name=&quot;elements&quot;&gt;
                     &lt;list&gt;
                        &lt;CONST&gt;
                           &lt;member name=&quot;consttype&quot;&gt;1043&lt;/member&gt;
                           &lt;member name=&quot;consttypmod&quot;&gt;-1&lt;/member&gt;
                           &lt;member name=&quot;constcollid&quot;&gt;100&lt;/member&gt;
                           &lt;member name=&quot;constlen&quot;&gt;-1&lt;/member&gt;
                           &lt;member name=&quot;constbyval&quot;&gt;false&lt;/member&gt;
                           &lt;member name=&quot;constisnull&quot;&gt;false&lt;/member&gt;
                           &lt;member name=&quot;location&quot;&gt;143&lt;/member&gt;
                           &lt;member name=&quot;constvalue&quot; length=&quot;7&quot;&gt;1C000000594553&lt;/member&gt;
                        &lt;/CONST&gt;
                        &lt;CONST&gt;
                           &lt;member name=&quot;consttype&quot;&gt;1043&lt;/member&gt;
                           &lt;member name=&quot;consttypmod&quot;&gt;-1&lt;/member&gt;
                           &lt;member name=&quot;constcollid&quot;&gt;100&lt;/member&gt;
                           &lt;member name=&quot;constlen&quot;&gt;-1&lt;/member&gt;
                           &lt;member name=&quot;constbyval&quot;&gt;false&lt;/member&gt;
                           &lt;member name=&quot;constisnull&quot;&gt;false&lt;/member&gt;
                           &lt;member name=&quot;location&quot;&gt;150&lt;/member&gt;
                           &lt;member name=&quot;constvalue&quot; length=&quot;6&quot;&gt;180000004E4F&lt;/member&gt;
                        &lt;/CONST&gt;
                     &lt;/list&gt;
                  &lt;/member&gt;
                  &lt;member name=&quot;multidims&quot;&gt;false&lt;/member&gt;
                  &lt;member name=&quot;location&quot;&gt;-1&lt;/member&gt;
               &lt;/ARRAY&gt;
            &lt;/member&gt;
            &lt;member name=&quot;elemexpr&quot;&gt;
               &lt;RELABELTYPE&gt;
                  &lt;member name=&quot;arg&quot;&gt;
                     &lt;CASETESTEXPR&gt;
                        &lt;member name=&quot;typeId&quot;&gt;1043&lt;/member&gt;
                        &lt;member name=&quot;typeMod&quot;&gt;-1&lt;/member&gt;
                        &lt;member name=&quot;collation&quot;&gt;0&lt;/member&gt;
                     &lt;/CASETESTEXPR&gt;
                  &lt;/member&gt;
                  &lt;member name=&quot;resulttype&quot;&gt;25&lt;/member&gt;
                  &lt;member name=&quot;resulttypmod&quot;&gt;-1&lt;/member&gt;
                  &lt;member name=&quot;resultcollid&quot;&gt;100&lt;/member&gt;
                  &lt;member name=&quot;relabelformat&quot;&gt;2&lt;/member&gt;
                  &lt;member name=&quot;location&quot;&gt;-1&lt;/member&gt;
               &lt;/RELABELTYPE&gt;
            &lt;/member&gt;
            &lt;member name=&quot;resulttype&quot;&gt;1009&lt;/member&gt;
            &lt;member name=&quot;resulttypmod&quot;&gt;-1&lt;/member&gt;
            &lt;member name=&quot;resultcollid&quot;&gt;100&lt;/member&gt;
            &lt;member name=&quot;coerceformat&quot;&gt;2&lt;/member&gt;
            &lt;member name=&quot;location&quot;&gt;-1&lt;/member&gt;
         &lt;/ARRAYCOERCEEXPR&gt;
      &lt;/list&gt;
   &lt;/member&gt;
   &lt;member name=&quot;location&quot;&gt;139&lt;/member&gt;
&lt;/SCALARARRAYOPEXPR&gt;
</pre></div></div>
<p>Although exact interpretation of all that isn&#x2019;t possible without heavy reference to the PostgreSQL source, it can be eyeballed for a decent idea of what is going on, and simple queries could extract useful information for some purposes. For example, this simple XPath would return the <tt>Oid</tt>s of all types that are used in constants within the expression:</p>

<div class="source">
<div class="source">
<pre>number(//CONST/member[@name = 'consttype'])
</pre></div></div>
<div class="section">
<h3><a name="Some_details_of_the_mapping"></a>Some details of the mapping</h3>

<ul>
  
<li>A <tt>&lt;list&gt;</tt> either has no attribute, and children that are, recursively, <tt>pg_node_tree</tt> structures, or it has an <tt>all</tt> attribute with value <tt>int</tt>, <tt>oid</tt>, or <tt>bit</tt> and its children all are <tt>&lt;v&gt;</tt> elements with numeric content representing integers, <tt>Oid</tt>s, or bit numbers in a bit set, respectively.</li>
  
<li>A <tt>&lt;CONST&gt;</tt> representing a typed SQL <tt>NULL</tt> will have a <tt>constvalue</tt> member with no <tt>length</tt> attribute and no content. Otherwise, the <tt>constvalue</tt> member will have content of type <tt>xs:hexBinary</tt> and a <tt>length</tt> attribute indicating how many octets of the binary content are used. For types with <tt>constbyval</tt> true, the hex content will always be the full width of a <tt>Datum</tt>, though the <tt>length</tt> may be smaller. For types with <tt>constbyval</tt> false, the <tt>length</tt> attribute matches the length of the binary content.</li>
  
<li>A <tt>&lt;CONST&gt;</tt> with a <tt>constlen</tt> of <tt>-1</tt> represents a type with a <tt>varlena</tt> representation, as described under <a class="externalLink" href="https://www.postgresql.org/docs/9.4/storage-toast.html">Database Physical Storage</a>. The <tt>constvalue</tt> in such a case is the entire <tt>varlena</tt>, including its header.</li>
</ul>
<p>The two <tt>&lt;CONST&gt;</tt> elements in the example above have type 1043 (<tt>CHARACTER VARYING</tt>) and <tt>varlena</tt> representations, so the <tt>constvalue</tt> members consist of a four-octet header followed by the three ASCII characters <tt>YES</tt> or the two characters <tt>NO</tt>, respectively. The one-octet length difference changes the <tt>varlena</tt> header value by four (from <tt>18</tt> to <tt>1C</tt>) because the two lowest-order bits of the header (on little-endian hardware) are usurped for TOAST.</p>
<p>It is <a class="externalLink" href="https://www.postgresql.org/message-id/20190921091527.GI31596%40fetter.org">possible</a> that a future PostgreSQL version will change the current idiosyncratic syntax, or serialize to JSON instead.</p></div></div>
<div class="section">
<h2><a name="Limits_of_the_current_XML_view_implementation"></a>Limits of the current XML view implementation</h2>
<p>Implementation of XML views is work in progress. The current implementation has these limitations:</p>

<ul>
  
<li>It is read-only. There is no provision yet for writing an XML-viewable type by returning <tt>SQLXML</tt> from a Java function, or passing <tt>SQLXML</tt> to a <tt>ResultSet</tt>, <tt>PreparedStatement</tt>, or <tt>SQLOutput</tt>.</li>
  
<li>A fully-compliant readable <tt>SQLXML</tt> implementation should support <tt>getBinaryStream</tt>, <tt>getCharacterStream</tt>, <tt>getString</tt>, and <tt>getSource</tt> with any of the four must-support subtypes of <tt>Source</tt>. The current XML-view implementation will support only <tt>getSource(SAXSource.class)</tt> or <tt>getSource(null)</tt> (which will return a <tt>SAXSource</tt>). All other cases will throw an <tt>SQLFeatureNotSupportedException</tt>.</li>
</ul></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2003&#x2013;2019
                        <a href="http://tada.se/eng/">Tada AB</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
